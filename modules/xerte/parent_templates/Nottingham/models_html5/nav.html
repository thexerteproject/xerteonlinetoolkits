<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

	// pageChanged & sizeChanged functions are needed in every model file
	// other functions for model should also be in here to avoid conflicts
	var nav = new function() {
		
		// Called from xenith if tab level deep linking is available
		this.deepLink = function(item) {
			if (x_currentPageXML.getAttribute("type") != "Col") {
				if (x_currentPageXML.getAttribute("type") == "Slide") {
					if ($.isNumeric(item)) {
						nav.slideshowChange(parseInt(item, 10));
					} else {
						$(x_currentPageXML).children().each(function(i) {
							if (item.toLowerCase() === this.getAttribute("name").toLowerCase()) {
								nav.slideshowChange(i);
								return false;
							}
						});
					}
				} else {
					const $btns = x_currentPageXML.getAttribute("type") == "Button" ? $('.navChildTitle') : $('.navChildTitle a');
					if ($.isNumeric(item) && $btns.eq(parseInt(item)).length > 0) {
						$btns.eq(parseInt(item)).click();
					} else {
						$btns.each(function(i) {
							if (item.toLowerCase() === $(this).text().toLowerCase()) {
								$(this).click();
								return false;
							}
						});
					}
				}
			}
		}
		
		// function called every time the size of the LO is changed
		this.sizeChanged = function() {
			// only need to do some resizing if not column page & panel fills the available space (rather than fits content)
			if (x_currentPageXML.getAttribute("type") != "Col") {
				if ($("#pageContents").hasClass("fill")) {
					if (x_currentPageXML.getAttribute("type") == "Acc") {
						// accordion
						if ($(".splitScreen_B").css("flex-basis") !== "100%") {
							// navigator isn't full width so ensure the panel is full height when needed
							$("#infoHolder").accordion({heightStyle: "fill"})
							$("#navHolder .panelContent").height(x_getAvailableHeight([$("#navHolder"), $(".panelContent"), $("#infoHolder")], [1]));
						} else {
							// navigator is full width so panel height is auto (fits content)
							$("#infoHolder").accordion({heightStyle: "content"});
							$("#navHolder .panelContent, #infoHolder .navChild").height("unset");
                        }

						// need to refresh accordion widget to ensure size & animations are still correct
						$("#infoHolder").accordion("refresh");

					} else if (x_currentPageXML.getAttribute("type") == "Tab") {
						// tabs
						if ($(".splitScreen_B").css("flex-basis") !== "100%") {
							// navigator isn't full width so ensure the panel is full height when needed
							const $infoHolder = $("#infoHolder");
							const $paneHolder = $("#paneHolder");
							$infoHolder.height(x_getAvailableHeight([$infoHolder]))
							$paneHolder.find(".navChild").height(x_getAvailableHeight([$infoHolder, $paneHolder.find(".navChild")], [$("#tabHolder")]));
						} else {
							// navigator is full width so panel height is auto (fits content)
							$("#infoHolder, #paneHolder .navChild").height("unset");
						}

					} else { // slideshow & buttons
						if ($(".splitScreen_B").css("flex-basis") !== "100%") {
							// navigator isn't full width so ensure the panel is full height when needed
							const $panel = $("#navHolder .panelContent").length > 0 ? $("#navHolder .panelContent") : $("#pageContents > div.panelContent");
							$("#infoHolder").height(x_getAvailableHeight([$("#infoHolder"), $panel], [$("#btnHolder")]));
						} else {
							// navigator is full width so panel height is auto
							$("#infoHolder").height("unset");
						}
					}
				}
			}
			
			this.resizeMedia();
		}
		
		// function resizes media controls
		this.resizeMedia = function() {
			// work out the maximum height for a piece of media
			function getMaxH($media) {
				let maxH;
				if (x_currentPageXML.getAttribute("type") !== "Col") {
					if ($("#pageContents").hasClass("fit") || $(".splitScreen_B").css("flex-basis") === "100%") {
						// navigator isn't a fixed height so make sure media is shown as large as possible (but not too large)
						maxH = x_currentPageXML.getAttribute("type") == "Acc" ? x_getAvailableHeight([$("#infoHolder"), $media.parents(".navChild")], []) :
								x_currentPageXML.getAttribute("type") == "Tab" ? x_getAvailableHeight([$("#infoHolder"), $media.parents(".navChild")], [$("#tabHolder")]) :
								x_currentPageXML.getAttribute("type") == "Button" ? x_getAvailableHeight([$("#navHolder"), $("#panelContent"), $("#infoHolder")], [$("#btnHolder")]) :
								x_getAvailableHeight([$("#navHolder"), $("#panelContent"), $("#infoHolder")]); // slideshow
					} else {
						maxH = x_currentPageXML.getAttribute("type") == "Acc" || x_currentPageXML.getAttribute("type") == "Tab" ? $media.parents(".navChild").height() :
								$media.parents("#infoHolder").height(); // slideshow or buttons
					}

				} else { // columns
					maxH = x_getAvailableHeight();
				}
				return maxH;
			}

			// resize images
			$(".paneImg").each(function() {
				const $this = $(this);
				$this.hide();
				const maxW = "100%";
				const maxH = getMaxH($this);

				$this
					.css({
						"max-width": maxW,
						"max-height": maxH - ($this.outerHeight(true) - $this.height()) - ($this.parents("figure").length > 0 ? $this.parents("figure").find("figcaption").outerHeight(true) : 0)
					})
					.show();
			});

			// resize iframes
			$("iframe.navMedia").each(function() {
				const $this = $(this);
				$this.hide();
				const maxW = "100%";
				const maxH = getMaxH($this);

				$this
					.css({
						"max-width": maxW,
						"max-height": maxH
					})
					.show();
			});

			// resize video / audio if now the wrong size for its holder
			// done by manually triggering the window resize event (mediaelement.js listens to this event)
			$(".navChild:visible .navMedia.video, .navChild:visible .navMedia.audio").each(function(i) {
				const $holder = $(this).closest(".panelPage").length > 0 ? $(this).closest(".panelPage") : $(this).closest(".navChild");

				if ($(this).hasClass("audio")) {
					let audioBarW = 0;
					$(this).find(".mejs-inner").find(".mejs-controls").children().each(function() {
						audioBarW += $(this).outerWidth();
					});
					$(this).hide();

					if (audioBarW > $holder.width() + 1 || audioBarW < $holder.width() - 50) {
						$(this).show();
						$x_window.resize();
						return false;
					} else {
						$(this).show();
					}

				} else { // video
					const $this = $(this);
					const $video = $this.find('video');
					const $videoDiv = $this.find('.mejs-video');
					const videoW = $videoDiv.width();
					$(this).hide();

					if (videoW > $holder.width() - 1 || (videoW < $holder.width() - 50 && ($video.data('width') == 0 || videoW < $video.data('width')))) {
						$this.css("max-width", $holder.width() - 10);
						$this.show();
						$x_window.resize();
						return false;
					} else {
						$(this).show();
					}
				}
			});
		}

		// Loads popcorn, then calls setup.
		this.init = function() 
		{
			const popLocation = "common_html5/js/popcorn/"
			const scriptsToLoad = ["popcorn-complete", "plugins/popcorn.mediaconstructor"];
			let i = 0;
			if (!xot_offline) {
				scriptsToLoad.forEach(function (file) {
					$.getScript(x_templateLocation + popLocation + file + ".js")
							.done(function () {
								if (++i >= scriptsToLoad.length)
									nav.setUp();
							})
							.fail(function (jqxhr, settings, exception) {
								console.log("Failed to load plugin:" + exception);
							});
				});
			}
			else {
				nav.setUp();
			}
		}
		
		this.setUp = function() {
			const $pageContents = $('#pageContents');
			const $textHolder = $('#textHolder');
			const $navHolder = $('#navHolder');
			
			$pageContents.addClass(x_currentPageXML.getAttribute("type").toLowerCase());
			
			// set up basic structure of page - different for each navigator type
			if (x_currentPageXML.getAttribute("type") != "Col") {

				$textHolder.html(x_addLineBreaks(x_currentPageXML.getAttribute("text")));

				$("#textHolder").addClass("splitScreen_A");
				$("#navHolder").addClass("splitScreen_B");
				const $navHolderInner = $('<div class="panelContent panel"/>').appendTo($navHolder);

				// navigator height might fit contents of pane or fill available height
				// this is decided by panelHeight property but if viewed on mobile or there's text above or below navigator then the property is overridden and will fit content instead
				let panelH = x_currentPageXML.getAttribute("panelHeight") === "fit" || x_browserInfo.mobile === true ? "fit" : "fill";
				if (panelH === "fill" && ((x_addLineBreaks(x_currentPageXML.getAttribute("textTop")) != undefined && x_addLineBreaks(x_currentPageXML.getAttribute("textTop")).trim() !== "") || (x_addLineBreaks(x_currentPageXML.getAttribute("textBottom")) != undefined && x_addLineBreaks(x_currentPageXML.getAttribute("textBottom")).trim() !== "") || (x_currentPageXML.getAttribute("panelWidth") === "Full" && x_currentPageXML.getAttribute("removeTxt") === "false"))) {
					panelH = "fit";
				}
				$pageContents.addClass(panelH);

				const attributes = {
					panelPosition: x_currentPageXML.getAttribute("panelPos"), // xml property is panelPos not align that is used in most page models
					panelStyle: x_currentPageXML.getAttribute("type") !== "Acc" && x_currentPageXML.getAttribute("type") !== "Tab" ? x_currentPageXML.getAttribute("panelStyle") : "true" // accordion & tabs don't have panel style
				}

				if (x_currentPageXML.getAttribute("panelWidth") === "Full") {
					attributes.fullH = true;
				}

				// set up split screen layout
				XENITH.SPLITSCREEN.init({"attributes": attributes});
				
				// set up all the html elements
				const $infoHolder = $('<div id="infoHolder"/>').appendTo($navHolderInner);
				
				if (x_currentPageXML.getAttribute("type") == "Slide") {
					$(x_currentPageXML).children().each(function(i) {
						$infoHolder.append('<div class="panelPage" aria-roledescription="' + x_getLangInfo(x_languageData.find("carousel")[0], "slide", "Slide") + '"><h3 class="navChildTitle" id="navChildTitle' + i + '"></h3><div id="navChild' + i + '" class="navChild"></div></div>');
					});
					
					const $btnHolder = $('<div id="btnHolder"><p id="slideTxt" aria-live="polite"></p><div id="btns"><button id="prevBtn">1</button><button id="nextBtn">2</button></div><div class="clearBoth"></div></div>');
					
					if (x_currentPageXML.getAttribute("buttonPos") != "Top") {
						$btnHolder.appendTo($navHolderInner);
					} else {
						$btnHolder
							.prependTo($navHolderInner)
							.addClass("top");
					}
					
				} else if (x_currentPageXML.getAttribute("type") == "Button") {
					// treat the button navigation as a tabbed navigator for accessibility
					// i.e. keyboard controls & info read to screen readers will be the same as those for tabbed navigator
					$navHolderInner.attr("role", "tablist");
					
					const $btnHolder = $('<div id="btnHolder"></div>');
					if (x_currentPageXML.getAttribute("buttonPos") != "Bottom") {
						$btnHolder.prependTo($navHolderInner);
					} else {
						$btnHolder
							.appendTo($navHolderInner)
							.addClass("bottom");
					}
					
					$(x_currentPageXML).children().each(function(i) {
						$btnHolder.append('<button id="navChildTitle' + i + '" class="navChildTitle" role="tab" aria-selected="false" aria-controls="navChild' + i + '" tabindex="-1"></button>');
						$infoHolder.append('<div id="navChild' + i + '" class="navChild" role="tabpanel" aria-labelledby="navChildTitle' + i + '"/>');
					});
					
				} else if (x_currentPageXML.getAttribute("type") == "Acc") {
					$(x_currentPageXML).children().each(function(i) {
						$infoHolder.append('<h3 class="navChildTitle"><a id="navChildTitle' + i + '" href="#" tabindex="-1"></a></h3> <div id="navChild' + i + '" class="navChild"></div>');
					});

				} else if (x_currentPageXML.getAttribute("type") == "Tab") {
					const $tabHolder = $('<ul id="tabHolder"/>').appendTo($infoHolder);
					const $paneHolder = $('<div id="paneHolder" />').appendTo($infoHolder);
					
					$(x_currentPageXML).children().each(function(i) {
						$tabHolder.append('<li class="navChildTitle"><a id="navChildTitle' + i + '" href="#navChild' + i + '"></a></li>');
						$paneHolder.append('<div id="navChild' + i + '" class="navChild" tabindex="0"/>');
					});
				}
				
			// column page
			} else {
				// add full width text above &/or below the columns
				if (x_currentPageXML.getAttribute("text") == "") {
					$textHolder.remove();
				} else {
					$textHolder.html(x_addLineBreaks(x_currentPageXML.getAttribute("text")));
				}

				if (x_currentPageXML.getAttribute("textTop") != undefined && x_currentPageXML.getAttribute("textTop").trim() != "") {
					$('<div class="textTopHolder">' + x_addLineBreaks(x_currentPageXML.getAttribute("textTop")) + '</div>').insertBefore($navHolder);
				}

				if (x_currentPageXML.getAttribute("textBottom") != undefined && x_currentPageXML.getAttribute("textBottom").trim() != "") {
					$('<div class="textBottomHolder">' + x_addLineBreaks(x_currentPageXML.getAttribute("textBottom")) + '</div>').insertAfter($navHolder);
				}
				
				// set up column contents
				$(x_currentPageXML).children().each(function(i) {
					$navHolder.append('<div id="navChild' + i + '" class="navChild column">' + (this.getAttribute("name").trim() != "" && x_currentPageXML.getAttribute("showTitles") !== "false" ? '<h3 id="navChildTitle' + i + '" class="navChildTitle"></h3>' : '') + '</div>');
				});

				// get the minimum width for the columns - columns will wrap onto a new row rather than be shown smaller than this
				const minWidth = x_currentPageXML.getAttribute("minWidth") != undefined ? x_currentPageXML.getAttribute("minWidth") : "75";

				// now work out if columns are equal width or whether width % have been set
				let equal = true;
				if (x_currentPageXML.getAttribute("columnWidth") != undefined && x_currentPageXML.getAttribute("columnWidth").trim() != "") {
					const columnWidths = x_currentPageXML.getAttribute("columnWidth").split("/");

					// check all widths are valid & they add up to 100% & they match the no. of columns
					let count = 0;
					let cssString = "";
					for (let i=0; i<columnWidths.length; i++) {
						if (columnWidths[i].trim() === "" || !$.isNumeric(columnWidths[i])) {
							columnWidths.splice(i,1);
							i--;
						} else {
							count += Number(columnWidths[i].trim());
							cssString += "minmax(" + minWidth + "px, " + columnWidths[i].trim() + "fr) ";
						}
					}

					// unequal widths
					if (count === 100 && columnWidths.length === $(".column").length) {
						equal = false;
						// without the media query, the columns will not wrap onto new lines when too narrow
						// unequal width percentages work until columns reach minimum width
						$("#pageContents").prepend(`<style>
						#navHolder {
							grid-template-columns: ${cssString};
						}

						@media (max-width: ${Number(minWidth)*columnWidths.length + (Math.ceil(parseFloat($navHolder.css("gap"))) * columnWidths.length-1)}px) {
							#navHolder {
								grid-template-columns: repeat(auto-fit, minmax(${minWidth}px, 1fr));
							}
						}
						</style>`);
					}
				}

				// equal widths - this is simpler, it will wrap to new lines when a column reaches minimum width
				if (equal === true) {
					$navHolder.css("grid-template-columns", "repeat(auto-fit, minmax(" + minWidth + "px, 1fr))");
				}

				// add a panel style if needed
				if (x_currentPageXML.getAttribute("columnPanelStyle") === "single") {
					$navHolder.addClass("panel");
				} else if (x_currentPageXML.getAttribute("columnPanelStyle") === "each") {
					$navHolder.find(".column").addClass("panel");
				}
			}
			
			// add content to each column/pane
			$(x_currentPageXML).children().each(function(i) {
				
				// column/pane text
				$("#navChildTitle" + i).html(this.getAttribute("name"));
				const $navChild = $("#navChild" + i).append(x_addLineBreaks(this.getAttribute("text")));
				
				// column/pane media
				if (this.getAttribute("url") != undefined && this.getAttribute("url") != "") {
					
					let $media;
					const fileExt = this.getAttribute("url").split('.').pop().toLowerCase();
					
					// audio
					if (fileExt === "mp3") {
						$media = $('<div id="navAudio"+i class="navMedia audio"></div>');
						
						$media.data({
							source: this.getAttribute("url"),
							title: this.getAttribute("tip") != undefined && this.getAttribute("tip") != "" ? this.getAttribute("tip") : '',
							transcript: this.getAttribute("transcript") != undefined && this.getAttribute("transcript") != "" ? this.getAttribute("transcript") : false
						});
						
					// image
					} else if (fileExt === "jpeg" || fileExt === "jpg" || fileExt === "png" || fileExt === "gif") {
						if (this.getAttribute("caption") != undefined && this.getAttribute("caption") != "") {
							$media = $('<figure class="navMedia"><img class="paneImg" src="' + this.getAttribute("url") + '" ' + (this.getAttribute("tip") != undefined && this.getAttribute("tip") != "" ? 'alt="' + this.getAttribute("tip") + '"' : '') + '/><figcaption>' + this.getAttribute("caption") + '</figcaption></figure>');
						} else {
							$media = $('<div class="navMedia"><img class="paneImg" src="' + this.getAttribute("url") + '" ' + (this.getAttribute("tip") != undefined && this.getAttribute("tip") != "" ? 'alt="' + this.getAttribute("tip") + '"' : '') + '/></div>');
						}
						
					// iframe
					} else if (this.getAttribute("url").substr(0,7) == "<iframe") {
						if ($(this.getAttribute("url")).first().is("[srcdoc]") == false) {
							$media = $(this.getAttribute("url")).first();
							$media
								.removeAttr('width')
								.addClass('navMedia');
						}
						
					// uploaded video / youtube / vimeo
					} else if (fileExt === "mp4" || x_isYouTubeVimeo(this.getAttribute("url")) != false) {
						$media = $('<div id="navMedia_' + i + '" class="navMedia video"></div>');
						
						$media.data({
							source: this.getAttribute("url"),
							title: this.getAttribute("tip") != undefined && this.getAttribute("tip") != "" ? this.getAttribute("tip") : ''
						});
						
						const yt = x_isYouTubeVimeo(this.getAttribute("url"));
						if (yt != false) {
							$media.addClass(yt);
						}
					}
					
					if ($media != "" && $media != undefined) {
						if (this.getAttribute("align") == "Bottom") {
							$media.appendTo($navChild);
						} else if ($navChild.find('.navChildTitle').length > 0) {
							$media.insertAfter($navChild.find('.navChildTitle'));
						} else {
							$media.prependTo($navChild);
						}

						if ($media.hasClass('video')) {
							this.popcornInstance = nav.loadMedia($media, "video", {
								tip: $media.data('title'),
								width: "100%",
								height: "100%",
								media: $media.data('source'),
								autoplay: false,
								pageName: "nav",
								trackMedia: true
							});
						} else if ($media.hasClass('audio')) {
							this.popcornInstance = loadMedia($media, "audio",
							{	
								tip: $media.data('title'),
								width: "100%",
								height: "100%",
								media: $media.data('source'),
								autoplay: false,
								pageName: "nav",
								trackMedia: false
							}, 	true);
							
							// manually add a transcript button to the end of the audio bar
							if ($media.data('transcript') !== false) {
								x_addAudioTranscript($media, $media.data('transcript'));
							}
						}
					}
				}
				
				// type specific stuff
				if (x_currentPageXML.getAttribute("type") == "Acc") {
					$("#navChildTitle" + i).parent('.navChildTitle').data("name", this.getAttribute("name"));
					
				} else if (x_currentPageXML.getAttribute("type") == "Tab") {
					$("#navChildTitle" + i).parent('.navChildTitle').attr("aria-hidden", "false");
				}
			});
			
			resizeEmbededMedia($(".popcornMedia.embed"), {width: "100%", height: "100%"});

			// set up interactions to change nested page
			if (x_currentPageXML.getAttribute("type") == "Acc") {
				const heightStyle = $pageContents.hasClass("fit") ? "content" : "fill";

				$("#infoHolder").accordion({
					icons: {
						header: "fa fa-x-acc-hide",
						activeHeader: "fa fa-x-acc-show"
					},
					collapsible: x_currentPageXML.getAttribute("collapsible") == "true" ? true : false,
					active: x_currentPageXML.getAttribute("collapsible") == "true" ? false : 0,
					heightStyle: heightStyle,
					activate: function(e, ui) {
						nav.resizeMedia();

						// if accordion is opened because of deep link, there may be more than one accordion heading that can be tabbed to - force tabindex on all other headings to be off
						if (ui.oldHeader.length == 0 && $("#infoHolder .navChildTitle[tabindex=0]").not(ui.newHeader).length > 0) {
							$("#infoHolder .navChildTitle[tabindex=0]").not(ui.newHeader).attr("tabindex", "-1")
						}

						// is there is a pane open?
						const newHeader = ui.newHeader[0];
						if (!newHeader) return;

						// is header is within visible area of container?
						const containerRect = $x_pageHolder[0].getBoundingClientRect();
						const headerRect = newHeader.getBoundingClientRect();
						const inView = x_browserInfo.mobile === true ? headerRect.top >= 0 && headerRect.bottom <= window.innerHeight : headerRect.top >= containerRect.top && headerRect.bottom <= containerRect.bottom;
						if (!inView) {
							newHeader.scrollIntoView({
								behavior: 'smooth',
								block: 'start',
								inline: 'nearest'
							});
						}

						// scroll old panel to top as it closes (this works better than scrolling new panel to top as it opens
						ui.oldPanel
							.data("height", ui.oldPanel.height())
							.css({ display: "block", height: "0px;" }) // it won't do scrollTop when display is none
							.scrollTop(0)
							.css({ display: "none", height: ui.oldPanel.data("height") });
					}
				});

				$("#infoHolder .navChildTitle").keydown(function(e) {
					const charCode = e.charCode || e.keyCode;
					if (charCode == 37 || charCode == 38) {
						// left/up arrow key - focus on previous button & select
						if ($(this).prevAll(".navChildTitle").length != 0) {
							$(this).prevAll(".navChildTitle").first().focus().click();
						} else {
							$(this).parent().find("h3:last-of-type").focus().click();
						}
					} else if (charCode == 39 || charCode == 40) {
						// right/down arrow key - focus on next button & select
						if ($(this).nextAll(".navChildTitle").length != 0) {
							$(this).nextAll(".navChildTitle").first().focus().click();
						} else {
							$(this).parent().find("h3:first-of-type").focus().click();
						}
					}
				})
				
			} else if (x_currentPageXML.getAttribute("type") == "Button") {
				$('.navChild').hide();
				
				$('.navChildTitle')
					.button()
					.attr("role", "tab")
					.on("click", function() {
						const $thisNavChild = $('#navChild' + $(this).index());
						if ($thisNavChild.is(":hidden")) {
							$("#btnHolder .navChildTitle:eq(" + $("#infoHolder .navChild:visible").index() + ")")
								.attr({
									"aria-selected": "false",
									"tabindex": "-1"
								})
								.removeClass("selected");

							$("#btnHolder .navChildTitle:eq(" + $thisNavChild.index() + ")")
								.attr({
									"aria-selected": "true",
									"tabindex": "0"
								})
								.addClass("selected");

							$('.navChild').hide();
							$thisNavChild.show();
							nav.resizeMedia();

							// make sure panel content & page are scrolled up (page might be scrolled down if buttons at bottom)
							$("#infoHolder").scrollTop(0);
							const containerRect = $x_pageHolder[0].getBoundingClientRect();
							const panelRect = $(".panelContent")[0].getBoundingClientRect();
							const inView = x_browserInfo.mobile === true ? panelRect.top >= 0 : panelRect.top >= containerRect.top;
							if (!inView) {
								$(".panelContent")[0].scrollIntoView({
									behavior: 'smooth',
									block: 'start',
									inline: 'nearest'
								});
							}
						}
					})
					.keydown(function (e) {
						const charCode = e.charCode || e.keyCode;
						if (charCode == 37 || charCode == 38) {
							// left/up arrow key - focus on previous button & select
							if ($(this).prev().length != 0) {
								$(this).prev().focus().click();
							} else {
								$(this).parent().find("button:last-of-type").focus().click();
							}
						} else if (charCode == 39 || charCode == 40) {
							// right/down arrow key - focus on next button & select
							if ($(this).next().length != 0) {
								$(this).next().focus().click();
							} else {
								$(this).parent().find("button:first-of-type").focus().click();
							}
						}
					});
				
				$('.navChildTitle:eq(0)').click();
				
			} else if (x_currentPageXML.getAttribute("type") == "Slide") {
				$('.panelPage').hide();
				
				$("#pageContents").data({
					"slideTxt": x_currentPageXML.getAttribute("slideCount") == undefined || x_currentPageXML.getAttribute("slideCount") == "" ? "Slide {i} of {n}" : x_currentPageXML.getAttribute("slideCount"),
					"totalPages": $("#infoHolder .panelPage").length,
					"currentPage": -1
				});
				
				$("#prevBtn")
					.button({
						icons: { primary: "fa fa-x-prev" },
						label: x_currentPageXML.getAttribute("prevBtnTip") == undefined || x_currentPageXML.getAttribute("prevBtnTip") == "" ? "Previous" : x_currentPageXML.getAttribute("prevBtnTip"),
						text: false
					})
					.click(function() {
						nav.slideshowChange($("#pageContents").data("currentPage") - 1);
					});
				
				$("#nextBtn")
					.button({
						icons: { primary: "fa fa-x-next" },
						label: x_currentPageXML.getAttribute("nextBtnTip") == undefined || x_currentPageXML.getAttribute("nextBtnTip") == "" ? "Next" : x_currentPageXML.getAttribute("nextBtnTip"),
						text: false
					})
					.click(function() {
						nav.slideshowChange($("#pageContents").data("currentPage") + 1);
					})
					.trigger("click");
				
				if ($("#pageContents").data("totalPages") < 2) {
					$("#btnHolder").remove();
				}
				
			} else if (x_currentPageXML.getAttribute("type") == "Tab") {
				$("#infoHolder").tabs({
					activate: function(e, ui) {
						nav.resizeMedia();
						$("#paneHolder").scrollTop(0);
						ui.newPanel.scrollTop(0);
					}
				});
			}
			
			this.sizeChanged();
			
			x_pageLoaded();
		}

		this.loadMedia = function($holder, type, data) {
			this.popcornInstance = loadMedia($holder, type, data);
		}
		
		this.slideshowChange = function(newPage) {
			const $pageContents = $("#pageContents");
			const $prevBtn = $("#prevBtn");
			const $nextBtn = $("#nextBtn");

			$pageContents.data("currentPage", newPage);

			// make sure panel content & page are scrolled up (page might be scrolled down if buttons at bottom)
			$("#infoHolder").scrollTop(0);
			const containerRect = $x_pageHolder[0].getBoundingClientRect();
			const panelRect = $(".panelContent")[0].getBoundingClientRect();
			const inView = x_browserInfo.mobile === true ? panelRect.top >= 0 : panelRect.top >= containerRect.top;
			if (!inView) {
				$(".panelContent")[0].scrollIntoView({
					behavior: 'smooth',
					block: 'start',
					inline: 'nearest'
				});
			}

			$("#infoHolder .panelPage:visible").hide();
			$("#infoHolder .panelPage:eq(" + newPage + ")").show();
			$("#slideTxt").html($pageContents.data("slideTxt").replace("{i}", newPage + 1).replace("{n}", $pageContents.data("totalPages")));
			
			if (newPage == 0) {
				$prevBtn.button("disable").removeClass("ui-state-focus").removeClass("ui-state-hover");
				$nextBtn.button("enable");
			} else if (newPage + 1 == $pageContents.data("totalPages")) {
				$prevBtn.button("enable");
				$nextBtn.button("disable").removeClass("ui-state-focus").removeClass("ui-state-hover");
			} else {
				$prevBtn.button("enable");
				$nextBtn.button("enable");
			}

			nav.resizeMedia();
		}
		
		this.mediaMetadata = function($video, wh) {
			$video.data({
				width: wh[0],
				height: wh[1]
			});
			
			$video.closest(".mejs-video").css({
				"maxWidth": wh[0],
				"maxHeight": wh[1]
			});
			
			this.sizeChanged();
		}

		this.leavePage = function () {
			document.dispatchEvent(new Event('leavepage'));
		}
	}
	
	nav.init();
	
</script>


<div id="pageContents">
	
	<div id="textHolder"></div>
	
	<div id="navHolder"></div>
	
</div>
