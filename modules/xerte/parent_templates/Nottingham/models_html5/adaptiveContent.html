<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


    String.prototype.replaceAll = function(search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
    };

    this.createDiagram = function(data, identifier, showall_only) {
        var importData = data;
        var numSubmits = importData.length;
        var latest_ts = "";
        var mean_all = [];
        var mean = [];
        var latest = null;
        var objlabel = null;
        var classnames = [];
        var classtitles = [];
        var numUserSubmits = 0;
        var textSize = 12;



        // We assume the data contains identical data sets
        // TODO: Check this
        if (numSubmits == 0) {
            return;
        }

        importData.forEach(function(obj)
        {
            if (objlabel == null) {
                objlabel = obj.graph.label;
            }

            for (var i = 0; i < obj.graph.classvalues.length; i++) {
                if (mean_all[i] == null) {
                    mean_all[i] = obj.graph.classvalues[i];
                }
                else {
                    mean_all[i] += obj.graph.classvalues[i];
                }

                if (classnames[i] == null) {
                    classnames[i] = obj.graph.classnames[i];
                }
                if (classtitles[i] == null) {
                    if (typeof obj.graph.classtitles != "undefined" && typeof obj.graph.classtitles[i] != "undefined" && obj.graph.classtitles[i] != "") {
                        classtitles[i] = obj.graph.classtitles[i];
                    }
                    else {
                        classtitles[i] = classnames[i];
                    }
                }
            }

            // Check what method is used for identification.
            var matchactor = false;
            switch (studentidmode) {
                case 0:
                case 2:
                    if (obj.actor.mbox == userEMail) {
                        matchactor = true;
                    }
                    break;
                case 1:
                    if (obj.actor.mbox_sha1sum == mboxsha1) {
                        matchactor = true;
                    }
                    break;
                case 3:
                    if (obj.actor.account.name == groupname) {
                        matchactor = true;
                    }
                    break;
            }

            if (matchactor) {
                if (obj.timestamp > latest_ts) {
                    latest_ts = obj.timestamp;
                    latest = obj;
                }

                for (var i = 0; i < obj.graph.classvalues.length; i++) {
                    if (mean[i] == null) {
                        mean[i] = obj.graph.classvalues[i];
                    }
                    else {
                        mean[i] += obj.graph.classvalues[i];
                    }
                }

                numUserSubmits++;
            }
        });

        for (var x = 0; x < mean_all.length; x++) {
            if (mean_all[x] != null) {
                mean_all[x] = mean_all[x] / numSubmits;
            }
            if (mean[x] != null) {
                mean[x] = mean[x] / numUserSubmits;
            }
        }

        function hexToRgb(hex, opa) {
            var bigint = parseInt(hex, 16);
            var r = (bigint >> 16) & 255;
            var g = (bigint >> 8) & 255;
            var b = bigint & 255;

            return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + opa + ')';
        }

        var ctx = $(identifier);
        var bgColourIn = "0xff0000";
        if (x_currentPageXML.getAttribute('colour') != null) {
            bgColourIn = x_currentPageXML.getAttribute('colour');
        }
        var bgColour = hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 0.5);
        var lnColour = hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 1);

        var pavgbgColourIn = "0x0000ff";
        if (x_currentPageXML.getAttribute('colourPersonalAvg') != null) {
            pavgbgColourIn = x_currentPageXML.getAttribute('colourPersonalAvg');
        }
        var pavgbgColour = hexToRgb(pavgbgColourIn.substr(pavgbgColourIn.length - 6), 0.5);
        var pavglnColour = hexToRgb(pavgbgColourIn.substr(pavgbgColourIn.length - 6), 1);

        var avgbgColourIn = "0x00ff00";
        if (x_currentPageXML.getAttribute('colourAvg') != null) {
            avgbgColourIn = x_currentPageXML.getAttribute('colourAvg');
        }
        var avgbgColour = hexToRgb(avgbgColourIn.substr(avgbgColourIn.length - 6), 0.5);
        var avglnColour = hexToRgb(avgbgColourIn.substr(avgbgColourIn.length - 6), 1);

        var avgAllLabelText = x_currentPageXML.getAttribute('AvgLabel');
        if (avgAllLabelText == undefined) {
            avgAllLabelText = 'Avg. of all attempts';
        }

        var personalLabelText = x_currentPageXML.getAttribute('PersonalLastLabel');
        if (personalLabelText == undefined) {
            personalLabelText = 'Your last attempt';
        }

        var personalAvgLabelText = x_currentPageXML.getAttribute('PersonalAvgLabel');
        if (personalAvgLabelText == undefined) {
            personalAvgLabelText = 'Avg. of your attempts';
        }

        var datasets = [];
        if (showall_only || latest == null) {
            // Only show mean_all
            datasets = [{
                label: avgAllLabelText,
                data: mean_all,
                backgroundColor: avgbgColour,
                borderColor: avglnColour
            }];
        }
        else {
            datasets = [
                {
                    label: personalLabelText,
                    data: latest.graph.classvalues,
                    backgroundColor: bgColour,
                    borderColor: lnColour
                }];
            if (numUserSubmits > 1) {
                datasets.push({
                    label: personalAvgLabelText,
                    data: mean,
                    backgroundColor: pavgbgColour,
                    borderColor: pavglnColour
                });
            }
            datasets.push({
                label: avgAllLabelText,
                data: mean_all,
                backgroundColor: avgbgColour,
                borderColor: avglnColour
            });
        }

        // Show mean_all and latest
        var myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: classtitles,
                datasets: datasets
            },
            options: {
                scale: {
                    ticks: {
                        suggestedMin: 0,
                        suggestedMax: 100,
                        fontSize: textSize - 10
                    },
                    pointLabels: {
                        fontSize: textSize
                    }
                },
                legend: {
                    labels: {
                        fontSize: textSize
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    };

    function hasToRetrieveAll(interaction) {
        var dashboardMode = x_currentPageXML.getAttribute('dashboardMode');
        if (dashboardMode == undefined)
        {
            dashboardMode = 'false';
        }
        if (dashboardMode == 'true')
        {
            return true;
        }
        else
        {
            if (interaction.getAttribute('interactionType') != 'open') {

                if (interaction.getAttribute('graph') == 'true') {
                    return (
                        interaction.getAttribute('graphType') == 'bar_answers' ||
                        interaction.getAttribute('graphType') == 'bar_marks' ||
                        interaction.getAttribute('graphType') == 'line_average_marks'
                    );
                }
                else {
                    return false;
                }
            }
            else {
                return true;
            }
        }
    }

    function escapeUrl(url, type, interactionIndex) {
        return (
            url.replace(/[^A-Za-z0-9]/g, "_") +
            '_'   +
            type  +
            '_'   +
            interactionIndex
        );
    }

    function matchActor(statement)
    {
        switch (studentidmode) {
            case 0:
            case 2:
                if (statement.actor.mbox == 'mailto:' + username) {
                    return true;
                }
                break;
            case 1:
                if (statement.actor.mbox_sha1sum == mboxsha1) {
                    return true;
                }
                break;
            case 3:
                if (statement.actor.account != undefined && statement.actor.account.name == groupname) {
                    return true;
                }
                break;
        }
        return false;
    }

    function filterOwnStatements(data) {
        var statements = [];
        for (var i = 0; i < data.length; i++)
        {
            statement = data[i];
            matchactor = false;
            switch (studentidmode) {
                case 0:
                case 2:
                    if (statement.actor.mbox == 'mailto:' + username) {
                        matchactor = true;
                    }
                    break;
                case 1:
                    if (statement.actor.mbox_sha1sum == mboxsha1) {
                        matchactor = true;
                    }
                    break;
                case 3:
                    if (statement.actor.account != undefined && statement.actor.account.name == groupname) {
                        matchactor = true;
                    }
                    break;
            }

            if (matchActor(data[i])) {

              statements.push(data[i]);
            }
        }
        return statements;
    }

    function queryStatements(endpoint, mode, query, interactionIndex, handler) {
        search = mode + '=' + JSON.stringify(query);

        var statements = [];
        url = endpoint + '?first=1000&' + search;
        requestJSON(url, function(data) {
            statements = data.edges.map(s => s.node.statement);
            requestMoreStatement(url, data, statements, interactionIndex, handler);
         });
    }

    function requestMoreStatement(endpoint, data, statements, interactionIndex, doneHandler) {
        if (data.pageInfo.hasNextPage) {
            requestJSON(endpoint + '&first=1000&after=' + data.pageInfo.endCursor, function(res) {
                statements = statements.concat(res.edges.map(s => s.node.statement));
                requestMoreStatement(endpoint, res, statements, interactionIndex, doneHandler);
            });
        }
        else {
            doneHandler(statements, interactionIndex);
        }
    }

    function requestJSON(url, handler) {
        $.ajax(
            {
                type: 'GET',
                url: url,
                success: handler,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(
                        'Authorization',
                        'Basic ' + toBase64(lrsUsername + ':' + lrsPassword)
                    );
                }
            }
        );
    }

    function verifyInteraction(interaction) {
        errors = [];
        if (interaction.getAttribute('interactionType') == 'score') {
            for (var ci = 0; ci < interaction.children.length; ci++) {
                c = interaction.children[ci];
                if (!c.hasAttribute('conScoreBetween')) {
                    errors.push('No score between given.');
                }
                else {
                    values = c.getAttribute('conScoreBetween').split(',');
                    if (values.length != 2) {
                        errors.push('Invalid pattern for score between.');
                    }
                }
            }
        }
        if (interaction.getAttribute('interactionType') == 'answer') {
            for (var ci = 0; ci < interaction.children.length; ci++) {
                c = interaction.children[ci];
                if (!c.hasAttribute('conScoreAnswer')) {
                    errors.push('No answer given.');
                }
            }
        }
        return errors;
    }

    function getStatements(
        xerteurl,
        xertelo,
        xertelabel,
        opinionClass,
        type,
        retrieveAll,
        interactionIndex,
        group,
        handler
    ) {


        var url = xerteurl + xertelo + '/' + xertelabel.replace(/ /g, "_");
        if (opinionClass != '' && opinionClass != null) {
            url += '/' + opinionClass.replace(/ /g, "_");
        }

        var startDate = x_currentPageXML.getAttribute("startDate");
        if (startDate == undefined)
        {
            startDate = "";
        }
        var endDate = x_currentPageXML.getAttribute("endDate");
        if (endDate == undefined)
        {
            endDate = "";
        }

        var q = {};
        if (!retrieveAll) {
            /*
            switch(studentidmode) {
                case 0:
                case 2:
                    q['statement.actor.mbox'] = 'mailto:' + username;
                    break;
                case 1:
                    q['statement.actor.mbox_sha1summbox'] = mboxsha1;
                    break;
                case 3:
                    q['statement.actor.objectType'] = 'Group';
                    q['statement.actor.account.name'] = groupname;
                    break;
            }
            */
            if (typeof actor != "undefined") {
                actor.account.homePage = xerteurl + xertelo;
                q['agent'] = JSON.stringify(actor);
            }
        }

        /*
        q['statement.object.id'] = url;
        q['statement.verb.id'] = 'http://adlnet.gov/expapi/verbs/scored';
         */
        q['activity'] = url;
        q['verb'] = 'http://adlnet.gov/expapi/verbs/scored';
        if (group != "")
        {
            q['group'] = group;
        }
        if (startDate != "")
        {
            var date = moment(startDate).toISOString();
            q['since'] = date;
        }
        if (endDate != "")
        {
            var date = moment(endDate).add(1, 'days').toISOString();
            q['until'] = date;
        }

        /*
        queryStatements(
            lrsEndpoint + '/api/connection/statement',
            'filter',
            q,
            interactionIndex,
            function(data, interactionIndex) {
                if (data.length > 0) {
                    url = data[0].object.id;
                    interaction = $(x_currentPageXML).children()[interactionIndex];
                    if (data.length >= 1 && filterOwnStatements(data).length >= 1) {
                        handler(data, interaction, url, type, interactionIndex);
                    }
                    else {
                        div = $(
                            '#' +
                            escapeUrl(url, type, interactionIndex)
                        );
                        div.append('No data found');
                    }
                }
            }
        );
        */
        XTGetStatements(q, false, function(data){
            if (data.length > 0)
            {
                url=data[0].object.id;
                interaction = $(x_currentPageXML).children()[interactionIndex];
                if (data.length >= 1 && (retrieveAll || filterOwnStatements(data).length >= 1)) {
                    handler(data, interaction, url, type, interactionIndex);
                }
                else {
                    div = $(
                        '#' +
                        escapeUrl(url, type, interactionIndex)
                    );
                    div.append('No data found');
                }
            }
        });
    }

    // pageChanged & sizeChanged functions are needed in every model file
    // other functions for model should also be in here to avoid conflicts.
    var adaptiveContent = new function() {
        var xerteurl = "";
        var xertelo = "";
        var xertelabel = "";
        var name = "";
        var interactionType = "";
        var opinionClass = "";
        var url = "";
        var divUrl = "";
        var group = "";
        var dashboardMode = 'false';

        this.loadJS = function() {
            if (numLoaded < 3) {
                var fileToLoad;
                if (numLoaded == 0) {
                    fileToLoad = x_templateLocation + 'common_html5/js/chart.min.js';
                }
                /*
                else if (numLoaded == 1) {
                    fileToLoad = 'common_html5/js/xapidashboard/dist/xapidashboard.min.js';
                }
                */
                else if (numLoaded == 1) {
                    fileToLoad = 'modules/xerte/xAPI/xapicollection.min.js';
                }
                else if (numLoaded == 2) {
                    fileToLoad = x_templateLocation + 'common_html5/js/moment-with-locales.min.js';
                }

                $.getScript(fileToLoad)
                    .done(function(script, textStatus) {
                        numLoaded++;
                        adaptiveContent.loadJS();
                    })
                    .fail(function( jqxhr, settings, exception ) {
                        console.log('Failed to load chart scripts');
                    });
            }
            else
            {
                // All files have loaded

                // Make sure config is correct
                /*
                var conf = {
                    "endpoint": lrsEndpoint + '/',
                    "user": lrsUsername,
                    "password": lrsPassword,
                    "strictCallbacks": true
                };

                ADL.XAPIWrapper.changeConfig(conf);
                ADL.XAPIWrapper.log.debug = true;
                */

                var displayMode = x_currentPageXML.getAttribute('displayMode');
                if(displayMode == "Listed"){
                    this.setUpListed();
                }else {
                    this.setUpUnlisted();
                }

            }

        };

        // Function called every time the page is viewed after it has initially loaded.
        this.pageChanged = function() {
        }

        // Function called every time the size of the LO is changed.
        this.sizeChanged = function() {
            var width = $x_pageHolder.width();
            var height = $x_pageHolder.height();
            if (width > height) {
                $('#diagram').width(height * 0.90);
                $('#diagram').height(height * 0.90);
                textSize = (width - height) / 10;
            }
            else {
                $('#diagram').width(width * 0.90);
                $('#diagram').height(width * 0.90);
                textSize = (height - width) / 10;
            }

            if (textSize > 20) {
                textSize = 20;
            }
            else if (textSize < 12) {
                textSize = 12;
            }
        }

        this.init = function() {
            debugger;
            var loadFiles = true;
            for (var i = 0; i < x_pageInfo.length; i++) {
                if (i != x_currentPage && x_pageInfo[i].type == x_pageInfo[x_currentPage].type && x_pageInfo[i].built != false) {
                    // a page of this type has already been loaded - don't reload popcorn files
                    loadFiles = false;
                    break;
                }
            }
            this.dashboardMode = x_currentPageXML.getAttribute('dashboardMode');
            if (this.dashboardMode == undefined)
            {
                this.dashboardMode = 'false';
            }
            if (loadFiles == true) {
                numLoaded = 0;
                this.loadJS();
            } else {
                var displayMode = x_currentPageXML.getAttribute('displayMode');
                if(displayMode == "Listed"){
                    this.setUpListed();
                }else {
                    this.setUpUnlisted();
                }
            }
        };



        this.drawBlock = function(location, interaction, interactionIndex, fullWidth)
        {
            xerteurl = interaction.getAttribute('xerteurl');
            xertelo = interaction.getAttribute('xertelo');
            xertelabel = interaction.getAttribute('label');
            name = interaction.getAttribute('name');
            interactionType = interaction.getAttribute('interactionType');
            opinionClass = interaction.getAttribute('opinionClass');
            if (interactionType == 'open' && xertelabel.indexOf('/') == -1)
            {
                xertelabel += '/' + xertelabel;
            }

            var scoreLabelText = x_currentPageXML.getAttribute('scoreText');
            if (scoreLabelText == undefined) {
                scoreLabelText = 'Your score is {0}';
            }

            var answerLabelText = x_currentPageXML.getAttribute('answerText');
            if (answerLabelText == undefined) {
                answerLabelText = 'Your answer is {0}';
            }

            url = xerteurl + xertelo + '/' + xertelabel;
            if (opinionClass != '' && opinionClass != null) {
                url += '/' + opinionClass;

            }
            var $this = this;
            divUrl = escapeUrl(url, interactionType, interactionIndex);
            name = interaction.getAttribute('name');
            var score = interaction.score;
            var div = $("<div>")
                .attr('id', divUrl)
                .attr('data-index', interactionIndex)
                .addClass("panel");

            div.html('<h2><p>' +
                name +
                "</p></h2><div class='introduction'>" +
                interaction.getAttribute('introduction') +
                "</div><div class='score'><div class='stats'></div><div class='graph-container'></div></div><div class='message'></div>");

            $(location).append(div);

            /*
            $('#adaptiveContent').append(
                "<div id='" + divUrl + "' data-index='" + interactionIndex + "'></div>",
            );

            $('#adaptiveContent #' + divUrl).append(
                '<h2>' +
                name +
                "</h2><div class='introduction'>" +
                interaction.getAttribute('introduction') +
                "</div><div class='score'></div><div class='message'></div>",
            );
            */

            if (interactionType == "score") {
                statements = getStatements(
                    xerteurl,
                    xertelo,
                    xertelabel,
                    opinionClass,
                    interactionType,
                    hasToRetrieveAll(interaction),
                    interactionIndex,
                    group,
                    function(data, interaction, url, type, interactionIndex) {
                        statements = filterOwnStatements(data);
                        xerteurl = interaction.getAttribute('xerteurl');
                        xertelo = interaction.getAttribute('xertelo');
                        xertelabel = interaction.getAttribute('label');
                        name = interaction.getAttribute('name');
                        interactionType = interaction.getAttribute('interactionType');
                        opinionClass = interaction.getAttribute('opinionClass');
                        var nrbars = interaction.getAttribute('graphNrDataPoints');
                        if (nrbars == undefined)
                        {
                            nrbars = 10;
                        }
                        if (statements.length > 0) {
                            score = statements[0].result.score.raw;
                            //score = interaction.score;
                            if (interaction.getAttribute("showScore") == "true") {
                                var txt = scoreLabelText;
                                txt = txt.replace(/\{0\}/, score);
                                $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').html('<p>' + txt + '%</p>');
                            }
                            for (blockIndex = 0; blockIndex < interaction.children.length; blockIndex++) {
                                block = interaction.children[blockIndex];
                                scoreRange = block.getAttribute('conScoreBetween');
                                range = scoreRange.split(",");
                                if (range.length == 2) {
                                    lowerBound = range[0];
                                    upperBound = range[1];
                                    if (score >= lowerBound && score <= upperBound) {
                                        $('#' + escapeUrl(url, type, interactionIndex) + ' .message').html(
                                            block.getAttribute('adaptiveContent')
                                        );
                                        break;
                                    }
                                }
                            }
                        }
                        if (interaction.getAttribute('graph') === 'true') {
                            var showExplanation = interaction.getAttribute('showExplanation');
                            var Explanation = interaction.getAttribute('graphExplanation');
                            var ExplanationPanelWidth = interaction.getAttribute("graphExplanationPanelWidth");
                            if (showExplanation == undefined)
                            {
                                showExplanation = 'false';
                            }
                            if (Explanation == undefined)
                            {
                                Explanation = "";
                            }
                            if (ExplanationPanelWidth == undefined)
                            {
                                ExplanationPanelWidth = "40%";
                            }
                            div = $('#' + escapeUrl(url, type, interactionIndex) + ' .score .graph-container');
                            div.append(
                                "<div class='graph'><svg id='" +
                                escapeUrl(url, type, interactionIndex) +
                                "-graph'></svg></div>"
                            );
                            if (showExplanation == 'true' && Explanation != "")
                            {
                                div.append("<div class=\"panel legend\" style=\"width: " + ExplanationPanelWidth + ";\">" + Explanation + "</div>");
                            }

                            if (interaction.getAttribute('graphType') == 'bar_answers') {
                                var dash = new ADL.XAPIDashboard();
                                dash.addStatements(data);
                                var chart = dash.createBarChart(
                                    {
                                        container: '#' + escapeUrl(
                                            url,
                                            type,
                                            interactionIndex
                                        ) + '-graph',
                                        groupBy: 'result.response',
                                        aggregate: ADL.count(),
                                        post: function (d) {
                                            d.contents.map(function (el) {
                                                el.out *= 1 / data.length * 100;
                                            });
                                        },
                                        customize: function (chart) {
                                            chart.xAxis.rotateLabels(45).axisLabel('Answers given');
                                            chart.yDomain([0, 100]);
                                            chart.yAxis.axisLabel('Number of answers');
                                            if(fullWidth){
                                                chart.width(700);
                                            }else{
                                                chart.width(300);
                                            }
                                            chart.height(300);
                                        }
                                    }
                                );
                                chart.draw();
                            }
                            else if (interaction.getAttribute('graphType') == 'bar_marks') {
                                var dash = new ADL.XAPIDashboard();
                                dash.addStatements(data);
                                data.map(function (x) {
                                    x.result.score.raw;
                                    return x;
                                });
                                var chart = dash.createBarChart(
                                    {
                                        container: '#' + escapeUrl(
                                            url,
                                            type,
                                            interactionIndex
                                        ) + '-graph',
                                        groupBy: 'result.score.raw',
                                        aggregate: ADL.count(),
                                        range: {start: 0.0, end: 100.0, increment: Math.ceil(100/nrbars)},
                                        post: function (d) {
                                            d.contents.map(function (el) {
                                                el.out *= 1 / data.length * 100;
                                            });
                                        },
                                        customize: function (chart) {
                                            chart.xAxis.rotateLabels(45).axisLabel("Score Range [%]");
                                            chart.yAxis.axisLabel("% of Group");
                                            if(fullWidth){
                                                chart.width(700);
                                            }else{
                                                chart.width(300);
                                            }
                                            chart.height(300);
                                            chart.yDomain([0, 100]);
                                        }

                                    }
                                );
                                chart.draw();
                            }
                            else if (interaction.getAttribute("graphType") == "line_average_marks") {
                                var dash = new ADL.XAPIDashboard();
                                dash.addStatements(data);
                                data.map(function (x) {
                                    x.result.score.raw;
                                    return x;
                                });

                                var chart = dash.createLineChart(
                                    {
                                        container: '#' + escapeUrl(
                                            url,
                                            type,
                                            interactionIndex
                                        ) + '-graph',
                                        groupBy: 'result.score.raw',
                                        aggregate: ADL.count(),
                                        range: {start: 0.0, end: 100.0, increment: Math.ceil(100/nrbars)},
                                        rangeLabel: 'start',
                                        post: function (d) {
                                            d.contents.map(function (el) {
                                                el.out *= 1 / data.length * 100;
                                            });
                                        },
                                        customize: function (chart) {
                                            chart.xAxis.rotateLabels(45).axisLabel('Score Range [%]');
                                            chart.yAxis.axisLabel('% of Group');
                                            if(fullWidth){
                                                chart.width(700);
                                            }else{
                                                chart.width(300);
                                            }
                                            chart.tooltips(false);
                                            chart.height(300);
                                            chart.yDomain([0, 100]);
                                        }

                                    }
                                );
                                chart.draw();
                            }
                            else if (interaction.getAttribute("graphType") == "line_own_marks") {
                                var dash = new ADL.XAPIDashboard();
                                data.map(function (x) {
                                    x.result.score.raw;
                                    return x;
                                });

                                dash.addStatements(statements);
                                end = new Date();
                                begin = end;
                                for (statement in statements) {
                                    if (begin.getTime() > new Date(statements[statement].timestamp).getTime()) {
                                        begin = new Date(statements[statement].timestamp);
                                    }
                                }

                                begin = new Date(begin.getTime() - 1 * 24 * 60 * 60 * 1000)
                                var chart = dash.createLineChart(
                                    {
                                        container: '#' + escapeUrl(
                                            url,
                                            type,
                                            interactionIndex
                                        ) + '-graph',
                                        groupBy: 'timestamp',
                                        range: {
                                            start: begin.toISOString(),
                                            end: end.toISOString(),
                                            increment: 1000 * 60 * 15
                                        },
                                        aggregate: ADL.average('result.score.raw'),
                                        rangeLabel: 'start',
                                        customize: function (chart) {
                                            if(fullWidth){
                                                chart.width(700);
                                            }else{
                                                chart.width(700);
                                            }
                                            chart.height(300);
                                            chart.tooltips(false);
                                            chart.yDomain([0, 10]);
                                            chart.xAxis.tickFormat(function (label) {
                                                return d3.time.format('%b %d')(new Date(label));
                                            });
                                        },
                                        post: function (data) {
                                            data.contents.map(function (el) {
                                                el.out = el.out / 10;
                                                el.in = Date.parse(el.in);
                                            });
                                        }
                                    }
                                );
                                chart.draw();
                            }
                        }
                    });
                }
                else if (interactionType == 'answer') {
                    statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        function(data, interaction, url, type, interactionIndex) {
                            var nrbars = interaction.getAttribute('graphNrDataPoints');
                            if (nrbars == undefined)
                            {
                                nrbars = 10;
                            }
                            statements = filterOwnStatements(data);
                            if (statements.length > 0) {
                                givenAnswer = statements[0].result.response;
                                if (interaction.getAttribute("showScore") == "true") {
                                    var txt = answerLabelText;
                                    txt = txt.replace(/\{0\}/, givenAnswer);
                                    $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').html('<p>' + txt + '</p>');
                                }
                                for (blockIndex = 0; blockIndex < interaction.children.length; blockIndex++) {
                                    block = interaction.children[blockIndex];
                                    conScoreAnswer = block.getAttribute('conScoreAnswer');
                                    if (conScoreAnswer == givenAnswer) {
                                        $('#' + escapeUrl(
                                            url,
                                            type,
                                            interactionIndex
                                        ) + ' .message').html(
                                            block.getAttribute('adaptiveContent')
                                        );

                                        break;
                                    }
                                }
                            }
                            if (interaction.getAttribute('graph') === 'true') {
                                var showExplanation = interaction.getAttribute('showExplanation');
                                var Explanation = interaction.getAttribute('graphExplanation');
                                var ExplanationPanelWidth = interaction.getAttribute("graphExplanationPanelWidth");
                                if (showExplanation == undefined)
                                {
                                    showExplanation = 'false';
                                }
                                if (Explanation == undefined)
                                {
                                    Explanation = "";
                                }
                                if (ExplanationPanelWidth == undefined)
                                {
                                    ExplanationPanelWidth = "40%";
                                }
                                div = $('#' + escapeUrl(
                                        url,
                                        type,
                                        interactionIndex
                                    ) + '.score .graph');

                                div.append(
                                    "<div class='x_floatLeft'><svg id='" +
                                    escapeUrl(url, type, interactionIndex) +
                                    "-graph'></svg></div>"
                                );
                                if (showExplanation == 'true' && Explanation != "")
                                {
                                    div.append("<div class=\"panel legend\" style=\"width: " + ExplanationPanelWidth + ";\" >" + Explanation + "</div>");
                                }
                                if (interaction.getAttribute('graphType') == 'bar_answers') {
                                    var dash = new ADL.XAPIDashboard();
                                    dash.addStatements(data);
                                    var chart = dash.createBarChart(
                                        {
                                            container: '#' + escapeUrl(
                                                url,
                                                type,
                                                interactionIndex
                                            ) + '-graph',
                                            groupBy: 'result.response',
                                            aggregate: ADL.count(),
                                            post: function (d) {
                                                d.contents.map(function (el) {
                                                    el.out *= 1 / data.length * 100;
                                                });
                                            },
                                            customize: function (chart) {
                                                chart.xAxis.rotateLabels(45).axisLabel('Answers given');
                                                chart.yDomain([0, 100]);
                                                chart.yAxis.axisLabel('Number of answers');
                                                chart.width(700);
                                                chart.height(300);
                                            }
                                        }
                                    );
                                    chart.draw();
                                }
                                else if (interaction.getAttribute('graphType') == 'bar_marks') {
                                    var dash = new ADL.XAPIDashboard();
                                    dash.addStatements(data);
                                    data.map(function (x) {
                                        x.result.score.raw;
                                        return x;
                                    });

                                    var chart = dash.createBarChart(
                                        {
                                            container: '#' + escapeUrl(
                                                url,
                                                type,
                                                interactionIndex
                                            ) + '-graph',
                                            groupBy: 'result.score.raw',
                                            aggregate: ADL.count(),
                                            range: {start: 0.0, end: 100.0, increment: Math.ceil(100/nrbars)},
                                            post: function (d) {
                                                d.contents.map(function (el) {
                                                    el.out *= 1 / data.length * 100;
                                                });
                                            },
                                            customize: function (chart) {
                                                chart.xAxis.rotateLabels(45).axisLabel('Score Range [%]');
                                                chart.yAxis.axisLabel('% of Group');
                                                chart.width(700);
                                                chart.height(300);
                                                chart.yDomain([0, 100]);
                                            }
                                        }
                                    );
                                    chart.draw();
                                }
                                else if (interaction.getAttribute('graphType') == 'line_average_marks') {
                                    var dash = new ADL.XAPIDashboard();
                                    dash.addStatements(data);
                                    data.map(function (x) {
                                        x.result.score.raw;
                                        return x;
                                    });

                                    var chart = dash.createLineChart(
                                        {
                                            container: '#' + escapeUrl(
                                                url,
                                                type,
                                                interactionIndex
                                            ) + '-graph',
                                            groupBy: 'result.score.raw',
                                            aggregate: ADL.count(),
                                            range: {start: 0.0, end: 100, increment: Math.ceil(100/nrbars)},
                                            rangeLabel: 'start',
                                            post: function (d) {
                                                d.contents.map(function (el) {
                                                    el.out *= 1 / data.length * 100;
                                                });
                                            },
                                            customize: function (chart) {
                                                chart.xAxis.rotateLabels(45).axisLabel('Score Range [%]');
                                                chart.yAxis.axisLabel('% of Group');
                                                chart.width(700);
                                                chart.tooltips(false);
                                                chart.height(300);
                                                chart.yDomain([0, 100]);
                                            }
                                        }
                                    );
                                    chart.draw();
                                }
                                else if (interaction.getAttribute('graphType') == 'line_own_marks') {
                                    var dash = new ADL.XAPIDashboard();
                                    data.map(function (x) {
                                        x.result.score.raw /= 10;
                                        return x;
                                    });

                                    dash.addStatements(statements);
                                    end = new Date();
                                    begin = end;
                                    for (statement in statements) {
                                        if (begin.getTime() > new Date(statements[statement].timestamp).getTime()) {
                                            begin = new Date(statements[statement].timestamp);
                                        }
                                    }

                                    begin = new Date(begin.getTime() - 1 * 24 * 60 * 60 * 1000)
                                    var chart = dash.createLineChart(
                                        {
                                            container: '#' + escapeUrl(
                                                url,
                                                type,
                                                interactionIndex
                                            ) + '-graph',
                                            groupBy: 'timestamp',
                                            range: {
                                                start: begin.toISOString(),
                                                end: end.toISOString(),
                                                increment: 1000 * 60 * 15
                                            },
                                            aggregate: ADL.average('result.score.raw'),
                                            rangeLabel: 'start',
                                            customize: function (chart) {
                                                chart.width(700);
                                                chart.height(300);
                                                chart.tooltips(false);
                                                chart.yDomain([0, 10]);
                                                chart.xAxis.tickFormat(function (label) {
                                                    return d3.time.format('%b %d')(new Date(label));
                                                });
                                            },
                                            post: function (data) {
                                                data.contents.map(function (el) {
                                                    el.in = Date.parse(el.in);
                                                });
                                            }
                                        }
                                    );
                                    chart.draw();
                                }
                            }

                });
            }
            else if (interactionType == 'opinion') {
                statements = getStatements(
                    xerteurl,
                    xertelo,
                    xertelabel,
                    opinionClass,
                    interactionType,
                    hasToRetrieveAll(interaction),
                    interactionIndex,
                    group,
                    function(data, interaction, url, type, interactionIndex) {
                        var showExplanation = interaction.getAttribute('showExplanation');
                        var Explanation = interaction.getAttribute('graphExplanation');
                        var ExplanationPanelWidth = interaction.getAttribute("graphExplanationPanelWidth");
                        if (showExplanation == undefined)
                        {
                            showExplanation = 'false';
                        }
                        if (Explanation == undefined)
                        {
                            Explanation = "";
                        }
                        if (ExplanationPanelWidth == undefined)
                        {
                            ExplanationPanelWidth = "40%";
                        }
                        jsonData = data.map(function(d) {
                            var obj = {}
                            obj.timestamp = d.timestamp;
                            obj.actor = d.actor;
                            obj.result = d.result;
                            if (d.result.extensions == undefined) {
                                return undefined;
                            }
                            obj.graph = JSON.parse(d.result.extensions["http://xerte.org.uk/xapi/JSONGraph"]);
                            return obj;
                        });
                        jsonData = jsonData.filter(x => x != undefined);
                        div = $('#' + escapeUrl(
                            url,
                            type,
                            interactionIndex
                        ) + ' .score .graph-container');

                        div.append(
                            "<fieldset class='noStyle'><canvas aria-live='polite'></canvas></fieldset>"
                        );
                        if (showExplanation == 'true' && Explanation != "")
                        {
                            div.append("<div class=\"panel legend\" style=\"width: " + ExplanationPanelWidth + ";\" >" + Explanation + "</div>");
                        }
                        var identifier = '#' + escapeUrl(
                            url,
                            type,
                            interactionIndex
                        ) + ' .score .graph-container canvas';
                        createDiagram(jsonData, identifier, $this.dashboardMode);
                    }
                );
            }
            else if (interactionType == "open")
            {
                debugger;
                // check open question special options
                var showUserID = 'false';
                var showDate = 'false';
                var sortOrder = 'false';
                if (interaction.getAttribute('showUserID') != undefined)
                {
                    showUserId = interaction.getAttribute('showUserID');
                }
                if (interaction.getAttribute('showDate') != undefined)
                {
                    showDate = interaction.getAttribute('showDate');
                }
                if (interaction.getAttribute('sortOrder') != undefined)
                {
                    sortOrder = interaction.getAttribute('sortOrder');
                }

                statements = getStatements(
                    xerteurl,
                    xertelo,
                    xertelabel,
                    opinionClass,
                    interactionType,
                    hasToRetrieveAll(interaction),
                    interactionIndex,
                    group,
                    function(data, interaction, url, type, interactionIndex) {
                        /*
                        statements = filterOwnStatements(data);
                        if (statements.length > 0) {
                            score = statements[0].result.score.raw;
                            if (interaction.getAttribute("showScore") == "true") {
                                var txt = scoreLabelText;
                                txt = txt.replace(/\{0\}/, score);
                                $('#' + escapeUrl(url, type, interactionIndex) + ' .score').html('<p>' + txt + '%</p>');
                            }
                        }

                         */
                        moment.locale(x_params.language);
                        var allAnswers= [];
                        var myAnswers = [];
                        for (var i=0; i<data.length; i++) {
                            var answer = {};
                            if (data[i].result != undefined && data[i].result.response != undefined && data[i].result.response != "") {
                                answer['answer'] = data[i].result.response;
                                var user;
                                if (typeof data[i].actor.name != 'undefined')
                                {
                                    user = data[i].actor.name;
                                }
                                else if (typeof data[i].actor.mbox != 'undefined')
                                {
                                    user = data[i].actor.mbox;
                                }
                                else if (typeof data[i].actor.mbox_sha1 != 'undefined') {
                                    user = data[i].actor.mbox_sha1;
                                }
                                else if (typeof data[i].actor.account != 'undefined' && typeof data[i].actor.account.name != 'undefined' ){
                                    user = data[i].actor.account.name;
                                }
                                else {
                                    user = "";
                                }
                                answer['user'] = user;
                                answer['date'] = moment(data[i].timestamp).format('L');

                            }
                            if (typeof answer['answer'] != "undefined") {
                                if (matchActor(data[i])) {
                                    myAnswers.push(answer);
                                    allAnswers.push(answer);
                                }
                                else {
                                    allAnswers.push(answer);

                                }
                            }
                        }
                        // Perhaps we want to do something with the number of answers
                        var nrMyAnswers = myAnswers.length;
                        var nrAnswers = allAnswers.length + nrMyAnswers;
                        var myOpenAnswerText = x_currentPageXML.getAttribute('myOpenAnswerText');
                        if (myOpenAnswerText == undefined)
                        {
                            myOpenAnswerText = "My answers";
                        }
                        var allOpenAnswerText = x_currentPageXML.getAttribute('allOpenAnswerText');
                        if (allOpenAnswerText == undefined)
                        {
                            allOpenAnswerText = "All answers";
                        }

                        var html = "";
                        if ($this.dashboardMode != 'true') {
                            if (nrMyAnswers > 0) {
                                if (sortOrder == 'increasing')
                                {
                                    // Reverse order
                                    var reverse = [];
                                    for(i=0; i<myAnswers.length; i++)
                                    {
                                        reverse[myAnswers.length-1-i] = myAnswers[i];
                                    }
                                    myAnswers = reverse;
                                }
                                html = "<h2><p>" + myOpenAnswerText + "</p></h2>";
                                html += "<table>";
                                for (i = 0; i < myAnswers.length; i++) {
                                    var itemnr = i+1;
                                    html += "<tr class='openanswer'>";
                                    html += "<td>" + itemnr + "</td>";
                                    if (showDate == 'true' && myAnswers[i]['date'] != "") {
                                        html += "<td>" + myAnswers[i]['date'] + "</td>";
                                    }
                                    if (showUserId == 'true' && myAnswers[i]['user'] != "") {
                                        html += "<td>" + myAnswers[i]['user'] + "</td>";
                                    }
                                    html += "<td>" + myAnswers[i]['answer'] + "</td>";
                                    html += "</tr>";
                                }
                                html += "</table>";
                            }
                        }
                        else {
                            if (allAnswers.length > 0) {
                                if (sortOrder == 'increasing')
                                {
                                    // Reverse order
                                    var reverse = [];
                                    for(i=0; i<allAnswers.length; i++)
                                    {
                                        reverse[allAnswers.length-1-i] = allAnswers[i];
                                    }
                                    allAnswers = reverse;
                                }
                                html += "<h2><p>" + allOpenAnswerText + "</p></h2>";
                                html += "<table>";
                                for (i = 0; i < allAnswers.length; i++) {
                                    var itemnr = i+1;
                                    html += "<tr class='openanswer'>";
                                    html += "<td>" + itemnr + "</td>";
                                    if (showDate == 'true' && allAnswers[i]['date'] != "") {
                                        html += "<td>" + allAnswers[i]['date'] + "</td>";
                                    }
                                    if (showUserId == 'true' && allAnswers[i]['user'] != "") {
                                        html += "<td>" + allAnswers[i]['user'] + "</td>";
                                    }
                                    html += "<td>" + allAnswers[i]['answer'] + "</td>";
                                    html += "</tr>";
                                }
                                html += "</table>";
                            }
                        }
                        $('#' + escapeUrl(url, type, interactionIndex) + ' .message').html(html);
                    });
            }

        }

        this.orderInteractions = function(interactions, handler){
            promises = [];
            allInteractions = interactions;
            for (var interactionIndex = 0; interactionIndex < interactions.length; interactionIndex++) {
                interaction = interactions[interactionIndex];
                errors = verifyInteraction(interaction);
                if (errors.length > 0){

                  $('#adaptiveContentMain').append("<div id='errors-"+ interactionIndex+ "'></div>");
                  errors.forEach(function(error){
                      $("#adaptiveContentMain #errors-" + interactionIndex).append(error);
                  });
                  continue;
                }
                xerteurl = interaction.getAttribute('xerteurl');
                xertelo = interaction.getAttribute('xertelo');
                xertelabel = interaction.getAttribute('label');
                name = interaction.getAttribute('name');
                interactionType = interaction.getAttribute('interactionType');
                opinionClass = interaction.getAttribute('opinionClass');
                if (opinionClass == undefined) {
                    opinionClass = '';
                }
                group = interaction.getAttribute('groupFromUrl');
                if (group == undefined) {
                    group = '';
                }
                else {
                    if (group == "true")
                    {
                        if (x_urlParams['group'] != undefined)
                        {
                            group = x_urlParams['group']
                        }
                        else
                        {
                            if (interaction.getAttribute('groupName') != undefined)
                            {
                                group = interaction.getAttribute('groupName');
                            }
                            else {
                                group = "";
                            }
                        }
                    }
                    else {
                        group = "";
                    }
                }
                promises.push(new Promise(function(resolve, reject){
                    getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        opinionClass,
                        interactionType,
                        false,
                        interactionIndex,
                        group,
                        function(data, interaction, url, type, interactionIndex) {
                            interactions[interactionIndex].data = data;
                            interactions[interactionIndex].score = Number.MAX_VALUE
                            if(data.length > 0)
                            {
                                interactions[interactionIndex].score = data[0].result.score.raw;
                            }
                            resolve();
                        }
                        );
                    }
                ));
                //wait until promises


            }
            Promise.all(promises, function(){
            }).then(function(){
                //debugger;
                interactions.sort(function(a, b){
                    if(a.score < b.score)
                    {
                        return -1;
                    }
                    if(a.score > b.score){
                        return 1;
                    }
                    return 0;
                });
                handler(interactions);
            });

        }

        this.setUpListed = function() {
            $("#adaptiveContentMain").append('<div class="splitScreen"><div class="left"></div><div class="right"></div></div>');
            $(".left").append('<div id="listPanel" class="panel qPanel">');
            $(".right").append('<div id="infoPanel" class="panel qPanel">');
            $("#listPanel").append('<div id="introductionText"></div><div id="adaptiveContent"></div>');
            $('#introductionText').html(x_currentPageXML.getAttribute('introduction'));
            $("#infoPanel").append("<h3>Current block</h3>");

            interactions = $(x_currentPageXML).children();
            $("#listPanel").append("<ul></ul>");
            var $this = this;
            this.orderInteractions(interactions, function(oInteractions){
                //debugger;
                interactions = oInteractions;
                for (var interactionIndex = 0; interactionIndex < oInteractions.length; interactionIndex++) {
                    interaction = oInteractions[interactionIndex];
                    errors = verifyInteraction(interaction);
                    if (errors.length > 0){

                      $('#adaptiveContent').append("<div id='errors-"+ interactionIndex+ "'></div>");
                      errors.forEach(function(error){
                          $("#adaptiveContent #errors-" + interactionIndex).append(error);
                      });
                      continue;
                    }
                    name = interaction.getAttribute('name');
                    div = $("<div></div>");
                    div.html('<h2><p>' +
                        name +
                        "</p></h2><div class='introduction'>" +
                        interaction.getAttribute('introduction') +
                        "</div><div class='score'></div><div class='message'></div>");

                    $("#listPanel ul").append("<li class='select-interaction' data-interaction-index='" + interactionIndex + "'>" + div.html() + "</li>");


                }
                $("#listPanel ul li").click(function(){
                    var index = $(this).data("interaction-index");
                    //debugger;
                    $("#infoPanel").html("");
                    $this.drawBlock("#infoPanel", oInteractions[index], index, false);
                })
                x_pageLoaded();
            });
        }

        this.setUpUnlisted = function()
        {
            $("#adaptiveContentMain").append('<div id="introductionText"></div><div id="adaptiveContent"></div>');
            $('#introductionText').html(x_currentPageXML.getAttribute('introduction'));
            interactions = $(x_currentPageXML).children();

            x_pageLoaded();

            for (var interactionIndex = 0; interactionIndex < interactions.length; interactionIndex++) {
                interaction = interactions[interactionIndex];
                errors = verifyInteraction(interaction);
                if (errors.length > 0){

                  $('#adaptiveContent').append("<div id='errors-"+ interactionIndex+ "'></div>");
                  errors.forEach(function(error){
                      $("#adaptiveContent #errors-" + interactionIndex).append(error);
                  });
                  continue;
                }
                xerteurl = interaction.getAttribute('xerteurl');
                xertelo = interaction.getAttribute('xertelo');
                xertelabel = interaction.getAttribute('label');
                name = interaction.getAttribute('name');
                interactionType = interaction.getAttribute('interactionType');
                opinionClass = interaction.getAttribute('opinionClass');
                if (opinionClass == undefined) {
                    opinionClass = '';
                }
                group = interaction.getAttribute('groupFromUrl');
                if (group == undefined) {
                    group = '';
                }
                else {
                    if (group == "true")
                    {
                        if (x_urlParams['group'] != undefined)
                        {
                            group = x_urlParams['group']
                        }
                        else
                        {
                            if (interaction.getAttribute('groupName') != undefined)
                            {
                                group = interaction.getAttribute('groupName');
                            }
                            else {
                                group = "";
                            }
                        }
                    }
                    else {
                        group = "";
                    }
                }


                url = xerteurl + xertelo + '/' + xertelabel;
                if (opinionClass != '') {
                    url += '/' + opinionClass;
                }
                this.drawBlock("#adaptiveContent", interaction, interactionIndex, true);


            }



            // Call this function in every model once everything's loaded.

        }
    };
    adaptiveContent.init();

</script>

<div id="adaptiveContentMain">

</div>

