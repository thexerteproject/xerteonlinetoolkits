<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


    String.prototype.replaceAll = function(search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
    };

    this.createDiagram = function(data, identifier, showall_only, interaction) {
        var importData = data;
        var numSubmits = importData.length;
        var latest_ts = "";
        var mean_all = [];
        var mean = [];
        var latest = null;
        var objlabel = null;
        var classnames = [];
        var classtitles = [];
        var numUserSubmits = 0;
        var xertelo = interaction.getAttribute('xertelo');
        var textSize = Math.round(interaction.getAttribute("labelFontSize"));

        if (textSize == null || textSize == 0) textSize = 12;

        // We assume the data contains identical data sets
        // TODO: Check this
        if (numSubmits == 0) {
            return;
        }

        if (showall_only === "true")
        {
            showall_only = true;
        }
        if (showall_only === "false")
        {
            showall_only = false;
        }
        importData.forEach(function(obj)
        {
            if (objlabel == null) {
                objlabel = obj.graph.label;
            }

            for (var i = 0; i < obj.graph.classvalues.length; i++) {
                if (mean_all[i] == null) {
                    mean_all[i] = obj.graph.classvalues[i];
                }
                else {
                    mean_all[i] += obj.graph.classvalues[i];
                }

                if (classnames[i] == null) {
                    classnames[i] = obj.graph.classnames[i];
                }
                if (classtitles[i] == null) {
                    if (typeof obj.graph.classtitles != "undefined" && typeof obj.graph.classtitles[i] != "undefined" && obj.graph.classtitles[i] != "") {
                        classtitles[i] = obj.graph.classtitles[i];
                    }
                    else {
                        classtitles[i] = classnames[i];
                    }
                }
            }

            // Check what method is used for identification.
            var matchactor = false;
            switch (studentidmode) {
                case 0:
                case 2:
                    if (obj.actor.mbox == userEMail) {
                        matchactor = true;
                    }
                    break;
                case 1:
                    if (obj.actor.mbox_sha1sum == mboxsha1) {
                        matchactor = true;
                    }
                    break;
                case 3:
                    if (obj.actor.account.name == groupname) {
                        matchactor = true;
                    }
                    break;
            }
            if (!matchactor && xertelo == x_TemplateId
                && obj.context != undefined
                && obj.context.extensions != undefined
                && obj.context.extension['http://xerte.org.uk/sessionId'] != undefined
                && obj.context.extension['http://xerte.org.uk/sessionId'] == state.sessionId)
            {
                matchactor = true;
            }

            if (matchactor) {
                if (obj.timestamp > latest_ts) {
                    latest_ts = obj.timestamp;
                    latest = obj;
                }

                for (var i = 0; i < obj.graph.classvalues.length; i++) {
                    if (mean[i] == null) {
                        mean[i] = obj.graph.classvalues[i];
                    }
                    else {
                        mean[i] += obj.graph.classvalues[i];
                    }
                }

                numUserSubmits++;
            }
        });

        for (var x = 0; x < mean_all.length; x++) {
            if (mean_all[x] != null) {
                mean_all[x] = Math.round(mean_all[x] * 10 / numSubmits)/ 10;
            }
            if (mean[x] != null) {
                mean[x] = Math.round(mean[x] * 10 / numUserSubmits) / 10;
            }
        }

        function hexToRgb(hex, opa) {
            var bigint = parseInt(hex, 16);
            var r = (bigint >> 16) & 255;
            var g = (bigint >> 8) & 255;
            var b = bigint & 255;

            return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + opa + ')';
        }

        var ctx = $(identifier);
        var bgColourIn = "0xff0000";
        if (interaction.getAttribute('colour') != null) {
            bgColourIn = interaction.getAttribute('colour');
        }
        var bgColour = hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 0.5);
        var lnColour = hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 1);

        var pavgbgColourIn = "0x0000ff";
        if (interaction.getAttribute('colourPersonalAvg') != null) {
            pavgbgColourIn = interaction.getAttribute('colourPersonalAvg');
        }
        var pavgbgColour = hexToRgb(pavgbgColourIn.substr(pavgbgColourIn.length - 6), 0.5);
        var pavglnColour = hexToRgb(pavgbgColourIn.substr(pavgbgColourIn.length - 6), 1);

        var avgbgColourIn = "0x00ff00";
        if (interaction.getAttribute('colourAvg') != null) {
            avgbgColourIn = interaction.getAttribute('colourAvg');
        }
        var avgbgColour = hexToRgb(avgbgColourIn.substr(avgbgColourIn.length - 6), 0.5);
        var avglnColour = hexToRgb(avgbgColourIn.substr(avgbgColourIn.length - 6), 1);

        var avgAllLabelText = interaction.getAttribute('AvgLabel');
        if (avgAllLabelText == undefined) {
            avgAllLabelText = 'Avg. of all attempts';
        }

        var personalLabelText = interaction.getAttribute('PersonalLastLabel');
        if (personalLabelText == undefined) {
            personalLabelText = 'Your last attempt';
        }

        var personalAvgLabelText = interaction.getAttribute('PersonalAvgLabel');
        if (personalAvgLabelText == undefined) {
            personalAvgLabelText = 'Avg. of your attempts';
        }

        var datasets = [];
        if (showall_only || latest == null) {
            // Only show mean_all
            datasets = [{
                label: avgAllLabelText,
                data: mean_all,
                backgroundColor: avgbgColour,
                borderColor: avglnColour
            }];
        }
        else {
            datasets = [
                {
                    label: personalLabelText,
                    data: latest.graph.classvalues,
                    backgroundColor: bgColour,
                    borderColor: lnColour
                }];
            if (numUserSubmits > 1) {
                datasets.push({
                    label: personalAvgLabelText,
                    data: mean,
                    backgroundColor: pavgbgColour,
                    borderColor: pavglnColour
                });
            }
            datasets.push({
                label: avgAllLabelText,
                data: mean_all,
                backgroundColor: avgbgColour,
                borderColor: avglnColour
            });
        }

        // Show mean_all and latest
        var myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: classtitles,
                datasets: datasets
            },
            options: {
                scale: {
                    ticks: {
                        suggestedMin: 0,
                        suggestedMax: 100,
                        fontSize: textSize - 10
                    },
                    pointLabels: {
                        fontSize: textSize
                    }
                },
                legend: {
                    labels: {
                        fontSize: textSize
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    };

    function hasToRetrieveAll(interaction) {
        var dashboardMode = x_currentPageXML.getAttribute('dashboardMode');
        if (dashboardMode == undefined)
        {
            dashboardMode = 'false';
        }
        if (dashboardMode == 'true')
        {
            return true;
        }
        else
        {
            if (interaction.getAttribute('interactionType') !== 'open' && interaction.getAttribute('interactionType') !== 'opinion' && interaction.getAttribute('opinionClass') != undefined ) {

                if (interaction.getAttribute('graph') === 'true') {
                    return (
                        interaction.getAttribute('graphType') === 'bar_answers' ||
                        interaction.getAttribute('graphType') === 'bar_marks' ||
                        interaction.getAttribute('graphType') === 'line_average_marks'
                    );
                }
                else {
                    return false;
                }
            }
            else {
                return true;
            }
        }
    }

    function escapeUrl(url, type, interactionIndex) {
        return (
            url.replace(/[^A-Za-z0-9]/g, "_") +
            '_'   +
            type  +
            '_'   +
            interactionIndex
        );
    }

    function matchActor(statement, xertelo)
    {
        switch (studentidmode) {
            case 0:
            case 2:
                if (statement.actor.mbox == 'mailto:' + username) {
                    return true;
                }
                break;
            case 1:
                if (statement.actor.mbox_sha1sum == mboxsha1) {
                    return true;
                }
                break;
            case 3:
                if (statement.actor.account != undefined && statement.actor.account.name == groupname) {
                    return true;
                }
                break;
        }
        if (xertelo != undefined && xertelo == x_TemplateId
            && obj.context != undefined
            && obj.context.extensions != undefined
            && obj.context.extension['http://xerte.org.uk/sessionId'] != undefined
            && obj.context.extension['http://xerte.org.uk/sessionId'] == state.sessionId)
        {
            return true;
        }
        return false;
    }

    function filterOwnStatements(data, xertelo) {
        var statements = [];
        for (var i = 0; i < data.length; i++)
        {
            if (matchActor(data[i], xertelo)) {

              statements.push(data[i]);
            }
        }
        return statements;
    }

    function queryStatements(endpoint, mode, query, interactionIndex, handler) {
        search = mode + '=' + JSON.stringify(query);

        var statements = [];
        url = endpoint + '?first=1000&' + search;
        requestJSON(url, function(data) {
            statements = data.edges.map(function(s) {return s.node.statement } );
            requestMoreStatement(url, data, statements, interactionIndex, handler);
         });
    }

    function requestMoreStatement(endpoint, data, statements, interactionIndex, doneHandler) {
        if (data.pageInfo.hasNextPage) {
            requestJSON(endpoint + '&first=1000&after=' + data.pageInfo.endCursor, function(res) {
                statements = statements.concat(res.edges.map(function(s) { return s.node.statement }));
                requestMoreStatement(endpoint, res, statements, interactionIndex, doneHandler);
            });
        }
        else {
            doneHandler(statements, interactionIndex);
        }
    }

    function requestJSON(url, handler) {
        $.ajax(
            {
                type: 'GET',
                url: url,
                success: handler,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(
                        'Authorization',
                        'Basic ' + toBase64(lrsUsername + ':' + lrsPassword)
                    );
                }
            }
        );
    }

    function verifyInteraction(interaction) {
        errors = [];
        if (interaction.getAttribute('interactionType') == 'score') {
            for (var ci = 0; ci < interaction.children.length; ci++) {
                c = interaction.children[ci];
                if (!c.hasAttribute('conScoreBetween')) {
                    errors.push('No score between given.');
                }
                else {
                    values = c.getAttribute('conScoreBetween').split(',');
                    if (values.length != 2) {
                        errors.push('Invalid pattern for score between.');
                    }
                }
            }
        }
        if (interaction.getAttribute('interactionType') == 'answer') {
            for (var ci = 0; ci < interaction.children.length; ci++) {
                c = interaction.children[ci];
                if (!c.hasAttribute('conScoreAnswer')) {
                    errors.push('No answer given.');
                }
            }
        }
        return errors;
    }

    function getUrl(xerteurl, xertelo, xertelabel, opinionClass)
    {
        var url = xerteurl + xertelo;
        if (xertelabel != undefined && xertelabel != '')
        {
            url += '/' + xertelabel.replace(/ /g, "_");
        }
        if (opinionClass != undefined && opinionClass != '' ) {
            url += '/' + opinionClass.replace(/ /g, "_");
        }
        return url;
    }

    function getGroupingLabel(statement)
    {
        // statements DO have context.contextActivities.grouping[0].id defined (see above)
        // Check context.contextActivities.grouping[0].definition.name['en-US']
        if (statement.context.contextActivities.grouping[0].definition != undefined
            && statement.context.contextActivities.grouping[0].definition.name != undefined
            && statement.context.contextActivities.grouping[0].definition.name['en-US'] != undefined)
        {
            return statement.context.contextActivities.grouping[0].definition.name['en-US'];
        }
        else
        {
            let id = statement.context.contextActivities.grouping[0].id;
            let pos = id.lastIndexOf('/');
            let group = id.substr(pos+1);
            return group.replace(/_/g, ' ');
        }
    }

    function getStatements(
        xerteurl,
        xertelo,
        xertelabel,
        verb,
        opinionClass,
        type,
        retrieveAll,
        interactionIndex,
        group,
        fullWidth,
        handler
    ) {

        var url;
        var q = {};
        if (type != "grouping") {
            url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
        }
        else
        {
            url = getUrl(xerteurl, xertelo);
             xertelabel = xertelabel.replace(/ /g, "_");
        }

        var startDate = x_currentPageXML.getAttribute("startDate");
        if (startDate == undefined)
        {
            startDate = "";
        }
        var endDate = x_currentPageXML.getAttribute("endDate");
        if (endDate == undefined)
        {
            endDate = "";
        }


        if (!retrieveAll) {
            /*
            switch(studentidmode) {
                case 0:
                case 2:
                    q['statement.actor.mbox'] = 'mailto:' + username;
                    break;
                case 1:
                    q['statement.actor.mbox_sha1summbox'] = mboxsha1;
                    break;
                case 3:
                    q['statement.actor.objectType'] = 'Group';
                    q['statement.actor.account.name'] = groupname;
                    break;
            }
            */
            if (typeof actor != "undefined") {
                //actor.account.homePage = xerteurl + xertelo;
                q['agent'] = JSON.stringify(actor);
            }
        }

        /*
        q['statement.object.id'] = url;
        q['statement.verb.id'] = 'http://adlnet.gov/expapi/verbs/scored';
         */
        q['activity'] = url;
        if (type == "grouping" || type == "groupings") {
            q['related_activities'] = true;
        }
        q['verb'] = verb;
        if (group != "")
        {
            q['group'] = group;
        }
        if (startDate != "")
        {
            var date = moment(startDate).toISOString();
            q['since'] = date;
        }
        if (endDate != "")
        {
            var date = moment(endDate).add(1, 'days').toISOString();
            q['until'] = date;
        }

        /*
        queryStatements(
            lrsEndpoint + '/api/connection/statement',
            'filter',
            q,
            interactionIndex,
            function(data, interactionIndex) {
                if (data.length > 0) {
                    url = data[0].object.id;
                    interaction = $(x_currentPageXML).children()[interactionIndex];
                    if (data.length >= 1 && filterOwnStatements(data).length >= 1) {
                        handler(data, interaction, url, type, interactionIndex);
                    }
                    else {
                        div = $(
                            '#' +
                            escapeUrl(url, type, interactionIndex)
                        );
                        div.append('No data found');
                    }
                }
            }
        );
        */
        XTGetStatements(q, false, function(data, search){
            if (data.length > 0) {
                if (search != undefined && typeof search['activity'] != 'undefined') {
                    url = search['activity'];
                } else {
                    url = data[0].object.id;
                }
                interaction = $(x_currentPageXML).children()[interactionIndex];
                if (data.length >= 1 && (retrieveAll || filterOwnStatements(data, xertelo).length >= 1)) {
                    if (opinionClass != undefined && opinionClass != "")
                    {
                        // Just filter out the items with the following structure
                        //"object": {
                        //"definition": {
                        //    "name": {
                        //        "en": "VR(class=Docent)"
                        //     }
                        //   }
                        //  }
                        var statements=[];
                        for (var i=0; i<data.length; i++)
                        {
                            if (data[i].object.definition != undefined
                                && data[i].object.definition.name != undefined
                                && data[i].object.definition.name.en != undefined
                                && data[i].object.definition.name.en.indexOf("(class=") != -1)
                            {
                                statements.push(data[i]);
                            }
                        }
                        handler(statements, interaction, url, type, interactionIndex, fullWidth);
                    }
                    else if (type == 'grouping')
                    {
                        // Filter out the itmes with the following structure
                        // Also interactive level should be interactivity
                        // context: {
                        //   contextActivities: {
                        //      grouping: [{
                        //          id: baseUrl() + this.grouping.replace(/[\/ ]/g, "_"),
                        //          objectType: "Activity"
                        //      }]
                        // }
                        var statements=[];
                        for (var i=0; i<data.length; i++)
                        {
                            if (data[i].context != undefined
                                && data[i].context.extensions != undefined
                                && data[i].context.extensions['http://xerte.org.uk/learningObjectLevel'] != undefined
                                && data[i].context.extensions['http://xerte.org.uk/learningObjectLevel'] == 'interactivity'
                                && data[i].context.contextActivities != undefined
                                && data[i].context.contextActivities.grouping != undefined
                                && data[i].context.contextActivities.grouping[0] != undefined
                                && data[i].context.contextActivities.grouping[0].id != undefined
                                && data[i].context.contextActivities.grouping[0].id.indexOf(xertelabel) != -1)
                            {
                                statements.push(data[i]);
                            }
                        }
                        handler(statements, interaction, url, type, interactionIndex, fullWidth);
                    }
                    else if (type == 'groupings')
                    {
                        var statements=[];
                        let groupingStatements=[];

                        for (var i=0; i<data.length; i++)
                        {
                            if (data[i].context != undefined
                                && data[i].context.extensions != undefined
                                && data[i].context.extensions['http://xerte.org.uk/learningObjectLevel'] != undefined
                                && data[i].context.extensions['http://xerte.org.uk/learningObjectLevel'] == 'interactivity'
                                && data[i].context.contextActivities != undefined
                                && data[i].context.contextActivities.grouping != undefined
                                && data[i].context.contextActivities.grouping[0] != undefined
                                && data[i].context.contextActivities.grouping[0].id != undefined)
                            {
                                statements.push(data[i]);
                            }
                        }
                        let groups = []
                        statements.forEach(x => groups.push(getGroupingLabel(x)));
                        let uniqueGroups = groups.filter((v, i, a) => a.indexOf(v) === i);

                        for (let uniqueGroup in uniqueGroups) {
                            var statementsGroup=[];
                            xertelabel = uniqueGroups[uniqueGroup].replace(/ /g, "_");
                            for (var i=0; i<statements.length; i++)
                            {
                                if (statements[i].context.contextActivities.grouping[0].id.indexOf(xertelabel) != -1) {
                                    statementsGroup.push(statements[i]);
                                }
                            }
                            groupingStatements = groupingStatements.concat(handler(statementsGroup));
                        }
                        let uniqueStatements = [];
                        let visitedGroups = [];
                        if (adaptiveContent.dashboardMode == 'true') {
                            uniqueStatements = groupingStatements;
                        } else {
                            for (let groupingStatement in groupingStatements) {
                                let group = getGroupingLabel(groupingStatements[groupingStatement]);
                                if (!visitedGroups.includes(group)) {
                                    uniqueStatements.push(groupingStatements[groupingStatement]);
                                    visitedGroups.push(group);
                                }
                            }
                        }
                        adaptiveContent.drawScore(uniqueStatements.reverse(), interaction, url, type, interactionIndex, fullWidth);
                    }
                    else {
                        handler(data, interaction, url, type, interactionIndex, fullWidth);
                    }
                }
                else {
                    div = $(
                        '#' +
                        escapeUrl(url, type, interactionIndex)
                    );
                    div.append('No data found');
                }
            }
        });
    }

    // pageChanged & sizeChanged functions are needed in every model file
    // other functions for model should also be in here to avoid conflicts.
    var adaptiveContent = new function() {
        var xerteurl = "";
        var xertelo = "";
        var xertelabel = "";
        var xertegrouping = "";
        var name = "";
        var interactionType = "";
        var opinionClass = "";
        var url = "";
        var divUrl = "";
        var group = "";
        var dashboardMode = 'false';

        this.loadJS = function() {
            if (numLoaded < 4) {
                var fileToLoad;
                if (numLoaded == 0) {
                    fileToLoad = x_templateLocation + 'common_html5/js/chart.min.js';
                }
                /*
                else if (numLoaded == 1) {
                    fileToLoad = 'common_html5/js/xapidashboard/dist/xapidashboard.min.js';
                }
                */
                else if (numLoaded == 1) {
                    fileToLoad = 'modules/xerte/xAPI/xapicollection.min.js';
                }
                else if (numLoaded == 2) {
                    fileToLoad = x_templateLocation + 'common_html5/js/moment-with-locales.min.js';
                }
                else if (numLoaded == 3) {
                    fileToLoad = x_templateLocation + 'common_html5/js/apexcharts.min.js';
                }

                $.getScript(fileToLoad)
                    .done(function(script, textStatus) {
                        numLoaded++;
                        adaptiveContent.loadJS();
                    })
                    .fail(function( jqxhr, settings, exception ) {
                        console.log('Failed to load chart scripts');
                    });
            }
            else
            {

                // All files have loaded

                // Make sure config is correct
                /*
                var conf = {
                    "endpoint": lrsEndpoint + '/',
                    "user": lrsUsername,
                    "password": lrsPassword,
                    "strictCallbacks": true
                };

                ADL.XAPIWrapper.changeConfig(conf);
                ADL.XAPIWrapper.log.debug = true;
                */

                var displayMode = x_currentPageXML.getAttribute('displayMode');
                if(displayMode == "Listed"){
                    this.setUpListed();
                }else {
                    this.setUpUnlisted();
                }

            }

        };

        // Function called every time the page is viewed after it has initially loaded.
        this.pageChanged = function() {
            $("#adaptiveContentMain").html("");
            var displayMode = x_currentPageXML.getAttribute('displayMode');
        debugger;
            if(displayMode == "Listed"){
                this.setUpListed();
            }else {
                this.setUpUnlisted();
            }
        }

        // Function called every time the size of the LO is changed.
        this.sizeChanged = function() {
            var width = $x_pageHolder.width();
            var height = $x_pageHolder.height();
            if (width > height) {
                $('#diagram').width(height * 0.90);
                $('#diagram').height(height * 0.90);
                textSize = (width - height) / 10;
            }
            else {
                $('#diagram').width(width * 0.90);
                $('#diagram').height(width * 0.90);
                textSize = (height - width) / 10;
            }

            if (textSize > 20) {
                textSize = 20;
            }
            else if (textSize < 12) {
                textSize = 12;
            }
            var displayMode = x_currentPageXML.getAttribute('displayMode');
            if(displayMode == "Listed") {
                var pageDiv = $("#x_pageDiv");
                pageDiv.height(height - (pageDiv.innerHeight() - pageDiv.height()));
                $("#adaptiveContentMain .splitScreen .left").height(pageDiv.height());
                $("#adaptiveContentMain .splitScreen .right").height(pageDiv.height());

            }
        };

        this.init = function() {
            debugger;
            var loadFiles = true;
            for (var i = 0; i < x_pageInfo.length; i++) {
                if (i != x_currentPage && x_pageInfo[i].type == x_pageInfo[x_currentPage].type && x_pageInfo[i].built != false) {
                    // a page of this type has already been loaded - don't reload popcorn files
                    loadFiles = false;
                    break;
                }
            }
            this.dashboardMode = x_currentPageXML.getAttribute('dashboardMode');
            if (this.dashboardMode == undefined)
            {
                this.dashboardMode = 'false';
            }
            if (loadFiles == true) {
                numLoaded = 0;
                this.loadJS();
            } else {
                var displayMode = x_currentPageXML.getAttribute('displayMode');
                if(displayMode == "Listed"){
                    this.setUpListed();
                }else {
                    this.setUpUnlisted();
                }
            }
        };



        this.drawBlock = function(location, interaction, interactionIndex, fullWidth)
        {
            xerteurl = interaction.getAttribute('xerteurl');
            xertelo = interaction.getAttribute('xertelo');
            xertelabel = interaction.getAttribute('label');
            xertegrouping = interaction.getAttribute('grouping');
            name = interaction.getAttribute('name');
            interactionType = interaction.getAttribute('interactionType');
            opinionClass = interaction.getAttribute('opinionClass');
            if (interactionType == 'open' && xertelabel.indexOf('/') == -1)
            {
                xertelabel += '/' + xertelabel;
            }

            var scoreLabelText = interaction.getAttribute('scoreText');
            if (scoreLabelText == undefined) {
                scoreLabelText = 'Your score is {0}';
            }

            var answerLabelText = interaction.getAttribute('answerText');
            if (answerLabelText == undefined) {
                answerLabelText = 'Your answer is {0}';
            }

            var nrParticipantsText = interaction.getAttribute('NrParticipantsText');
            if (nrParticipantsText == undefined) {
                nrParticipantsText = 'The number of participants is {0}';
            }

            if (interactionType != 'grouping') {
                url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
            }
            else
            {
                url = getUrl(xerteurl, xertelo);
            }
            var $this = this;
            divUrl = escapeUrl(url, interactionType, interactionIndex);
            name = interaction.getAttribute('name');
            var score = interaction.score;
            var div = $("<div>")
                .attr('id', divUrl)
                .attr('data-index', interactionIndex)
                .addClass("panel");

            let specificationDiv = '';
            if (interaction.getAttribute('showSpecification') == 'true') {
                specificationDiv = '<div class="specification">' +
                        `<h4>${interaction.getAttribute('SpecificationText')}</h4>` +
                        '<ul class="question-list"></ul>' +
                    '</div>';
            }
            let adviceHeader = '';
            if (interaction.children.length !== 0 && !adaptiveContent.dashboardMode) {
                adviceHeader = `<h4>${interaction.getAttribute('AdviceText')}</h4>`;
            }

            debugger;
            let introductionText = interaction.getAttribute('introduction');
            if (introductionText == undefined) {
                introductionText = "";
            }
            let summaryText = interaction.getAttribute('SummaryText');
            if (summaryText == undefined)
            {
                summaryText = "";
            }
            if (interaction.getAttribute('showNrOfQuestions') != "true"  && interaction.getAttribute('showNrOfCorrectQuestions') != "true")
            {
                // Do not show Summry heading
                summaryText = "";
            }
            else
            {
                summaryText = `<h1><p>${summaryText}</p></h1>`;
            }
            div.html(
                `<h2><p>${name}</p></h2>` +
                `<div class='introduction'>${introductionText}</div>` +
                '<div class="summary-container">' +
                    '<div class="summary">' +
                        summaryText +
                        '<div class="score">' +
                          '<div class="stats-div"><ul class="stats"></ul></div>' +
                        '</div>' +
                        specificationDiv +
                        '<div class="advice">' +
                            adviceHeader +
                            '<div class="message"></div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="graph-container"></div>' +
                '</div>'
            );

            $(location).append(div);

            /*
            $('#adaptiveContent').append(
                "<div id='" + divUrl + "' data-index='" + interactionIndex + "'></div>",
            );

            $('#adaptiveContent #' + divUrl).append(
                '<h2>' +
                name +
                "</h2><div class='introduction'>" +
                interaction.getAttribute('introduction') +
                "</div><div class='score'></div><div class='message'></div>",
            );
            */
            if (interactionType == "score") {
                var verb = 'http://adlnet.gov/expapi/verbs/scored';
                if (interaction.data != null) {
                    var url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
                    this.drawScore(interaction.data, interaction, url, interactionType, interactionIndex, fullWidth);
                }
                else {
                    var statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        verb,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        fullWidth,
                        this.drawScore);
                }
            }
            else if (interactionType == 'answer') {
                var verb = 'http://adlnet.gov/expapi/verbs/answered';
                if (interaction.data != null) {
                    var url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
                    this.drawAnswer(interaction.data, interaction, url, interactionType, interactionIndex, fullWidth);
                }
                else {
                    var statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        verb,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        fullWidth,
                        this.drawAnswer);
                }
            }
            else if (interactionType == 'opinion') {
                var verb = 'http://adlnet.gov/expapi/verbs/scored';
                if (interaction.data != null) {
                    var url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
                    this.drawOpinion(interaction.data, interaction, url, interactionType, interactionIndex, fullWidth);
                }
                else {
                    var statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        verb,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        fullWidth,
                        this.drawOpinion
                    );
                }
            }
            else if (interactionType == "open")
            {
                // check open question special options
                var verb = 'http://adlnet.gov/expapi/verbs/scored';
                if (interaction.data != null) {
                    var url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
                    this.drawOpen(interaction.data, interaction, url, interactionType, interactionIndex, fullWidth);
                }
                else {
                    statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        verb,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        fullWidth,
                        this.drawOpen);
                }
            }
            else if (interactionType == "grouping")
            {
                // check open question special options
                var verb = 'http://adlnet.gov/expapi/verbs/scored';
                if (interaction.data != null) {
                    var url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
                    this.drawGroupedScore(interaction.data, interaction, url, interactionType, interactionIndex, fullWidth);
                }
                else {
                    statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertegrouping,
                        verb,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        fullWidth,
                        this.drawGroupedScore);
                }
            }
            else if (interactionType == "groupings")
            {
                // check open question special options
                var verb = 'http://adlnet.gov/expapi/verbs/scored';
                if (interaction.data != null) {
                    var url = getUrl(xerteurl, xertelo, xertelabel, opinionClass);
                    this.drawGroupedScores(interaction.data, interaction, url, interactionType, interactionIndex, fullWidth);
                }
                else {
                    statements = getStatements(
                        xerteurl,
                        xertelo,
                        xertegrouping,
                        verb,
                        opinionClass,
                        interactionType,
                        hasToRetrieveAll(interaction),
                        interactionIndex,
                        group,
                        fullWidth,
                        this.drawGroupedScores);
                }
            }

        };

        this.drawScore = function(data, interaction, url, type, interactionIndex, fullWidth) {
            let scoreLabelText = interaction.getAttribute('scoreText');
            if (scoreLabelText == null) {
                scoreLabelText = 'Your score is {0}';
            }
            let nrParticipantsText = interaction.getAttribute('NrParticipantsText');
            if (nrParticipantsText == null) {
                nrParticipantsText = 'The number of participants is {0}';
            }
            let NrQuestionsText = interaction.getAttribute('NrQuestionsText');
            if (NrQuestionsText == null) {
                NrQuestionsText = 'Total number of questions {0}';
            }
            let NrCorrectQuestionsText = interaction.getAttribute('NrCorrectQuestionsText');
            if (NrCorrectQuestionsText == null) {
                NrCorrectQuestionsText = 'Total correct {0}';
            }
            var CorrectText = interaction.getAttribute('CorrectText');
            if (CorrectText == undefined) {
                CorrectText = 'Correct';
            }
            var IncorrectText = interaction.getAttribute('IncorrectText');
            if (IncorrectText == undefined) {
                IncorrectText = 'Incorrect';
            }
            var xertelo = interaction.getAttribute('xertelo');
            var statements = filterOwnStatements(data);
            xerteurl = interaction.getAttribute('xerteurl');
            xertelabel = interaction.getAttribute('label');
            name = interaction.getAttribute('name');
            interactionType = interaction.getAttribute('interactionType');
            opinionClass = interaction.getAttribute('opinionClass');
            var nrbars = interaction.getAttribute('graphNrDataPoints');
            if (nrbars == undefined)
            {
                nrbars = 10;
            }
            if (statements.length > 0) {

                if (statements[0].extensions !== undefined) {
                    let numQuestions = statements[0].extensions['http://xerte.org.uk/grouping/num-grouped-statements'];
                    if (numQuestions !== undefined) {
                        if (interaction.getAttribute('showNrOfQuestions') == 'true') {
                            var txt = NrQuestionsText;
                            txt = txt.replace(/\{0\}/, numQuestions);
                            $(`#${escapeUrl(url, type, interactionIndex)} .score .stats`).append(`<li>${txt}</li>`);
                        }
                    }
                }

                if (statements[0].result.extensions !== undefined) {
                    let correctQuestionScores;
                    if (adaptiveContent.dashboardMode == 'true') {
                        correctQuestionScores = {};
                        for (let statement in statements) {
                            let res = statements[statement].result.extensions['http://xerte.org.uk/result/grouping/scores'];
                            for (let singleRes in res) {
                                if (!(res[singleRes][0][0] in correctQuestionScores)) {
                                    correctQuestionScores[res[singleRes][0][0]] = [res[singleRes][1]];
                                } else {
                                    correctQuestionScores[res[singleRes][0][0]].push(res[singleRes][1]);
                                }
                            }
                        }
                    } else {
                        correctQuestionScores = statements[0].result.extensions['http://xerte.org.uk/result/grouping/scores'];
                    }
                    if (correctQuestionScores !== undefined) {
                        if (interaction.getAttribute('showNrOfCorrectQuestions') == 'true') {
                            let numCorrectQuestions = 0;
                            for (let i = 0; i < correctQuestionScores.length; i++) {
                                if (correctQuestionScores[i][1] === 100) {
                                    numCorrectQuestions += 1;
                                }
                            }
                            var txt = NrCorrectQuestionsText;
                            txt = txt.replace(/\{0\}/, numCorrectQuestions);
                            $(`#${escapeUrl(url, type, interactionIndex)} .score .stats`).append(`<li>${txt}</li>`);
                        }
                        if (interaction.getAttribute('showSpecification') == 'true') {
                            if (adaptiveContent.dashboardMode == 'true') {
                                const average = list => list.reduce((prev, curr) => prev + curr) / list.length;
                                for (let questionScore in correctQuestionScores) {
                                    txt = `${questionScore}: ${average(correctQuestionScores[questionScore]).toFixed(1)}`;
                                    $(`#${escapeUrl(url, type, interactionIndex)} .specification .question-list`).append(`<li>${txt}%</li>`);
                                }
                            } else {
                                for (let i = 0; i < correctQuestionScores.length; i++) {
                                    txt = `${correctQuestionScores[i][0]}: ${(correctQuestionScores[i][1] === 100) ? CorrectText : IncorrectText}`;
                                    $(`#${escapeUrl(url, type, interactionIndex)} .specification .question-list`).append(`<li>${txt}</li>`);
                                }
                            }
                        }
                    }
                }

                if (interaction.getAttribute('interactionType') === 'groupings') {
                    let visitedGroups = {};
                    for (let statement in statements) {
                        let group = statements[statement].context.contextActivities.grouping[0].definition.name["en-US"];
                        if (!(group in visitedGroups)) {
                            visitedGroups[group] = [statements[statement].result.score.raw];
                        } else {
                            visitedGroups[group].push(statements[statement].result.score.raw);
                        }
                    }
                    const sortObject = obj => Object.keys(obj).sort().reduce((res, key) => (res[key] = obj[key], res), {});
                    visitedGroups = sortObject(visitedGroups);
                    const average = list => list.reduce((prev, curr) => prev + curr) / list.length;
                    for (group in visitedGroups) {
                        score = average(visitedGroups[group]);
                        if (interaction.getAttribute("showScore") == "true") {
                            var txt = group;
                            txt = `${txt}: ${Math.round(score*10)/10}`;
                            $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').append('<li>' + txt + '%</li>');
                        }
                    }
                } else {

                    score = 0;

                    if (adaptiveContent.dashboardMode == 'true') {
                        for (let statement in statements) {
                            score += statements[statement].result.score.raw;
                        }
                        score = score / statements.length;
                    } else {
                        score = statements[0].result.score.raw;
                    }
                    if (interaction.getAttribute("showScore") == "true") {
                        var txt = scoreLabelText;
                        txt = txt.replace(/\{0\}/, Math.round(score*10)/10);
                        $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').append('<li>' + txt + '%</li>');
                    }
                }
                if (adaptiveContent.dashboardMode == "false") {
                    for (blockIndex = 0; blockIndex < interaction.children.length; blockIndex++) {
                        block = interaction.children[blockIndex];
                        scoreRange = block.getAttribute('conScoreBetween');
                        range = scoreRange.split(",");
                        if (range.length == 2) {
                            lowerBound = range[0];
                            upperBound = range[1];
                            if (score >= lowerBound && score <= upperBound) {
                                $('#' + escapeUrl(url, type, interactionIndex) + ' .message').html(
                                    block.getAttribute('adaptiveContent')
                                );
                            }
                        }
                    }
                }
            }
            if (interaction.getAttribute("showNrOfParticipants") == "true") {
                let sessionIds = statements.map(x => x.context.extensions["http://xerte.org.uk/sessionId"]);
                let uniqueSessions = sessionIds.filter((e, i) => sessionIds.indexOf(e) === i);
                var txt = nrParticipantsText;
                txt = txt.replace(/\{0\}/, uniqueSessions.length);
                $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').append('<li>' + txt + '</li>');
            }
            if (interaction.getAttribute('graph') === 'true') {
                var showExplanation = interaction.getAttribute('showExplanation');
                var Explanation = interaction.getAttribute('graphExplanation');
                var ExplanationPanelWidth = interaction.getAttribute("graphExplanationPanelWidth");
                if (showExplanation == undefined)
                {
                    showExplanation = 'false';
                }
                if (Explanation == undefined)
                {
                    Explanation = "";
                }
                if (ExplanationPanelWidth == undefined)
                {
                    ExplanationPanelWidth = "40%";
                }
                div = $('#' + escapeUrl(url, type, interactionIndex) + ' .graph-container');
                if (
                    interaction.getAttribute('graphType') == 'pie_marks'
                    || interaction.getAttribute('graphType') == 'bar_comb_marks'
                    || interaction.getAttribute('graphType') == 'polar_area_per_category'){
                    div.append(
                        "<div class='graph'><canvas id='" +
                        escapeUrl(url, type, interactionIndex) +
                        "-graph'></canvas></div>"
                    );
                }
                else if (interaction.getAttribute('graphType') == 'hor_bar_comb_marks') {
                  div.append(
                      "<div class='graph'><div id='" +
                      escapeUrl(url, type, interactionIndex) +
                      "-graph'></div></div>"
                  );
                }
                else {
                    div.append(
                        "<div class='graph'><svg id='" +
                        escapeUrl(url, type, interactionIndex) +
                        "-graph'></svg></div>"
                    );
                }
                if (showExplanation == 'true' && Explanation != "")
                {
                    div.append("<div class=\"panel legend\" style=\"width: " + ExplanationPanelWidth + ";\">" + Explanation + "</div>");
                }

                if (interaction.getAttribute('graphType') == 'bar_answers') {
                    var dash = new ADL.XAPIDashboard();
                    dash.addStatements(data);
                    var xAxisLabelBarAnswers = interaction.getAttribute("xAxisLabelBarAnswers");
                    var yAxisLabelBarAnswers = interaction.getAttribute("yAxisLabelBarAnswers");
                    if (xAxisLabelBarAnswers == undefined) xAxisLabelBarAnswers = "Answers given";
                    if (yAxisLabelBarAnswers == undefined) yAxisLabelBarAnswers = "Number of answers";
                    var chart = dash.createBarChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'result.response',
                            aggregate: ADL.count(),
                            post: function (d) {
                                d.contents.map(function (el) {
                                    el.out *= 1 / data.length * 100;
                                });
                            },
                            customize: function (chart) {
                                chart.xAxis.rotateLabels(45).axisLabel(xAxisLabelBarAnswers);
                                chart.yDomain([0, 100]);
                                chart.yAxis.axisLabel(yAxisLabelBarAnswers);
                                if(fullWidth){
                                    chart.width(700);
                                }else{
                                    chart.width(450);
                                }
                                chart.height(300);
                            }
                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute('graphType') == 'bar_marks') {
                    var xAxisLabelBarMarks = interaction.getAttribute("xAxisLabelBarMarks");
                    var yAxisLabelBarMarks = interaction.getAttribute("yAxisLabelBarMarks");
                    if (xAxisLabelBarMarks == undefined) xAxisLabelBarMarks = "Score Range [%]";
                    if (yAxisLabelBarMarks == undefined) yAxisLabelBarMarks = "% of Group";
                    var dash = new ADL.XAPIDashboard();
                    dash.addStatements(data);
                    data.map(function (x) {
                        x.result.score.raw;
                        return x;
                    });
                    var chart = dash.createBarChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'result.score.raw',
                            aggregate: ADL.count(),
                            range: {start: 0.0, end: 100.0, increment: Math.ceil(100/nrbars)},
                            post: function (d) {
                                d.contents.map(function (el) {
                                    el.out *= 1 / data.length * 100;
                                });
                            },
                            customize: function (chart) {
                                chart.xAxis.rotateLabels(45).axisLabel(xAxisLabelBarMarks);
                                chart.yAxis.axisLabel(yAxisLabelBarMarks);
                                if(fullWidth){
                                    chart.width(700);
                                }else{
                                    chart.width(450);
                                }
                                chart.height(300);
                                chart.yDomain([0, 100]);
                            }

                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute('graphType') == 'bar_comb_marks') {
                    let passingGrade = x_params.trackingPassed;
                    if (passingGrade == null) {
                        passingGrade = '55';
                    }
                    else
                    {
                        if (passingGrade.indexOf('%') >=0) {
                            passingGrade = parseInt(passingGrade) + '';
                        }
                        else if (parsefloat(passingGrade) >= 0 && parsefloat(passingGrade) <= 1)
                        {
                            passingGrade = (parseFloat(passingGrade) * 100.0) + '';
                        }
                    }
                    let ldData = [];
                    let ldLabels = [];
                    let ldPassing = [];
                    let visitedGroups = {};
                    for (let statement in statements) {
                        let group = statements[statement].context.contextActivities.grouping[0].definition.name["en-US"];
                        if (!(group in visitedGroups)) {
                            visitedGroups[group] = [statements[statement].result.score.raw];
                        } else {
                            visitedGroups[group].push(statements[statement].result.score.raw);
                        }
                    }
                    const sortObject = obj => Object.keys(obj).sort().reduce((res, key) => (res[key] = obj[key], res), {});
                    visitedGroups = sortObject(visitedGroups);
                    const average = list => list.reduce((prev, curr) => prev + curr) / list.length;
                    for (let group in visitedGroups) {
                        ldData.push(average(visitedGroups[group]))
                        ldLabels.push(group)
                        ldPassing.push(Number(passingGrade));
                    }
                    //statements.forEach(x => {
                    //    ldData.push(x.result.score.raw)
                    //    ldLabels.push(x.context.contextActivities.grouping[0].definition.name['en-US'])
                    //    ldPassing.push(Number(passingGrade));
                    //});
                    let ctx = escapeUrl(url, type, interactionIndex) + '-graph';
                    let options = {
                        maintainAspectRatio: false,
                        legend: {
                            display: false
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            }]
                        }
                    }
                    var mixedChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            datasets: [{
                                label: 'Bar Dataset',
                                data: ldData,
                                backgroundColor: 'rgba(40, 64, 150, 0.8)',
                                borderColor: 'rgba(40, 64, 150, 1)',
                                order: 1,
                            }, {
                                label: 'Line Dataset',
                                data: ldPassing,

                                // Changes this dataset to become a line
                                type: 'line',
                                fill: false,
                                backgroundColor: 'rgba(40, 200, 64, 1)',
                                borderColor: 'rgba(40, 200, 64, 1)',
                                order: 2,
                            }],
                            labels: ldLabels,
                        },
                        options: options,
                    });
                }
                else if (interaction.getAttribute('graphType') == 'pie_marks') {
                    var correctLabel = interaction.getAttribute("correctLabel");
                    var incorrectLabel = interaction.getAttribute("incorrectLabel");
                    if (correctLabel == undefined) correctLabel = "Correct";
                    if (incorrectLabel == undefined) incorrectLabel = "Incorrect";

                    let numCorrectQuestions = 0;
                    let numIncorrectQuestions = 0;

                    if (adaptiveContent.dashboardMode == 'true') {
                        for (let statement in statements) {
                            if (statements[statement].result.extensions !== undefined) {
                                let correctQuestionScores = statements[statement].result.extensions['http://xerte.org.uk/result/grouping/scores'];
                                if (correctQuestionScores !== undefined) {
                                    for (let i = 0; i < correctQuestionScores.length; i++) {
                                        if (correctQuestionScores[i][1] === 100) {
                                            numCorrectQuestions += 1;
                                        } else {
                                            numIncorrectQuestions += 1;
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        if (statements[0].result.extensions !== undefined) {
                            let correctQuestionScores = statements[0].result.extensions['http://xerte.org.uk/result/grouping/scores'];
                            if (correctQuestionScores !== undefined) {
                                for (let i = 0; i < correctQuestionScores.length; i++) {
                                    if (correctQuestionScores[i][1] === 100) {
                                        numCorrectQuestions += 1;
                                    } else {
                                        numIncorrectQuestions += 1;
                                    }
                                }
                            }
                        }
                    }
                    let ctx = escapeUrl(url, type, interactionIndex) + '-graph';
                    let options = {
                        maintainAspectRatio: false,
                    };
                    data = {
                      labels: [correctLabel, incorrectLabel],
                      datasets: [{
                          label: '# of Votes',
                          data: [numCorrectQuestions, numIncorrectQuestions],
                          backgroundColor: [
                              'rgba(40, 200, 64, 0.8)',
                              'rgba(255, 95, 87, 0.8)',
                          ],
                          borderColor: [
                              'rgba(40, 200, 64, 1)',
                              'rgba(255, 95, 87, 1)',
                          ],
                          borderWidth: 1
                      }],
                    };
                    chart = new Chart(ctx, {
                        type: 'pie',
                        data: data,
                        options: options,
                    });
                }
                else if (interaction.getAttribute("graphType") == "line_average_marks") {
                    var xAxisLabelLineAvgMarks = interaction.getAttribute("xAxisLabelLineAvgMarks");
                    var yAxisLabelLineAvgMarks = interaction.getAttribute("yAxisLabelLineAvgMarks");
                    if (xAxisLabelLineAvgMarks == undefined) xAxisLabelLineAvgMarks = "Score Range [%]";
                    if (yAxisLabelLineAvgMarks == undefined) yAxisLabelLineAvgMarks = "% of Group";
                    var dash = new ADL.XAPIDashboard();
                    dash.addStatements(data);
                    data.map(function (x) {
                        x.result.score.raw;
                        return x;
                    });

                    var chart = dash.createLineChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'result.score.raw',
                            aggregate: ADL.count(),
                            range: {start: 0.0, end: 100.0, increment: Math.ceil(100/nrbars)},
                            rangeLabel: 'start',
                            post: function (d) {
                                d.contents.map(function (el) {
                                    el.out *= 1 / data.length * 100;
                                });
                            },
                            customize: function (chart) {
                                chart.xAxis.rotateLabels(45).axisLabel(xAxisLabelLineAvgMarks);
                                chart.yAxis.axisLabel(yAxisLabelLineAvgMarks);
                                if(fullWidth){
                                    chart.width(700);
                                }else{
                                    chart.width(450);
                                }
                                chart.tooltips(false);
                                chart.height(300);
                                chart.yDomain([0, 100]);
                            }

                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute("graphType") == "line_own_marks") {
                    var xAxisLabelLineOwnMarks = interaction.getAttribute("xAxisLabelLineOwnMarks");
                    var yAxisLabelLineOwnMarks = interaction.getAttribute("yAxisLabelLineOwnMarks");
                    if (xAxisLabelLineOwnMarks == undefined) xAxisLabelLineOwnMarks = "Date";
                    if (yAxisLabelLineOwnMarks == undefined) yAxisLabelLineOwnMarks = "Grade [0-10]";
                    var dash = new ADL.XAPIDashboard();
                    data.map(function (x) {
                        x.result.score.raw;
                        return x;
                    });

                    dash.addStatements(statements);
                    end = new Date();
                    begin = end;
                    for (statement in statements) {
                        if (begin.getTime() > new Date(statements[statement].timestamp).getTime()) {
                            begin = new Date(statements[statement].timestamp);
                        }
                    }

                    begin = new Date(begin.getTime() - 1 * 24 * 60 * 60 * 1000);
                    var chart = dash.createLineChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'timestamp',
                            range: {
                                start: begin.toISOString(),
                                end: end.toISOString(),
                                increment: 1000 * 60 * 15
                            },
                            aggregate: ADL.average('result.score.raw'),
                            rangeLabel: 'start',
                            customize: function (chart) {
                                if(fullWidth){
                                    chart.width(700);
                                }else{
                                    chart.width(700);
                                }
                                chart.height(300);
                                chart.tooltips(false);
                                chart.yDomain([0, 10]);
                                chart.xAxis.axisLabel(xAxisLabelLineOwnMarks);
                                chart.yAxis.axisLabel(yAxisLabelLineOwnMarks);
                                chart.xAxis.tickFormat(function (label) {
                                    return d3.time.format('%b %d')(new Date(label));
                                });
                            },
                            post: function (data) {
                                data.contents.map(function (el) {
                                    el.out = el.out / 10;
                                    el.in = Date.parse(el.in);
                                });
                            }
                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute("graphType") == "polar_area_per_category") {
                  let backgroundColors = [
                    '#FF6384',
                    '#4BC0C0',
                    '#FFCD56',
                    '#C9CBCF',
                    '#36A2EB',
                    '#B284BE',
                  ];
                  let visitedGroups = {};
                  for (let statement in statements) {
                      let group = statements[statement].context.contextActivities.grouping[0].definition.name["en-US"];
                      if (!(group in visitedGroups)) {
                          visitedGroups[group] = [statements[statement].result.score.raw];
                      } else {
                          visitedGroups[group].push(statements[statement].result.score.raw);
                      }
                  }
                  let labelCounter = 0;
                  let legendLabels = [];
                  for (key in visitedGroups) {
                    legendLabels.push({
                      text: key,
                      fillStyle: backgroundColors[labelCounter],
                    });
                    labelCounter += 1;
                  }
                  labelCounter = 0;
                  let questions = statements.map(statement => statement.result.extensions['http://xerte.org.uk/result/grouping/scores']);
                  let labels = [];
                  let backgroundColor = [];
                  let dataValues = [];
                  for (let index in questions) {
                    let questionsGroup = questions[index];
                    for (let index in questionsGroup) {
                      let singleQuestion = questionsGroup[index];
                      labels.push(singleQuestion[0][0]);
                      dataValues.push(singleQuestion[1]);
                      backgroundColor.push(backgroundColors[labelCounter]);
                    }
                    labelCounter += 1;
                  }
                  let ctx = escapeUrl(url, type, interactionIndex) + '-graph';
                  let options = {
                      maintainAspectRatio: false,
                  };
                  const data = {
                    labels,
                    datasets: [{
                      label: 'My First Dataset',
                      data: dataValues,
                      backgroundColor
                    }]
                  };
                  var myChart = new Chart(ctx, {
                      type: 'polarArea',
                      data: data,
                      options: {
                        maintainAspectRatio: false,
                        plugins: {
                          legend: {
                            display: true,
                            labels: {
                              generateLabels: function(chart) {
                                return legendLabels;
                              }
                            }
                          }
                        }
                      }
                  });

                }
                else if (interaction.getAttribute("graphType") == 'hor_bar_comb_marks') {
                  //<div id="chart" style="height: 600px; width: 600px;">
                  //</div>
                  let passingGrade = x_params.trackingPassed;
                  if (passingGrade == null) {
                      passingGrade = '55';
                  }
                  else
                  {
                      if (passingGrade.indexOf('%') >=0) {
                          passingGrade = parseInt(passingGrade) + '';
                      }
                      else if (parsefloat(passingGrade) >= 0 && parsefloat(passingGrade) <= 1)
                      {
                          passingGrade = (parseFloat(passingGrade) * 100.0) + '';
                      }
                  }
                  let ctx = escapeUrl(url, type, interactionIndex) + '-graph';

                  let visitedGroups = {};
                  for (let statement in statements) {
                      let group = statements[statement].context.contextActivities.grouping[0].definition.name["en-US"];
                      if (!(group in visitedGroups)) {
                          visitedGroups[group] = [statements[statement].result.score.raw];
                      } else {
                          visitedGroups[group].push(statements[statement].result.score.raw);
                      }
                  }
                  let labelCounter = 0;
                  let data = [];
                  for (key in visitedGroups) {
                    data.push({
                      x: key,
                      y: Math.round(visitedGroups[key][0], 2),
                      goals: [
                        {
                          name: 'Expected',
                          value: passingGrade,
                          strokeWidth: 5,
                          strokeColor: '#775DD0'
                        }
                      ],
                    });
                    labelCounter += 1;
                  }
                  debugger;
                  var options = {
                    series: [
                      {
                        data,
                      },
                    ],
                    chart: {
                      height: 350,
                      type: 'bar'
                    },
                    plotOptions: {
                      bar: {
                        horizontal: true,
                        distributed: true,
                      }
                    },
                    colors: [
                      '#FF6384',
                      '#4BC0C0',
                      '#FFCD56',
                      '#C9CBCF',
                      '#36A2EB',
                      '#B284BE',
                    ],
                    dataLabels: {
                      formatter: function(val, opt) {
                        const goals =
                          opt.w.config.series[opt.seriesIndex].data[opt.dataPointIndex]
                            .goals

                        if (goals && goals.length) {
                          return `${val}%`
                        }
                        return val
                      }
                    },
                    legend: {
                      show: true,
                      showForSingleSeries: true,
                      customLegendItems: ['Average'],
                      markers: {
                        fillColors: [
                           '#775DD0',
                        ]
                      }
                    }
                  };
                  var chart = new ApexCharts(document.querySelector(`#${ctx}`), options);
                  chart.render();
                }
            }
        };

        this.drawAnswer = function(data, interaction, url, type, interactionIndex, fullWidth) {
            var answerLabelText = interaction.getAttribute('answerText');
            if (answerLabelText == undefined) {
                answerLabelText = 'Your answer is {0}';
            }

            var nrParticipantsText = interaction.getAttribute('NrParticipantsText');
            if (nrParticipantsText == undefined) {
                nrParticipantsText = 'The number of participants is {0}';
            }
            var nrbars = interaction.getAttribute('graphNrDataPoints');
            if (nrbars == undefined)
            {
                nrbars = 10;
            }
            var xertelo = interaction.getAttribute('xertelo');
            var statements = filterOwnStatements(data, xertelo);
            if (statements.length > 0) {
                var givenAnswer = statements[0].result.response;
                if (interaction.getAttribute("showScore") == "true") {
                    var txt = answerLabelText;
                    txt = txt.replace(/\{0\}/, givenAnswer);
                    $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').append('<p>' + txt + '</p>');
                }
                for (blockIndex = 0; blockIndex < interaction.children.length; blockIndex++) {
                    var block = interaction.children[blockIndex];
                    var conScoreAnswer = block.getAttribute('conScoreAnswer');
                    if (conScoreAnswer == givenAnswer) {
                        $('#' + escapeUrl(
                            url,
                            type,
                            interactionIndex
                        ) + ' .message').html(
                            block.getAttribute('adaptiveContent')
                        );
                    }
                }
            }
            if (interaction.getAttribute("showNrOfParticipants") == "true") {
                var txt = nrParticipantsText;
                txt = txt.replace(/\{0\}/, data.length);
                $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').append('<p>' + txt + '</p>');
            }
            if (interaction.getAttribute('graph') === 'true') {
                var showExplanation = interaction.getAttribute('showExplanation');
                var Explanation = interaction.getAttribute('graphExplanation');
                var ExplanationPanelWidth = interaction.getAttribute("graphExplanationPanelWidth");
                if (showExplanation == undefined)
                {
                    showExplanation = 'false';
                }
                if (Explanation == undefined)
                {
                    Explanation = "";
                }
                if (ExplanationPanelWidth == undefined)
                {
                    ExplanationPanelWidth = "40%";
                }
                div = $('#' + escapeUrl(
                    url,
                    type,
                    interactionIndex
                ) + ' .graph-container');

                div.append(
                    "<div class='x_floatLeft'><svg id='" +
                    escapeUrl(url, type, interactionIndex) +
                    "-graph'></svg></div>"
                );
                if (showExplanation == 'true' && Explanation != "")
                {
                    div.append("<div class=\"panel legend\" style=\"width: " + ExplanationPanelWidth + ";\" >" + Explanation + "</div>");
                }
                if (interaction.getAttribute('graphType') == 'bar_answers') {
                    var dash = new ADL.XAPIDashboard();
                    dash.addStatements(data);
                    var xAxisLabelBarAnswers = interaction.getAttribute("xAxisLabelBarAnswers");
                    var yAxisLabelBarAnswers = interaction.getAttribute("yAxisLabelBarAnswers");
                    if (xAxisLabelBarAnswers == undefined) xAxisLabelBarAnswers = "Answers given";
                    if (yAxisLabelBarAnswers == undefined) yAxisLabelBarAnswers = "Number of answers";
                    var xDomain = [];
                    if (data.length > 0 && data[0].object.definition != "undefined" && data[0].object.definition.choices != "undfined")
                    {
                        var choices = data[0].object.definition.choices;
                        for (var i=0; i<choices.length; i++)
                        {
                            xDomain[i] = choices[i].id;
                        }
                    }
                    var chart = dash.createBarChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'result.response',
                            aggregate: ADL.count(),
                            post: function (d) {
                                d.contents.map(function (el) {
                                    el.out *= 1 / data.length * 100;
                                });
                            },
                            customize: function (chart) {
                                chart.xAxis.rotateLabels(45).axisLabel(xAxisLabelBarAnswers);
                                chart.yDomain([0, 100]);
                                if (xDomain.length > 0)
                                {
                                    chart.xDomain(xDomain);
                                }
                                chart.yAxis.axisLabel(yAxisLabelBarAnswers);
                                chart.width(700);
                                chart.height(300);
                            }
                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute('graphType') == 'bar_marks') {
                    var dash = new ADL.XAPIDashboard();
                    dash.addStatements(data);
                    var xAxisLabelBarMarks = interaction.getAttribute("xAxisLabelBarMarks");
                    var yAxisLabelBarMarks = interaction.getAttribute("yAxisLabelBarMarks");
                    if (xAxisLabelBarMarks == undefined) xAxisLabelBarMarks = "Score Range [%]";
                    if (yAxisLabelBarMarks == undefined) yAxisLabelBarMarks = "% of Group";
                    data.map(function (x) {
                        x.result.score.raw;
                        return x;
                    });

                    var chart = dash.createBarChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'result.score.raw',
                            aggregate: ADL.count(),
                            range: {start: 0.0, end: 100.0, increment: Math.ceil(100/nrbars)},
                            post: function (d) {
                                d.contents.map(function (el) {
                                    el.out *= 1 / data.length * 100;
                                });
                            },
                            customize: function (chart) {
                                chart.xAxis.rotateLabels(45).axisLabel(xAxisLabelBarMarks);
                                chart.yAxis.axisLabel(yAxisLabelBarMarks);
                                chart.width(700);
                                chart.height(300);
                                chart.yDomain([0, 100]);
                            }
                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute('graphType') == 'line_average_marks') {
                    var dash = new ADL.XAPIDashboard();
                    dash.addStatements(data);
                    var xAxisLabelLineAvgMarks = interaction.getAttribute("xAxisLabelLineAvgMarks");
                    var yAxisLabelLineAvgMarks = interaction.getAttribute("yAxisLabelLineAvgMarks");
                    if (xAxisLabelLineAvgMarks == undefined) xAxisLabelLineAvgMarks = "Score Range [%]";
                    if (yAxisLabelLineAvgMarks == undefined) yAxisLabelLineAvgMarks = "% of Group";
                    data.map(function (x) {
                        x.result.score.raw;
                        return x;
                    });

                    var chart = dash.createLineChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'result.score.raw',
                            aggregate: ADL.count(),
                            range: {start: 0.0, end: 100, increment: Math.ceil(100/nrbars)},
                            rangeLabel: 'start',
                            post: function (d) {
                                d.contents.map(function (el) {
                                    el.out *= 1 / data.length * 100;
                                });
                            },
                            customize: function (chart) {
                                chart.xAxis.rotateLabels(45).axisLabel(yAxisLabelLineAvgMarks);
                                chart.yAxis.axisLabel(yAxisLabelLineAvgMarks);
                                chart.width(700);
                                chart.tooltips(false);
                                chart.height(300);
                                chart.yDomain([0, 100]);
                            }
                        }
                    );
                    chart.draw();
                }
                else if (interaction.getAttribute('graphType') == 'line_own_marks') {
                    var xAxisLabelLineOwnMarks = interaction.getAttribute("xAxisLabelLineOwnMarks");
                    var yAxisLabelLineOwnMarks = interaction.getAttribute("yAxisLabelLineOwnMarks");
                    if (xAxisLabelLineOwnMarks == undefined) xAxisLabelLineOwnMarks = "Date";
                    if (yAxisLabelLineOwnMarks == undefined) yAxisLabelLineOwnMarks = "Grade [0-10]";
                    var dash = new ADL.XAPIDashboard();
                    data.map(function (x) {
                        x.result.score.raw /= 10;
                        return x;
                    });

                    dash.addStatements(statements);
                    end = new Date();
                    begin = end;
                    for (statement in statements) {
                        if (begin.getTime() > new Date(statements[statement].timestamp).getTime()) {
                            begin = new Date(statements[statement].timestamp);
                        }
                    }

                    begin = new Date(begin.getTime() - 1 * 24 * 60 * 60 * 1000)
                    var chart = dash.createLineChart(
                        {
                            container: '#' + escapeUrl(
                                url,
                                type,
                                interactionIndex
                            ) + '-graph',
                            groupBy: 'timestamp',
                            range: {
                                start: begin.toISOString(),
                                end: end.toISOString(),
                                increment: 1000 * 60 * 15
                            },
                            aggregate: ADL.average('result.score.raw'),
                            rangeLabel: 'start',
                            customize: function (chart) {
                                chart.width(700);
                                chart.height(300);
                                chart.tooltips(false);
                                chart.yDomain([0, 10]);
                                chart.xAxis.axisLabel(xAxisLabelLineOwnMarks);
                                chart.yAxis.axisLabel(yAxisLabelLineOwnMarks);
                                chart.xAxis.tickFormat(function (label) {
                                    return d3.time.format('%b %d')(new Date(label));
                                });
                            },
                            post: function (data) {
                                data.contents.map(function (el) {
                                    el.in = Date.parse(el.in);
                                });
                            }
                        }
                    );
                    chart.draw();
                }
            }

        };

        this.drawOpinion = function(data, interaction, url, type, interactionIndex, fullWidth) {
            var scoreLabelText = interaction.getAttribute('scoreText');
            if (scoreLabelText == null) {
                scoreLabelText = 'Your score is {0}';
            }
            var nrParticipantsText = interaction.getAttribute('NrParticipantsText');
            if (nrParticipantsText == null) {
                nrParticipantsText = 'The number of participants is {0}';
            }
            var showExplanation = interaction.getAttribute('showExplanation');
            var Explanation = interaction.getAttribute('graphExplanation');
            var ExplanationPanelWidth = interaction.getAttribute("graphExplanationPanelWidth");
            if (showExplanation == undefined)
            {
                showExplanation = 'false';
            }
            if (Explanation == undefined)
            {
                Explanation = "";
            }
            if (ExplanationPanelWidth == undefined)
            {
                ExplanationPanelWidth = "40%";
            }
            if (interaction.getAttribute("showNrOfParticipants") == "true") {
                var txt = nrParticipantsText;
                txt = txt.replace(/\{0\}/, data.length);
                $('#' + escapeUrl(url, type, interactionIndex) + ' .score .stats').append('<p>' + txt + '</p>');
            }
            jsonData = data.map(function(d) {
                var obj = {}
                obj.timestamp = d.timestamp;
                obj.actor = d.actor;
                obj.result = d.result;
                if (d.result.extensions == undefined) {
                    return undefined;
                }
                obj.graph = JSON.parse(d.result.extensions["http://xerte.org.uk/xapi/JSONGraph"]);
                return obj;
            });
            jsonData = jsonData.filter(function(x) { return x != undefined } );
            div = $('#' + escapeUrl(
                url,
                type,
                interactionIndex
            ) + ' .graph-container');

            div.append(
                "<fieldset class='noStyle'><canvas aria-live='polite'></canvas></fieldset>"
            );
            if (showExplanation == 'true' && Explanation != "")
            {
                div.append("<div class=\"panel legend\" style=\"width: " + ExplanationPanelWidth + ";\" >" + Explanation + "</div>");
            }
            var identifier = '#' + escapeUrl(
                url,
                type,
                interactionIndex
            ) + ' .graph-container canvas';
            createDiagram(jsonData, identifier, adaptiveContent.dashboardMode, interaction);
        };

        this.drawOpen = function(data, interaction, url, type, interactionIndex, fullWidth) {

            var answerLabelText = interaction.getAttribute('answerText');
            if (answerLabelText == undefined) {
                answerLabelText = 'Your answer is {0}';
            }

            var nrParticipantsText = interaction.getAttribute('NrParticipantsText');
            if (nrParticipantsText == undefined) {
                nrParticipantsText = 'The number of participants is {0}';
            }

            var showUserId = 'false';
            var showDate = 'false';
            var sortOrder = 'false';
            if (interaction.getAttribute('showUserID') != undefined)
            {
                showUserId = interaction.getAttribute('showUserID');
            }
            if (interaction.getAttribute('showDate') != undefined)
            {
                showDate = interaction.getAttribute('showDate');
            }
            if (interaction.getAttribute('sortOrder') != undefined)
            {
                sortOrder = interaction.getAttribute('sortOrder');
            }

            moment.locale(x_params.language);
            var allAnswers= [];
            var myAnswers = [];
            for (var i=0; i<data.length; i++) {
                var answer = {};
                if (data[i].result != undefined && data[i].result.response != undefined && data[i].result.response != "") {
                    answer['answer'] = data[i].result.response;
                    var user;
                    if (typeof data[i].actor.name != 'undefined')
                    {
                        user = data[i].actor.name;
                    }
                    else if (typeof data[i].actor.mbox != 'undefined')
                    {
                        user = data[i].actor.mbox.substr(7);
                    }
                    else if (typeof data[i].actor.mbox_sha1 != 'undefined') {
                        user = data[i].actor.mbox_sha1.substr(7);
                    }
                    else if (typeof data[i].actor.account != 'undefined' && typeof data[i].actor.account.name != 'undefined' ){
                        user = data[i].actor.account.name;
                    }
                    else {
                        user = "";
                    }
                    answer['user'] = user;
                    answer['date'] = moment(data[i].timestamp).format('L');

                }
                if (typeof answer['answer'] != "undefined") {
                    if (matchActor(data[i])) {
                        myAnswers.push(answer);
                        allAnswers.push(answer);
                    }
                    else {
                        allAnswers.push(answer);

                    }
                }
            }
            // Perhaps we want to do something with the number of answers
            var nrMyAnswers = myAnswers.length;
            var nrAnswers = allAnswers.length + nrMyAnswers;
            var myOpenAnswerText = interaction.getAttribute('myOpenAnswerText');
            if (myOpenAnswerText == undefined)
            {
                myOpenAnswerText = "My answers";
            }
            var allOpenAnswerText = interaction.getAttribute('allOpenAnswerText');
            if (allOpenAnswerText == undefined)
            {
                allOpenAnswerText = "All answers";
            }

            var html = "";
            if (adaptiveContent.dashboardMode != 'true') {
                if (nrMyAnswers > 0) {
                    if (sortOrder == 'increasing')
                    {
                        // Reverse order
                        var reverse = [];
                        for(i=0; i<myAnswers.length; i++)
                        {
                            reverse[myAnswers.length-1-i] = myAnswers[i];
                        }
                        myAnswers = reverse;
                    }
                    html = "<h2><p>" + myOpenAnswerText + "</p></h2>";
                    html += "<table>";
                    for (i = 0; i < myAnswers.length; i++) {
                        var itemnr = i+1;
                        html += "<tr class='openanswer'>";
                        html += "<td class='itemnr'>" + itemnr + "</td>";
                        if (showDate == 'true' && myAnswers[i]['date'] != "") {
                            html += "<td class='date'>" + myAnswers[i]['date'] + "</td>";
                        }
                        if (showUserId == 'true' && myAnswers[i]['user'] != "") {
                            html += "<td class='user'>" + myAnswers[i]['user'] + "</td>";
                        }
                        html += "<td class='answer'>" + myAnswers[i]['answer'] + "</td>";
                        html += "</tr>";
                    }
                    html += "</table>";
                }
            }
            else {
                if (allAnswers.length > 0) {
                    if (sortOrder == 'increasing')
                    {
                        // Reverse order
                        var reverse = [];
                        for(i=0; i<allAnswers.length; i++)
                        {
                            reverse[allAnswers.length-1-i] = allAnswers[i];
                        }
                        allAnswers = reverse;
                    }
                    html += "<h2><p>" + allOpenAnswerText + "</p></h2>";
                    html += "<table>";
                    for (i = 0; i < allAnswers.length; i++) {
                        var itemnr = i+1;
                        html += "<tr class='openanswer'>";
                        html += "<td class='itemnr'>" + itemnr + "</td>";
                        if (showDate == 'true' && allAnswers[i]['date'] != "") {
                            html += "<td class='date'>" + allAnswers[i]['date'] + "</td>";
                        }
                        if (showUserId == 'true' && allAnswers[i]['user'] != "") {
                            html += "<td class='user'>" + allAnswers[i]['user'] + "</td>";
                        }
                        html += "<td class='answer'>" + allAnswers[i]['answer'] + "</td>";
                        html += "</tr>";
                    }
                    html += "</table>";
                }
            }
            $('#' + escapeUrl(url, type, interactionIndex) + ' .message').html(html);
        };

        this.drawGroupedScore = function(data, interaction, url, type, interactionIndex, fullWidth) {
            // reshuffle
            var groupingStatements = [];
            var userGrouping = [];
            for (var i=0; i<data.length; i++)
            {
                var user;
                if (typeof data[i].actor.name != 'undefined')
                {
                    user = data[i].actor.name;
                }
                else if (typeof data[i].actor.mbox != 'undefined')
                {
                    user = data[i].actor.mbox.substr(7);
                }
                else if (typeof data[i].actor.mbox_sha1 != 'undefined') {
                    user = data[i].actor.mbox_sha1.substr(7);
                }
                else if (typeof data[i].actor.account != 'undefined' && typeof data[i].actor.account.name != 'undefined' ){
                    user = data[i].actor.account.name;
                }
                else {
                    user = "unknown";
                }
                var session = "unknown";
                if (typeof data[i].context != 'undefined'
                    && typeof data[i].context.extensions != 'undefined'
                    && typeof data[i].context.extensions['http://xerte.org.uk/sessionId'] != 'undefined')
                {
                    session = data[i].context.extensions['http://xerte.org.uk/sessionId']
                }
                if (typeof userGrouping[user] == 'undefined')
                {
                    userGrouping[user] = {
                        sessions:  []
                    };
                }
                if (typeof userGrouping[user]['sessions'][session] == 'undefined')
                {
                    userGrouping[user]['sessions'][session] = [];
                }
                userGrouping[user]['sessions'][session].push(i);
            }


            // Calculate averages and create groupingStatments, which are pseudo xAPI statements which are a combination of all the grouping statements
            // Hmm... tric to enumerate array elements
            var userGroupingKeys = Object.keys(userGrouping);
            for (var i=0; i<userGroupingKeys.length; i++)
            {
                var sessions = userGrouping[userGroupingKeys[i]];
                var sessionsKeys = Object.keys(sessions['sessions']);
                for (var j=0; j<sessionsKeys.length; j++)
                {
                    var s = sessions['sessions'][sessionsKeys[j]];
                    // make a full copy of statement
                    var statement = JSON.parse(JSON.stringify(data[s[0]]));
                    var sum = statement.result.score.raw;
                    var duration = moment.duration(statement.result.duration);
                    if (statement.result.extensions === undefined) {
                        statement.result.extensions = {};
                    }
                    statement.result.extensions['http://xerte.org.uk/result/grouping/scores'] = [];
                    statement.result.extensions['http://xerte.org.uk/result/grouping/scores'].push([[data[0].object.definition.name["en-US"]], data[s[0]].result.score.raw]);
                    for (var k=1; k<s.length; k++)
                    {
                        statement.result.extensions['http://xerte.org.uk/result/grouping/scores'].push([[data[s[k]].object.definition.name["en-US"]],  data[s[k]].result.score.raw]);
                        sum += data[s[k]].result.score.raw;
                        duration.add(moment.duration(data[s[k]].result.duration));
                    }
                    statement.result.extensions['http://xerte.org.uk/result/grouping/scores'].reverse();
                    statement.result.score.raw = sum / s.length;
                    statement.result.score.scaled = statement.result.score.raw / 100.0;
                    statement.result.duration = duration.toISOString();
                    statement.extensions = {'http://xerte.org.uk/grouping/num-grouped-statements': s.length};
                    groupingStatements.push(statement);
                }
            }
            // New statements can be handled by drawScore
            adaptiveContent.drawScore(groupingStatements, interaction, url, type, interactionIndex, fullWidth);
        };

        this.drawGroupedScores = function(data) {
            // reshuffle
            var groupingStatements = [];
            var userGrouping = [];
            for (var i=0; i<data.length; i++)
            {
                var user;
                if (typeof data[i].actor.name != 'undefined')
                {
                    user = data[i].actor.name;
                }
                else if (typeof data[i].actor.mbox != 'undefined')
                {
                    user = data[i].actor.mbox.substr(7);
                }
                else if (typeof data[i].actor.mbox_sha1 != 'undefined') {
                    user = data[i].actor.mbox_sha1.substr(7);
                }
                else if (typeof data[i].actor.account != 'undefined' && typeof data[i].actor.account.name != 'undefined' ){
                    user = data[i].actor.account.name;
                }
                else {
                    user = "unknown";
                }
                var session = "unknown";
                if (typeof data[i].context != 'undefined'
                    && typeof data[i].context.extensions != 'undefined'
                    && typeof data[i].context.extensions['http://xerte.org.uk/sessionId'] != 'undefined')
                {
                    session = data[i].context.extensions['http://xerte.org.uk/sessionId']
                }
                if (typeof userGrouping[user] == 'undefined')
                {
                    userGrouping[user] = {
                        sessions:  []
                    };
                }
                if (typeof userGrouping[user]['sessions'][session] == 'undefined')
                {
                    userGrouping[user]['sessions'][session] = [];
                }
                userGrouping[user]['sessions'][session].push(i);
            }

            // Calculate averages and create groupingStatments, which are pseudo xAPI statements which are a combination of all the grouping statements
            // Hmm... tric to enumerate array elements
            var userGroupingKeys = Object.keys(userGrouping);
            for (var i=0; i<userGroupingKeys.length; i++)
            {
                var sessions = userGrouping[userGroupingKeys[i]];
                var sessionsKeys = Object.keys(sessions['sessions']);
                for (var j=0; j<sessionsKeys.length; j++)
                {
                    var s = sessions['sessions'][sessionsKeys[j]];
                    // make a full copy of statement
                    var statement = JSON.parse(JSON.stringify(data[s[0]]));
                    var sum = statement.result.score.raw;
                    var duration = moment.duration(statement.result.duration);
                    statement.result.extensions['http://xerte.org.uk/result/grouping/scores'] = [];
                    statement.result.extensions['http://xerte.org.uk/result/grouping/scores'].push([[data[0].object.definition.name["en-US"]], data[s[0]].result.score.raw]);
                    for (var k=1; k<s.length; k++)
                    {
                        statement.result.extensions['http://xerte.org.uk/result/grouping/scores'].push([[data[s[k]].object.definition.name["en-US"]],  data[s[k]].result.score.raw]);
                        sum += data[s[k]].result.score.raw;
                        duration.add(moment.duration(data[s[k]].result.duration));
                    }
                    statement.result.extensions['http://xerte.org.uk/result/grouping/scores'].reverse();
                    statement.result.score.raw = sum / s.length;
                    statement.result.score.scaled = statement.result.score.raw / 100.0;
                    statement.result.duration = duration.toISOString();
                    statement.extensions = {'http://xerte.org.uk/grouping/num-grouped-statements': s.length};
                    groupingStatements.push(statement);
                }
            }
            // New statements can be handled by drawScore
            return groupingStatements;
        };

        this.orderInteractions = function(interactions, handler){
            promises = [];
            allInteractions = interactions;
            for (var interactionIndex = 0; interactionIndex < interactions.length; interactionIndex++) {
                interaction = interactions[interactionIndex];
                errors = verifyInteraction(interaction);
                if (errors.length > 0){

                  $('#adaptiveContentMain').append("<div id='errors-"+ interactionIndex+ "'></div>");
                  errors.forEach(function(error){
                      $("#adaptiveContentMain #errors-" + interactionIndex).append(error);
                  });
                  continue;
                }
                xerteurl = interaction.getAttribute('xerteurl');
                xertelo = interaction.getAttribute('xertelo');
                xertelabel = interaction.getAttribute('label');
                name = interaction.getAttribute('name');
                interactionType = interaction.getAttribute('interactionType');
                opinionClass = interaction.getAttribute('opinionClass');
                if (opinionClass == undefined) {
                    opinionClass = '';
                }
                group = interaction.getAttribute('groupFromUrl');
                if (group == undefined) {
                    group = '';
                }
                else {
                    if (group == "true")
                    {
                        if (x_urlParams['group'] != undefined)
                        {
                            group = x_urlParams['group']
                        }
                        else
                        {
                            if (interaction.getAttribute('groupName') != undefined)
                            {
                                group = interaction.getAttribute('groupName');
                            }
                            else {
                                group = "";
                            }
                        }
                    }
                    else {
                        group = "";
                    }
                }
                promises.push(new Promise(function(resolve, reject){
                    var verb = 'http://adlnet.gov/expapi/verbs/scored';
                    if (interactionType == "answer")
                    {
                        verb = 'http://adlnet.gov/expapi/verbs/answered';
                    }
                    getStatements(
                        xerteurl,
                        xertelo,
                        xertelabel,
                        verb,
                        opinionClass,
                        interactionType,
                        false,
                        interactionIndex,
                        group,
                        false,
                        function(data, interaction, url, type, interactionIndex, fullWidth) {
                            interactions[interactionIndex].data = data;
                            interactions[interactionIndex].score = Number.MAX_VALUE;
                            interactions[interactionIndex].index = interactionIndex;
                            if(data.length > 0 && data[0].result != null && data[0].result.score != null && data[0].result.score.raw != null)
                            {
                                interactions[interactionIndex].score = data[0].result.score.raw;
                            }
                            adaptiveContent.resolved++;
                            $("#loader_text").html(adaptiveContent.resolved + '/' + adaptiveContent.totalresolved);
                            resolve();
                        }
                        );
                    }
                ));
                //wait until promises


            }
            Promise.all(promises, function(){
            }).then(function(){
                var sortorder = "none";
                // find elements that should not be sorted
                var donotsort = [];
                var j=0;
                for (var i=0; i<interactions.length; i++)
                {
                    if (interactions[i].getAttribute("doNotSort") === "true")
                    {
                        donotsort[j] = interactions[i].index;
                        j++;
                    }
                }
                if (x_currentPageXML.getAttribute("sortOrder") != null)
                {
                    sortorder = x_currentPageXML.getAttribute("sortOrder");
                }
                if (sortorder == "increasing") {
                    interactions.sort(function (a, b) {
                        if (a.score < b.score) {
                            return -1;
                        }
                        if (a.score > b.score) {
                            return 1;
                        }
                        return 0;
                    });
                }
                else if (sortorder == "decreasing")
                {
                    interactions.sort(function (a, b) {
                        if (a.score < b.score) {
                            return 1;
                        }
                        if (a.score > b.score) {
                            return -1;
                        }
                        return 0;
                    });
                }
                // Resort elements that should not be sorted
                if (donotsort.length > 0)
                {
                    for (var i=0; i<donotsort.length; i++)
                    {
                        for (var j=0; j<interactions.length; j++)
                        {
                            if (interactions[j].index == donotsort[i])
                            {
                                // Move interactions[j] to poistion i
                                for (var k=j; k>i; k--)
                                {
                                    // Swap k with k-1
                                    var interaction = interactions[k-1];
                                    interactions[k-1] = interactions[k];
                                    interactions[k] = interaction;
                                }
                            }
                        }
                    }
                }
                handler(interactions);
            });

        };

        this.setUpListed = function() {


            $("#adaptiveContentMain").append('<div class="splitScreen"><div class="left"></div><div class="right"></div></div>');
            $("#adaptiveContentMain").addClass("listed");
            $(".left").append('<div id="listPanel" class="panel qPanel">');
            $(".right").append('<div id="infoPanel" class="qPanel">');
            $("#listPanel").append('<div id="introductionText"></div><div id="loader"><div><img class="loading-gif" src="' + x_templateLocation + 'common_html5/loading16.gif"/></div><div><p id="loader_text"></p></div></div><div id="adaptiveContentList"></div>');
            //$("#infoPanel").append("<h3>Current block</h3>");

            // Set heights
            var height = $x_pageHolder.height();
            var pageDiv = $("#x_pageDiv");
            pageDiv.css("padding-bottom", "0px");
            pageDiv.height(height - (pageDiv.innerHeight() - pageDiv.height()));
            $("#adaptiveContentMain .splitScreen .left").height(pageDiv.height());
            $("#adaptiveContentMain .splitScreen .right").height(pageDiv.height());

            interactions = $(x_currentPageXML).children();
            $("#adaptiveContentList").append("<ul></ul>");
            var $this = this;
            this.resolved = 0;
            this.totalresolved = interactions.length;
            $("#loader_text").html(this.resolved + '/' + this.totalresolved);
            this.orderInteractions(interactions, function(oInteractions){
                $("#loader").hide();
                $('#introductionText').html(x_currentPageXML.getAttribute('introduction'));

                interactions = oInteractions;
                var scoreLabelText = interaction.getAttribute('scoreText');
                if (scoreLabelText == undefined) {
                    scoreLabelText = 'Your score is {0}';
                }


                for (var interactionIndex = 0; interactionIndex < oInteractions.length; interactionIndex++) {
                    interaction = oInteractions[interactionIndex];
                    errors = verifyInteraction(interaction);
                    if (errors.length > 0){

                      $('#adaptiveContentList ul').append("<li class='select-interaction' data-interaction-index='" + interactionIndex + "'><div id='errors-"+ interactionIndex+ "'></div></li>");
                      errors.forEach(function(error){
                          $("#adaptiveContentList #errors-" + interactionIndex).append(error);
                      });
                      continue;
                    }
                    name = interaction.getAttribute('name');
                    div = $("<div></div>");
                    var scoretext = "";
                    if (interaction.score != Number.MAX_VALUE)
                    {
                        scoretext = "<div class='score'><p>" + scoreLabelText.replace('{0}', Math.round(interaction.score*10)/10) + "</p></div>";
                    }
                    div.html('<h2><p>' +
                        name + '</p></h2>' +
                        scoretext + "<div class='introduction'>" +
                        interaction.getAttribute('introduction') +
                        "</div><div class='message'></div>");

                    $("#adaptiveContentList ul").append("<li class='select-interaction' data-interaction-index='" + interactionIndex + "'>" + div.html() + "</li>");
                }
                $("#infoPanel").html("");
                if (oInteractions.length > 0) {
                    $this.drawBlock("#infoPanel", oInteractions[0], 0, false);
                    $("li.select-interaction[data-interaction-index=\"0\"]").addClass("selected");
                    adaptiveContent.selected = 0;
                }
                $("#listPanel ul li").click(function(){
                    $("li.select-interaction[data-interaction-index=\"" + adaptiveContent.selected+'\"]').removeClass("selected");
                    adaptiveContent.selected  = $(this).data("interaction-index");
                    $("#infoPanel").html("");
                    $("li.select-interaction[data-interaction-index=\"" + adaptiveContent.selected + '\"]').addClass("selected");
                    $this.drawBlock("#infoPanel", oInteractions[adaptiveContent.selected], adaptiveContent.selected, false);
                })

            });
            x_pageLoaded();
        };

        this.setUpUnlisted = function()
        {
            $("#adaptiveContentMain").append('<div id="introductionText"></div><div id="adaptiveContent"></div>');
            $("#adaptiveContentMain").addClass("unlisted");
            $('#introductionText').html(x_currentPageXML.getAttribute('introduction'));
            interactions = $(x_currentPageXML).children();

            x_pageLoaded();

            for (var interactionIndex = 0; interactionIndex < interactions.length; interactionIndex++) {
                interaction = interactions[interactionIndex];
                errors = verifyInteraction(interaction);
                if (errors.length > 0){

                  $('#adaptiveContent').append("<div id='errors-"+ interactionIndex+ "'></div>");
                  errors.forEach(function(error){
                      $("#adaptiveContent #errors-" + interactionIndex).append(error);
                  });
                  continue;
                }
                xerteurl = interaction.getAttribute('xerteurl');
                xertelo = interaction.getAttribute('xertelo');
                xertelabel = interaction.getAttribute('label');
                name = interaction.getAttribute('name');
                interactionType = interaction.getAttribute('interactionType');
                opinionClass = interaction.getAttribute('opinionClass');
                if (opinionClass == undefined) {
                    opinionClass = '';
                }
                group = interaction.getAttribute('groupFromUrl');
                if (group == undefined) {
                    group = '';
                }
                else {
                    if (group == "true")
                    {
                        if (x_urlParams['group'] != undefined)
                        {
                            group = x_urlParams['group']
                        }
                        else
                        {
                            if (interaction.getAttribute('groupName') != undefined)
                            {
                                group = interaction.getAttribute('groupName');
                            }
                            else {
                                group = "";
                            }
                        }
                    }
                    else {
                        group = "";
                    }
                }


                url = xerteurl + xertelo + '/' + xertelabel;
                if (opinionClass != '') {
                    url += '/' + opinionClass;
                }
                this.drawBlock("#adaptiveContent", interaction, interactionIndex, true);


            }



            // Call this function in every model once everything's loaded.

        }
    };
    adaptiveContent.init();

</script>

<div id="adaptiveContentMain">

</div>

