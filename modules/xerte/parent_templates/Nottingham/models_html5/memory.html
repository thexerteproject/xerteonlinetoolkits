<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
	
	// pageChanged & sizeChanged functions are needed in every model file
	// other functions for model should also be in here to avoid conflicts
	var memory = new function() {
		
		// function called every time the page is viewed after it has initially loaded
		this.pageChanged = function() {
			$("#pageContents").data("currentCard", "");
			$("#button").hide();
			this.createCards();
		}
		
		// function called every time the size of the LO is changed
		this.sizeChanged = function() {
			// cards are absolutely positioned so need to ensure panel is correct size - can't do this automatically
			//if ($("#panel.panel").length > 0) {
				$("#panel")[0].style.setProperty("height", $("#cardTopHolder").height() + "px", "important");

				// ensure panel height doesn't collapse when split screen view is show in a single column on smaller screens
				if ($(".splitScreen_B").css("flex-basis") == "100%") {
					$(".splitScreen_B").addClass("fullPanelH");
				} else {
					$(".splitScreen_B").removeClass("fullPanelH");
				}
			//}

			// panel will be fixed height (100% of available height) if panel style is on, unless there is text above &/or below the panel
			XENITH.SPLITSCREEN.resizePanel();

			if (x_browserInfo.mobile == true) {
				$("#pageContents").height($("#cardTopHolder").height() + $x_footerBlock.height() + 50);
			}
		}
		
		this.init = function() {

			$("#pageContents").prepend('<span class="sr-only">' + (x_getLangInfo(x_languageData.find("errorScreenReader")[0], "label") != undefined ? x_getLangInfo(x_languageData.find("errorScreenReader")[0], "label") : "This page type is not compatible with screen readers.") +  '</span>');

			$("#txtHolder").html(x_addLineBreaks(x_currentPageXML.getAttribute("text")));

			// send amended data to split screen function dues to defaults being different for old projects
			const attributes = {
				panelWidth: x_currentPageXML.getAttribute("panelWidth") != undefined ? x_currentPageXML.getAttribute("panelWidth") : "Full",
				panelStyle: x_currentPageXML.getAttribute("panelStyle") != undefined ? x_currentPageXML.getAttribute("panelStyle") : "true",
				removeTxt: x_currentPageXML.getAttribute("removeTxt") != undefined ? x_currentPageXML.getAttribute("removeTxt") : "false"
			}
			// set up split screen layout
			XENITH.SPLITSCREEN.init({"attributes": attributes});
			
			// get & store card data
			const cards = [];
			$(x_currentPageXML).children().each(function(i){
				let card0Type;
				if (this.getAttribute("url2") != undefined && this.getAttribute("url2") != "") { // image on both cards
					cards.push({ref:0, type:"img", data:this.getAttribute("url2"), match:i, name:this.getAttribute("name")});
					card0Type = "img";
					
				} else { // text on one card
					cards.push({ref:0, type:"text", data:this.getAttribute("name"), match:i});
					card0Type = "text";
				}
				
				cards.push({ref:1, type:"img",  data:this.getAttribute("url"),  match:i, matchType:card0Type, name:this.getAttribute("name")});
			});
			
			$("#pageContents").data({
				"cardData"		:cards,
				"currentCard"	:""
			});
			
			$("#button")
				.button({
					label: x_currentPageXML.getAttribute("resetBtnTxt") == undefined ? "Shuffle Cards" : x_currentPageXML.getAttribute("resetBtnTxt")
					})
				.click(function() {
					$("#pageContents").data("currentCard", "");
					$(this).hide();
					memory.createCards();
					})
				.hide();
			
			this.createCards();

			// crop images to fill cards (default is to stretch)
			if (x_currentPageXML.getAttribute("imgFit") == "cover") {
				$("#cardHolder").addClass("bgImgCover");
			}

			this.sizeChanged();
			x_pageLoaded();
		}
		
		this.createCards = function() {
			const $pageContents = $("#pageContents");
			const $cardTopHolder = $("#cardTopHolder");
			const $cardBottomHolder = $("#cardBottomHolder");
			let cardbackurl =  x_templateLocation + 'common_html5/card.png'; // Default
			
			// change card back if alternative available
			if (x_currentPageXML.getAttribute("backurl") != undefined && x_currentPageXML.getAttribute("backurl") != "") {
				cardbackurl = x_currentPageXML.getAttribute("backurl");
			}
			
			// clear existing cards
			$cardTopHolder.add($cardBottomHolder).empty();
			
			// randomise order and create new cards
			const cards = [];
			const tempCards = $pageContents.data("cardData").slice(0);
			let i;
			
			for (i=0; i<$pageContents.data("cardData").length; i++) {
				const cardNum = Math.floor(Math.random() * tempCards.length);
				cards.push(tempCards[cardNum]);
				tempCards.splice(cardNum, 1);
			}
			
			for (i=0; i<cards.length; i++) {
				// create top of cards
				$('<div class="card"></div>')
					.css("background-image", 'url("' + cardbackurl + '")')
					.attr("tabindex", "0")
					.appendTo($cardTopHolder)
					.click(function() {
						const $this = $(this);
						if ($pageContents.data("currentCard") == "") { // 1st card revealed
							$pageContents.data("currentCard", $this);
							$cardTopHolder.find(".card:not('.correct')").animate({opacity: 1}, 250); // can't use fadeIn/Out() because it stops it displaying as block
							clearInterval(x_timer);
							$this.animate({opacity: 0}, 500);
							
						} else { // 2nd card revealed - does it match?
							if ($this.is($pageContents.data("currentCard")) == false) {
								$this.animate({opacity: 0}, 500);
								const $card1B = $($cardBottomHolder.children()[$this.index()]);
								const $card2B = $($cardBottomHolder.children()[$pageContents.data("currentCard").index()]);
								const $card1T = $this;
								const $card2T = $pageContents.data("currentCard");

								if (parseInt($card1B.data("match")) == parseInt($card2B.data("match"))) { // match - short delay and then add label to image card
									$this.add($pageContents.data("currentCard")).addClass("correct");
									
									clearInterval(x_timer);
									x_timer =  setInterval(function() {
										if ($card1B.find(".answer").length == 0) {
											$card2B.find(".answer .imgLabel").css("background-image", $card1B.css("background-image"));
											$card1B.animate({opacity: 0}, 500);
										} else {
											$card1B.find(".answer .imgLabel").css("background-image", $card2B.css("background-image"));
											$card2B.animate({opacity: 0}, 500);
										}
										$card1B.add($card2B).find(".answer").animate({opacity: 1}, 500);

										$card1T.removeAttr("tabindex");
										$card2T.removeAttr("tabindex");

										if ($pageContents.find(".correct").length == $pageContents.data("cardData").length) { // all matched
											$("#button").show();
										}
										
										clearInterval(x_timer);
									}, 500);
									
								} else { // no match
									clearInterval(x_timer);
									x_timer =  setInterval(function() {
										$cardTopHolder.find(".card:not('.correct')").animate({opacity: 1}, 250);
										clearInterval(x_timer);
									}, 1000);
								}
								$pageContents.data("currentCard", "");
							}
						}
						})
					.keypress(function(e) {
						const charCode = e.charCode || e.keyCode;
						if (charCode == 32) {
							$(this).trigger("click");
						}
						})
					.focusin(function() {
						$(this).addClass("focus");
						})
					.focusout(function() {
						$(this).removeClass("focus");
					});
				
				// create bottom of cards - with either text or image on them
				if (cards[i].type == "text") {
					$('<div class="card" >' + x_addLineBreaks(cards[i].data) + '</div>')
						.appendTo($cardBottomHolder)
						.data("match", cards[i].match);
					
				} else {
					let div = "";
					if (cards[i].ref == 1) { // when matched correctly this card will stay in place and the matching card will appear on top
						div += '<div class="answer">';
						if (cards[i].matchType == "text") {
							div += '<div class="label">' + cards[i].name + '</div>';
						} else {
							div += '<div class="imgLabel">';
							if (cards[i].name != undefined && cards[i].name != "") {
								div += '<div class="label">' + cards[i].name + '</div>';
							}
							div += '</div>';
						}
						div += '</div>';
					} else {
						if (cards[i].name != undefined && cards[i].name != "") {
							div += '<div class="label">' + cards[i].name + '</div>';
						}
					}
					
					$('<div class="card" >' + div + '</div>')
						.appendTo($cardBottomHolder)
						.css("background-image", 'url("' + x_evalURL(cards[i].data) + '")')
						.data("match", cards[i].match)
						.find(".answer").css("opacity", 0);
				}
			}
		}
	}
	
	memory.init();
	
</script>


<div id="pageContents">

	<div id="txtHolder" class="splitScreen_A"></div>

	<div id="infoHolder" class="splitScreen_B">
		<div id="panel" class="panelContent panel">
			<div id="cardHolder">
				<div id="cardTopHolder"></div>
				<div id="cardBottomHolder"></div>
			</div>
			<button id="button"></button>
		</div>
	</div>
</div>