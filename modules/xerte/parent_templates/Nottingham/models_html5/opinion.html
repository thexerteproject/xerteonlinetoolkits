<script type="text/javascript">
/**
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.

 * The Apereo Foundation licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
	
	var opinion = new function()
	{
		var $pageContents,
			printAvailable = false,
			JSONGraph;

		this.sizeChanged = function()
		{
			const $panel = $("#pageContents .qPanel");
			let resized = false;

			$panel.height(x_getAvailableHeight([$panel]));
			
			$.each($(".questionAudio"), function(key, qA) {
			    var qAudio = $("#" + qA.id);
                if (qAudio.children().length > 0)
                {
                    if (resized == false)
                    {
                        var audioBarW = 0;
                        qAudio.find(".mejs-inner").find(".mejs-controls").children().each(function() {
                            audioBarW += $(this).outerWidth();
                        });
                        if (audioBarW < qAudio.width() - 5 || audioBarW > qAudio.width() + 5)
                        {
                            resized = true;
                            $x_window.resize();
                        }
                    }
                }
			});

			var audioHolder = $("#pageContents .audioHolder");

			if (audioHolder.length > 0)
			{
				if (resized == false)
				{
					var audioBarW = 0;
					$("#pageContents .audioHolder:eq(0) .mejs-inner .mejs-controls").children().each(function() {
						audioBarW += $(this).outerWidth();
					});

					if (audioBarW - audioHolder.parents("#mainPanel").width() < -2 || audioBarW - audioHolder.parents("#mainPanel").width() > 2)
					{
						resized = true;
						$x_window.resize();
					}
				}
			}
			
			var width = $("#mainPanel").width(),
					height = $("#pageContents").innerHeight() - $("#qNo").outerHeight(true) - $("#feedback").outerHeight(true) - $("#buttonHolder").outerHeight(true),
					textSize;
			let paddingHeightMainPanel = $("#mainPanel").outerHeight(true) - $("#mainPanel").innerHeight() + parseFloat($("#mainPanel").css('padding-top')) + parseFloat($("#mainPanel").css('padding-bottom'));
			let paddingWidthMainPanel = $("#mainPanel").outerWidth(true) - $("#mainPanel").innerWidth() + parseFloat($("#mainPanel").css('padding-left')) + parseFloat($("#mainPanel").css('padding-right'));
			width -= paddingWidthMainPanel;
			height -= paddingHeightMainPanel;
			height *= 0.98; // Build in some extra space
			if(width > height) {
				textSize = (width - height) / 10;
			}
			else {
				textSize = (height - width) / 10;
				height = width;
			}
			if (textSize > 20) {
				textSize = 20;
			}
			else if (textSize < 12) {
				textSize = 12;
			}
			$pageContents.data('textSize', textSize);

			$("#canvas-container")
					.css('width', width)
					.css('height', height);

			$("#qHolder .qImg").each(function() {
				$(this).css({
					"max-width": $("#mainPanel").width() - 10,
					"max-height": $("#mainPanel").height() - ($(this).parents("figure").find("figcaption").outerHeight(true) - $(this).parents("figure").find("figcaption").height())
				});
			});
		};

		this.loadAudio = function(currentQuestion, soundFile, transcript)
		{
			if (soundFile != undefined && soundFile != "")
			{
				$("#questionAudio" + currentQuestion).mediaPlayer({
					type	:"audio",
					source	:soundFile,
					width	:"100%"
				});

				// manually add a transcript button to the end of the audio bar
				if (transcript != undefined && transcript != '') {
					x_addAudioTranscript($("#questionAudio" + currentQuestion), transcript);
				}
			}
		};

		this.startQuestions = function()
		{
			// If the language attribute is not defined in the xml, fall back to English.
			var questionNumberText = x_currentPageXML.getAttribute("quesCount");
			if (questionNumberText == undefined)
			{
				questionNumberText = "Question {i} of {n}";
			}
			$pageContents.data({
				'resultShown': false,
				'qNumTxt': questionNumberText
			});

			var feedback = '';
			if (x_currentPageXML.getAttribute("feedback") != undefined)
			{
				feedback = x_currentPageXML.getAttribute("feedback");
			}
            var showfeedback = feedback !== '';
            if (x_currentPageXML.getAttribute("showfeedback") != undefined)
            {
                showfeedback = x_currentPageXML.getAttribute("showfeedback") == "true";
            }
			$pageContents.data('feedback', feedback);
			$pageContents.data('showfeedback', showfeedback);

			$("#canvas-container").hide();
            $("#qHolder").show();
			$("#checkBtn")
				.show()
				.button("disable");

			$pageContents.data('currentQuestion', 0);
			var questions = []; // array of questions to use (index)
			
			var numberOfQuestions = $(x_currentPageXML).children().children('opinionQuestion').length; // Can't be 0

            for(var i = 0; i < $(x_currentPageXML).children().length; i++)
            {
                $(x_currentPageXML).children()[i].classId = i;
            }

			if (x_currentPageXML.getAttribute("order") == "random")
			{
				var questionNumbers = [];

				for (var i = 0; i < numberOfQuestions; i++)
				{
					questionNumbers.push(i);
				}

				for (var i = 0; i < numberOfQuestions; i++)
				{
					var questionNumber = Math.floor(Math.random() * questionNumbers.length);
					questions.push(questionNumbers[questionNumber]);
					questionNumbers.splice(questionNumber, 1);
				}
			}
			else
			{
				for (var i = 0; i < numberOfQuestions; i++)
				{
					questions.push(i);
				}
			}
			
			$pageContents.data('questions', questions);

			var weighting =  x_currentPageXML.getAttribute("trackingWeight") != undefined ? x_currentPageXML.getAttribute("trackingWeight") : 1.0;

            XTSetPageType(x_currentPage, 'numeric', numberOfQuestions, weighting);

			this.loadQuestions();

            x_pageContentsUpdated();
		};

		this.loadQuestions = function()
		{
            $("#checkBtn").button("disable");
			
            $pageContents.data('radioButtonQuestions', []);
			
			var listMode = $pageContents.data('listMode'),
				pageMode = $pageContents.data('pageMode'),
				pageSize = $pageContents.data('pageSize'),
				currentQuestion = $pageContents.data('currentQuestion'),
				questions = $pageContents.data('questions');

		    if (listMode || listMode == 'all')
			{
			    if (pageMode || (pageMode == undefined && listMode == true))
				{
					// list in pages
                    $("#qNo").html($pageContents.data('qNumTxt').replace("{i}", (currentQuestion + 1) + " - " + (Math.min(currentQuestion + pageSize, questions.length))).replace("{n}", questions.length));
                    $("#qHolder").html("");
				    for (i=currentQuestion; i<Math.min(currentQuestion + pageSize, questions.length); i++)
					{
						this.addQuestion(i);
					}
				}
				else
				{
					// all on one page
                    $("#qNo").html("");
                    $("#qHolder").html("");
                    for (i=currentQuestion; i<questions.length; i++)
                    {
						this.addQuestion(i);
                    }
				}
			}
			else
			{
				// one question per page
                $("#qNo").html($pageContents.data('qNumTxt').replace("{i}", currentQuestion + 1).replace("{n}", questions.length));
				$("#qHolder").html("");
			    this.addQuestion(currentQuestion);
			}
			
			this.checkButtonState();
		};

		this.addQuestion = function(q) {
			$("#qHolder").append('<fieldset class="noStyle"><legend id="qTxt' + q + '" class="qTxt"></legend><div id="questionAudio'+ q + '" class="questionAudio"></div><div id="sliderHolder' + q
					+ '" class="sliderHolder"><div id="labelHolder' + q + '" class="labelHolder"></div><div id="rangeHolder' + q + '" class="rangeHolder"></div></div><div class="qSeparator"><hr></div></fieldset>');
			this.loadQuestion(q);
		}

		this.checkButtonState = function()
		{
		    var checked = true;
		    $.each($pageContents.data('radioButtonQuestions'), function(key, value){
		    	if (value == false) {
                    checked = false;
                }
			});
		    if (checked)
			{
                $("#checkBtn").button("enable");
			}
			const currQ = $pageContents.data('currentQuestion');
			if (currQ == 0)
			{
				$("#backBtn").button("disable");
			}
			else
			{
				$("#backBtn").button("enable");
			}
		};

		this.loadQuestion = function(currentQuestion)
		{
			var questions = $pageContents.data('questions');
			
			if ($(x_currentPageXML).children().length == 0)
			{
				$("#optionHolder").html('<span class="alert">' + x_getLangInfo(x_languageData.find("errorQuestions")[0], "noQ", "No questions have been added") + '</span>');
			}
			else
			{
				var $thisQ = $(x_currentPageXML).children().children('opinionQuestion')[questions[currentQuestion]];
				let classQ = $($thisQ).parent();
				var infoString = $thisQ.getAttribute("prompt");

				if ($thisQ.getAttribute("sound") != undefined && $thisQ.getAttribute("sound") != "") {
					this.loadAudio(currentQuestion, $thisQ.getAttribute("sound"), $thisQ.getAttribute('soundTranscript'));
				}
				else
				{
					$("#questionAudio" + currentQuestion).empty();
				}

				var url = $thisQ.getAttribute("image");

				if (url != undefined && url != "") {
					var newString = "";
					if ($thisQ.getAttribute("caption") != undefined && $thisQ.getAttribute("caption") != "") {
						newString += '<figure>';
					}
					newString += '<img class="qImg" src="' + x_evalURL(url) + '" class="opinionImg"';
					if ($thisQ.getAttribute("tip") != undefined && $thisQ.getAttribute("tip") != "")
					{
						newString += 'alt="' + $thisQ.getAttribute("tip") + '"';
					}
					newString += ' />';
					if ($thisQ.getAttribute("caption") != undefined && $thisQ.getAttribute("caption") != "") {
						newString += '<figcaption>' + $thisQ.getAttribute("caption") + '</figcaption></figure>';
					}
					infoString = newString + infoString;
				}

				$("#qTxt" + currentQuestion).html(x_addLineBreaks(infoString));

				$("#feedback").html("");

				if ($($thisQ).children().length == 0)
				{
					$("#sliderHolder" + currentQuestion).html('<span class="alert">' + x_getLangInfo(x_languageData.find("errorQuestions")[0], "noA", "No answer options have been added") + '</span>');
				}
				else
				{
					var correctOptions = [],
						correctAnswer = [],
						name;
					
                    if($thisQ.getAttribute("interactivity") == "radio-buttons") {
                        var $optionHolder = $("#sliderHolder" + currentQuestion);
                        $optionHolder.html('<div class="optionGroup"><input type="radio" name="option' + currentQuestion + '" /><label class="optionTxt"></label></div>');

                        var $optionGroup = $optionHolder.find(".optionGroup");

						var radioButtonQuestions = $pageContents.data('radioButtonQuestions');
						radioButtonQuestions[currentQuestion] = false;
						$pageContents.data('radioButtonQuestions', radioButtonQuestions);
						
                        var currentAnswers = [];
                        $($thisQ).children().each(function () {
                            currentAnswers.push(
                                {
                                    text: this.getAttribute("text"),
                                    correct: this.getAttribute("correct")
                                }
                            );
                        });

						let answers = $pageContents.data('answeredValues');
						let selected = -1;
						if (answers[currentQuestion] !== undefined)
						{
							selected = (currentAnswers.length-1) * answers[currentQuestion]/100;
						}

						$.each(currentAnswers, function (index, value) {
                            var $thisOptionGroup, $thisOption, $thisOptionTxt;

                            if (index != 0) {
                                $thisOptionGroup = $optionGroup.clone().appendTo($optionHolder);
                            }
                            else {
                                $thisOptionGroup = $optionGroup;
                            }

                            $thisOption = $thisOptionGroup.find("input");
                            $thisOptionTxt = $thisOptionGroup.find(".optionTxt");

                            correctOptions.push((index + 1) + "");
                            correctAnswer.push(value.text);

                            $thisOption
                                .attr({
                                    "value": value.text,
                                    "id": "option" + currentQuestion + "_" + index
                                })
                                .change(function () {
									var radioButtonQuestions = $pageContents.data('radioButtonQuestions');
									radioButtonQuestions[currentQuestion] = true;
									$pageContents.data('radioButtonQuestions', radioButtonQuestions);
                                    opinion.checkButtonState();
                                });
                            $thisOption[0].score = index;

                            $thisOptionTxt
                                .attr("for", "option" + currentQuestion + "_" + index)
                                .data("option", $thisOption)
                                .html(x_addLineBreaks(value.text));
                        });

						if (selected != -1)
						{
							let $thisOptions = $optionHolder.find("input");
							$($thisOptions[selected]).prop('checked', true);
							radioButtonQuestions[currentQuestion] = true;
							$pageContents.data('radioButtonQuestions', radioButtonQuestions);
						}

                        name = x_GetTrackingTextFromHTML($thisQ.getAttribute("prompt"), "");

                        if ($thisQ.getAttribute("name")) {
                            name = $thisQ.getAttribute("name");
                        }
                    }
                    else if($thisQ.getAttribute("interactivity") == null || $thisQ.getAttribute("interactivity") == "slider")
					{
                        var $sliderHolder = $("#sliderHolder" + currentQuestion);
						$sliderHolder.html('<div id="labelHolder' + currentQuestion + '" class="labelHolder"><table class="none"><tr id="labelHolderRow' + currentQuestion + '"></tr></table></div><div id="rangeHolder' + currentQuestion + '"></div>');
						var $labelHolder = $("#labelHolderRow" + currentQuestion),
                            $rangeHolder = $("#rangeHolder" + currentQuestion);

						$labelHolder.html('<td class="labelCell"><a href="#" onclick="" class="optionTxt"></a></td>');
                        var $optionTxt = $labelHolder.find(".optionTxt"),
                            $optionCell = $labelHolder.find(".labelCell");

                        var max = $($thisQ).children().length - 1;
                        var numberOfOptions = max + 1;

						let answers = $pageContents.data('answeredValues');
						let selected = -1;
						if (answers[currentQuestion] !== undefined)
						{
							selected = max * answers[currentQuestion]/100;
						}
						else if ($thisQ.getAttribute("defaultSliderValue") != undefined)
						{
							const defaultVal = $thisQ.getAttribute("defaultSliderValue");
							selected = max * defaultVal/100;
						}

						$rangeHolder.html('<form id="form' + currentQuestion + '"> <input id="slider' + currentQuestion + '" aria-label="slider' + currentQuestion + '" type="range" min="0" max = "' + max + '" step="1" class="slider"/> </form> ');

                        $.each($($thisQ).children(), function(index, value)
                        {
                            var $thisOptionTxt;

                            if (index != 0)
                            {
                                $thisOptionTxt = $optionCell.clone().appendTo($labelHolder);
                                $thisOptionTxt = $thisOptionTxt.find(".optionTxt");
                                $thisOptionTxt.after(" ");
                            }
                            else
                            {
                                $thisOptionTxt = $optionTxt;
                            }

                            $thisOptionTxt
                                .attr("for", "option" + index)
                                .html($(value.getAttribute("text")).length < 1 ? '<p>' + x_addLineBreaks(value.getAttribute("text")) + '</p>' : x_addLineBreaks(value.getAttribute("text")));

                            $thisOptionTxt[0].onclick = function()
                            {
                                $("#slider" + currentQuestion)[0].value = index;
                            };

                            correctOptions.push(index + 1 + "");
                            correctAnswer.push(value.getAttribute("text"));
                        });

						if (selected != -1)
						{
							$("#slider" + currentQuestion).val(selected);
						}

                        var cellWidth = 100.0/numberOfOptions;
                        $("td.labelCell").css("width", cellWidth + "%");
                        $("#slider" + currentQuestion).css("width", 100-cellWidth + 2 +"%");
                        $("#slider" + currentQuestion).css("margin-left", cellWidth/2 - 1 + "%");

						name = x_GetTrackingTextFromHTML($thisQ.getAttribute("prompt"), "");

                        if ($thisQ.getAttribute("name"))
                        {
                            name = $thisQ.getAttribute("name");
                        }
                    }
					
					XTEnterInteraction(x_currentPage, questions[currentQuestion], 'numeric', name, correctOptions, correctAnswer, null, x_currentPageXML.getAttribute("grouping"), "opinionClass=" + classQ.attr("name"));
					$pageContents.data('checked', false);
				}
			}
		};

		this.pageChanged = function()
		{
			$pageContents = $('#pageContents');
			if ($("#canvas-container").is(":visible")) {
				this.drawGraph();
			}
		};

		this.trackQuestions = function(goingBack = false)
		{
			var listMode = $pageContents.data('listMode'),
				pageMode = $pageContents.data('pageMode'),
				pageSize = $pageContents.data('pageSize'),
				currentQuestion = $pageContents.data('currentQuestion'),
				questions = $pageContents.data('questions');
			
            if (listMode || listMode == 'all')
            {
                if (pageMode || (pageMode == undefined && listMode == true))
                {
                    for (i=currentQuestion; i<Math.min(currentQuestion + pageSize, questions.length); i++)
                    {
                        this.trackQuestion(i, goingBack);
                    }
                }
                else
                {
                    for (i=currentQuestion; i<questions.length; i++)
                    {
                        this.trackQuestion(i, goingBack);
                    }
                }
            }
            else
            {
                this.trackQuestion(currentQuestion, goingBack);
            }
            if (!goingBack && $pageContents.data('resultShown') == false)
			{
			    this.loadQuestions();
			}
			else {
				$("#backBtn").button("enable");
			}
		};

		this.trackQuestion = function(currentQuestion, goingBack)
		{
			var questions = $pageContents.data('questions'),
				currentQ = $(x_currentPageXML).children().children('opinionQuestion')[questions[currentQuestion]],
				selected = 0,
            	options = $(currentQ).children();
				l_options = [],
				l_answer = [],
				currentQuestionValue = 0;

			if (currentQ.getAttribute("interactivity") == null || currentQ.getAttribute("interactivity") == "slider")
                selected = $('#slider' + currentQuestion)[0].valueAsNumber;
			else if (currentQ.getAttribute("interactivity") == "radio-buttons")
			    if ($("#sliderHolder" + currentQuestion + " input:checked")[0] != null)
                selected = $("#sliderHolder" + currentQuestion + " input:checked")[0].score;
            for (var i = 0; i < options.length; i++)
           	{
           		l_options.push(i + "");
           	}

			function calcPercentage(index, count) {
				var value;
				if (index == 0) {
					value = 0;
				} else if (index == count - 1) {
					value = 100;
				} else {
					value = index / (count - 1) * 100;
				}
				return value;
			}

        	currentQuestionValue = calcPercentage(selected, options.length);

        	if (currentQ.getAttribute("scale") == "true")
       		{
       			currentQuestionValue = 100 - currentQuestionValue;
       		}

            l_answer = Math.round(currentQuestionValue * 10.0) / 10.0;

            var currentQuestionString = currentQuestion + "";
			
			var answeredValues = $pageContents.data('answeredValues');
            answeredValues[currentQuestionString] = currentQuestionValue;
			$pageContents.data('answeredValues', answeredValues);

			var diagramLabels = $pageContents.data('diagramLabels');
            diagramLabels[currentQuestion] = currentQ;
			$pageContents.data('diagramLabels', diagramLabels);
			
			var diagramAnswers = $pageContents.data('diagramAnswers');
            diagramAnswers[currentQuestion] = (Math.round(currentQuestionValue * 10.0) / 10.0);
			$pageContents.data('diagramAnswers', diagramAnswers);

            var result = {
                success: true,
                score: Math.round(currentQuestionValue * 10.0) / 10.0
            };
			
			XTExitInteraction(x_currentPage, questions[currentQuestion], result, l_options, l_answer, null, x_currentPageXML.getAttribute("trackinglabel"));

			if (!goingBack) {
				// Continue to next question
				$pageContents.data('currentQuestion', $pageContents.data('currentQuestion') + 1);

				// If last question has been answered - show results, else continue
				if ($pageContents.data('currentQuestion') == questions.length) {
					this.trackOpinion();
					$pageContents.data('resultShown', true);
					opinion.showPrintButton();
				}
				x_pageContentsUpdated();
			}
		};

		this.trackOpinion = function() {
            // Last question answered - show results
			this.drawGraph();

			$("#qNo").html($pageContents.data("onCompletionText"));

            var myScore = 0;
			var answeredValues = $pageContents.data('answeredValues');
            for (var key in answeredValues)
            {
            	myScore += answeredValues[key];
            }
            myScore = Math.round(10 * myScore / Object.keys(answeredValues).length) / 10;

			$("#questionAudio, #feedback").empty();

			// add main feedback
            if ($pageContents.data('showfeedback') && $pageContents.data('feedback') != '') {
                $("#feedback").append("<div id='mainFb' class='fbBlock'>" + x_addLineBreaks($pageContents.data('feedback')) + '</div>');
            }

			// add relevant tailored class feedback
			if ($(x_currentPageXML).children().children('classFeedback').length > 0) {

				$(x_currentPageXML).children().each(function() {
					const thisClass = this;
					$(thisClass).children('classFeedback').each(function() {
						var thisScore;
						for (let i=0; i<JSONGraph.classnames.length; i++) {
							if (thisClass.getAttribute('name') == JSONGraph.classnames[i]) {
								thisScore = JSONGraph.classvalues[i];
							}
						}

						if ((($.isNumeric(this.getAttribute('minScore')) && thisScore >= Number(this.getAttribute('minScore'))) || !$.isNumeric(this.getAttribute('minScore'))) && (($.isNumeric(this.getAttribute('maxScore')) && thisScore <= Number(this.getAttribute('maxScore'))) || !$.isNumeric(this.getAttribute('maxScore')))) {
							$('#feedback').append('<div class="fbBlock">' + (this.getAttribute('name') != '' ? '<h3>' + this.getAttribute('name') + '</h3>' : '') + x_addLineBreaks(this.getAttribute('feedbackTxt')) + '</div>');
						}
					});
				})
			}

			if ($('#feedback .fbBlock').length == 0) {
				$('#feedback').hide();
				if (x_currentPageXML.getAttribute("diagram") !== "true")
				{
					// Show default text if no graph and no feedback
					var noFeedback = "<p>You have completed all the questions.</p>";
					if (x_currentPageXML.getAttribute("noFeedbackNoGraph") != undefined)
					{
						noFeedback = x_currentPageXML.getAttribute("noFeedbackNoGraph");
					}
					$('#feedback').html(noFeedback);
				}
			}

            $("#qHolder").hide();
            $("#checkBtn").hide();

            XTSetPageScoreJSON(x_currentPage, myScore, JSON.stringify(JSONGraph), x_currentPageXML.getAttribute("trackinglabel"));
            $pageContents.data('checked', true);
		};

		this.drawGraph = function() {
			JSONGraph = this.createGraphObject();
			if (x_currentPageXML.getAttribute("diagram") !== "true") {
				if (x_currentPageXML.getAttribute("diagram") !== "true") {
					$("#canvas-container").show();
				} else {
					$('#canvas-container').hide();
				}
				this.sizeChanged();
				this.createDiagram(JSONGraph);
			}
		}

		this.createGraphObject = function()
		{
            var classNames = [],
				classTitles = [],
				classValues = [],
				classWeighting = [];
			
			var diagramLabels = $pageContents.data('diagramLabels'),
				diagramAnswers = $pageContents.data('diagramAnswers');

            for(var i = 0; i< diagramLabels.length; i++){
                var q = diagramLabels[i];
                classNames[q.parentNode.classId] = q.parentNode.getAttribute("name");
                if (typeof q.parentNode.getAttribute("title") != "undefined" && q.parentNode.getAttribute("title") != "") {
                    classTitles[q.parentNode.classId] = q.parentNode.getAttribute("title");
                }
                else
                {
                    classTitles[q.parentNode.classId] = classNames[q.parentNode.classId];
                }
                if(classValues[q.parentNode.classId] != undefined){
                    classValues[q.parentNode.classId] = classValues[q.parentNode.classId] + (diagramAnswers[i]* diagramLabels[i].getAttribute("classWeight"));
                    classWeighting[q.parentNode.classId] = parseInt(classWeighting[q.parentNode.classId]) + parseInt(diagramLabels[i].getAttribute("classWeight"));
                }
                else{
                    classValues[q.parentNode.classId] =(diagramAnswers[i]* diagramLabels[i].getAttribute("classWeight"));
                    classWeighting[q.parentNode.classId] = diagramLabels[i].getAttribute("classWeight");
                }
            }
            for(var j=0; j<classValues.length;j++){
                classValues[j] = classValues[j] / classWeighting[j];
            }

            return {
                label: x_currentPageXML.getAttribute("name"),
                classnames: classNames,
                classtitles: classTitles,
                classvalues: classValues
            };

        };

		this.createDiagram = function(graphObject)
		{
      		var htmlToChar = function(h){return $("<div>").html(h).text();},
				classTitles = graphObject.classtitles.map(function(a){return htmlToChar(a);}),
				classValues = graphObject.classvalues;
			
			var bgColourIn = "0x000000";
			if (x_currentPageXML.getAttribute("colour") != null) {
				bgColourIn = x_currentPageXML.getAttribute("colour");
			}
			var bgColour = x_hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 0.5);
			var lnColour = x_hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 1);
			var ctx = $("#diagram");

			let txtColour = $("body").css("color");
			let lineColour = $("body").css("color");
			lineColour = lineColour.indexOf('rgba') === -1 ? lineColour.replace(')', ', 0.2)').replace('rgb', 'rgba') : lineColour;

			var myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: classTitles,
                    datasets: [{
						label: htmlToChar(x_currentPageXML.getAttribute("name")),
                        data: classValues,
						backgroundColor: bgColour,
						borderColor: lnColour
                    }]
                },
				options: {
				  layout: {
					  padding: {
						  left: 10,
						  right: 10,
						  top: 10,
						  bottom: 10
						}
					},
					scale: {
						ticks: {
							suggestedMin: 0,
							suggestedMax: 100,
							fontSize: $pageContents.data('textSize') - 10
						},
						pointLabels: {
							fontSize: $pageContents.data('textSize'),
							fontColor: txtColour
						},
						gridLines: {
							color: lineColour
						},
						angleLines: {
							color: lineColour
						}
					},
					legend: {
						labels: {
							fontSize: $pageContents.data('textSize'),
							fontColor: txtColour
						},
						display: x_currentPageXML.getAttribute("key") == 'false' ? false : true,
					},
					responsive: true,
					maintainAspectRatio: false
				}
            });

			// give canvas a description including data so it's accessible
			let chartDescr = "";
			for (let i=0; i<graphObject.classtitles.length; i++) {
				chartDescr += graphObject.classtitles[i] + " = " + graphObject.classvalues[i] + "%. "
			}
			/*
			for (i = 0; i < scores.length; i++) {
				chartDescr += " " + $pageContents.data("classes")[i] + " = " + scores[i];
				if (x_currentPageXML.getAttribute("scoreType") == "relative percent" || x_currentPageXML.getAttribute("scoreType") == "individual percent") {
					chartDescr += "%";
				}
				if (i != scores.length - 1) {
					chartDescr += ",";
				}
			}*/
			$("#diagram").attr("title", chartDescr);
			console.log(graphObject);
		};

		this.init = function()
		{
			$("#printBtn").hide();

			$pageContents = $('#pageContents');
			
			$pageContents.data({
				'listMode': false,
				'pageMode': true,
				'pageSize': 10,
				'answeredValues': {},
				'diagramLabels': [],
				'diagramAnswers': []
			});
			
            if (x_currentPageXML.getAttribute("list") != undefined) {
			    $pageContents.data('listMode', x_currentPageXML.getAttribute("list") === "true" ? true : x_currentPageXML.getAttribute("list") === "all" ? "all" : false);
			}

            if (x_currentPageXML.getAttribute("paging") != undefined) {
                $pageContents.data('pageMode', x_currentPageXML.getAttribute("paging") === "true");
            }
            else {
				if ($pageContents.data('listMode') === 'all') {
					$pageContents.data('pageMode', false);
				} else {
					$pageContents.data('pageMode', true);
				}
			}

            if ($pageContents.data('listMode') && x_currentPageXML.getAttribute("pagesize") != undefined) {
                $pageContents.data('pageSize', parseInt(x_currentPageXML.getAttribute("pagesize")));
				if ($pageContents.data('listMode') === 'all') {
					// Set page size to number of items
					const numberOfQuestions = $(x_currentPageXML).children().children('opinionQuestion').length; // Can't be 0
					$pageContents.data('pageSize', numberOfQuestions);
				}
            }
			else {
				$pageContents.data('pageSize', 1);
			}

            var panelWidth = x_currentPageXML.getAttribute("panelWidth"),
				$splitScreen = $("#pageContents .splitScreen"),
				$textHolder = $("#textHolder");

			if (panelWidth == "Full")
			{
				$("#infoHolder .panel").appendTo($pageContents);
				$splitScreen.remove();
			}
			else
			{
				$textHolder.html(x_addLineBreaks(x_currentPageXML.getAttribute("instructions")));
				var textAlign = x_currentPageXML.getAttribute("align");

				if (textAlign != "right")
				{
					if (panelWidth == "Small")
					{
						$splitScreen.addClass("large");
					}
					else if (panelWidth == "Large")
					{
						$splitScreen.addClass("small");
					}
					else
					{
						$splitScreen.addClass("medium");
					}
				}
				else
				{
					$textHolder
						.removeClass("left")
						.addClass("right")
						.appendTo($splitScreen);
					$("#infoHolder")
						.removeClass("right")
						.addClass("left");
					if (panelWidth == "Small")
					{
						$splitScreen.addClass("medium");
					}
					else if (panelWidth == "Large")
					{
						$splitScreen.addClass("xlarge");
					}
					else
					{
						$splitScreen.addClass("large");
					}
				}
			}

			if (panelWidth != "Full" && x_currentPageXML.getAttribute("img") != undefined && x_currentPageXML.getAttribute("img") != "") {
				var newString = '';
				if (x_currentPageXML.getAttribute("caption") != undefined && x_currentPageXML.getAttribute("caption") != "") {
					newString += '<figure>';
				}
				newString += '<img class="opinionImg" src="' + x_evalURL(x_currentPageXML.getAttribute("img")) + '" ';
				if (x_currentPageXML.getAttribute("tip") != undefined && x_currentPageXML.getAttribute("tip") != "")
				{
					newString += 'alt="' + x_currentPageXML.getAttribute("tip") + '"';
				}
				newString += ' />';
				if (x_currentPageXML.getAttribute("caption") != undefined && x_currentPageXML.getAttribute("caption") != "") {
					newString += '<figcaption>' + x_currentPageXML.getAttribute("caption") + '</figcaption><figure>';
				}
				$textHolder.append(newString);
			}

			var backBtnText = x_currentPageXML.getAttribute("backBtnText");
			if (backBtnText == undefined)
			{
				backBtnText = "Back";
			}

			var submitBtnText = x_currentPageXML.getAttribute("submitBtnText");
			if (submitBtnText == undefined)
			{
				submitBtnText = "Submit";
			}
			var resetBtnText = x_currentPageXML.getAttribute("resetBtnText");
			if (resetBtnText == undefined)
			{
				resetBtnText = "Reset";
			}

			var onCompletionText = x_currentPageXML.getAttribute("onCompletion");
			if (onCompletionText == undefined)
			{
				onCompletionText = "You have completed the questionaire";
			}

            $pageContents.data({
				"onCompletionText"	:onCompletionText,
			});

			// BackBtn

			$("#backBtn")
				.button({
					label:backBtnText
				})
				.click(function(){
					let pageSize = $pageContents.data('pageSize');
					let currentQuestion = $pageContents.data('currentQuestion');
					if (currentQuestion >= pageSize)
					{
						$("#mainPanel").animate({ scrollTop: 0 }, "fast");
						const questions = $pageContents.data('questions');

						if (currentQuestion == questions.length) {
							opinion.showPrintButton(false);
							opinion.resetGraph();
							$("#qHolder").show();
							$("#checkBtn").show();
							$pageContents.data('resultShown', false);
						}
						else
						{
							if ($("#checkBtn").is(":enabled"))
							{
								opinion.trackQuestions(true);
							}
						}
						currentQuestion -= pageSize;
						$pageContents.data('currentQuestion', currentQuestion);
						opinion.loadQuestions();
					}
				});
            // submit button
            $("#checkBtn")
				.button({
					label: submitBtnText
				})
				.click(function() {
          			$("#mainPanel").animate({ scrollTop: 0 }, "fast");
					opinion.trackQuestions();
				});

			// reset button
            $("#resetBtn")
				.button({
					label: resetBtnText
				})
				.click(function() {
					if ($(x_currentPageXML).children().length > 0) {	
						$pageContents.data({
							'answeredValues': {},
							'diagramLabels': [],
							'diagramAnswers': []
						});

						opinion.showPrintButton(false);
						opinion.startQuestions();
					}
				});

			// Uses new loadjs with experimental .path() method
			loadjs.path(x_templateLocation + 'common_html5/js/');
			loadjs(['html2pdf.bundle.min.js'], {
				success: function() {
    				printAvailable = true;
				}
			});

        let startHeight;
        let startWidth;
        let panelStartWidth;
        let startPadding;
        let canvasStartHeight;
        let canvasStartWidth;
        let canvasStartPadding;
    	    $("#printBtn")
				.button({
					label: x_currentPageXML.getAttribute("downloadBtnText") == undefined ? 'Download' : x_currentPageXML.getAttribute("downloadBtnText")
				})
				.click(async function() {
					$("#pageContents").prepend("<div id='print-overlay'><img id='print-overlay-spinner' src='" + x_templateLocation + "common_html5/loading16.gif'></div>");
					$("#mainPanel").prepend(
						'<div id="print-title" style="font-size: 30px"><h1>' + x_currentPageXML.getAttribute("name") + '</h1></div>'
					);
					$("#mainPanel .panel").addClass("panel-print");
					$("#mainPanel .panel").removeClass("panel");
					startHeight = $("#mainPanel")[0].style.height;
					startWidth = $("#pageContents")[0].style.width;
					panelStartWidth = $("#mainPanel")[0].style.width;
					startPadding = $("#mainPanel")[0].style.padding;
					canvasStartHeight = $("#canvas-container")[0].style.height;
					canvasStartWidth = $("#canvas-container")[0].style.width;
					$("#mainPanel #buttonHolder").hide();
					$("#pageContents").css("width", "794px");
					//$("#mainPanel").css("width", "764px");
					$("#mainPanel").css("max-height", "794px");
					$("#canvas-container canvas").css("min-width", "540px");
					$("#canvas-container canvas").css("min-height", "270px");
					$("#canvas-container canvas").css("max-width", "764px");
					$("#canvas-container canvas").css("max-height", "764px");
					//$("#mainPanel").css("padding", "79.4px");
					/*
					$("#canvas-container").css("width", "794px");
					$("#canvas-container").css("height", "750px");
					*/
					opinion.sizeChanged();
					$("p").css("font-size", "16px");
					$("h3").css("font-size", "18px");
					setTimeout(function(){
						let opt = {
							filename: `xerte-opinion${x_currentPageXML.getAttribute("name")}.pdf`,
							html2canvas: { scale: 2 },
							jsPDF: {unit: 'in', format: 'a4', orientation: 'portrait'}
						};
						html2pdf().set(opt).from($("#mainPanel")[0]).toPdf().get('pdf').then(function (pdf) {
							$("#mainPanel .panel-print").addClass("panel");
							$("#mainPanel .panel").removeClass("panel-print");
							$("#pageContents").css("width", startWidth);
							//$("#mainPanel").css("width", panelStartWidth);
							$("#mainPanel").css("height", startHeight);
							$("#mainPanel").css("padding", startPadding);
							$("#canvas-container canvas").css("min-width", "");
							$("#canvas-container canvas").css("min-height", "");
							$("#canvas-container canvas").css("max-width", "");
							$("#canvas-container canvas").css("max-height", "");
							$("#mainPanel").css("max-height", "");

							/*
							$("#canvas-container").css("width", canvasStartWidth);
							$("#canvas-container").css("height", canvasStartHeight);
							*/
							$("#print-title").remove();
							$("#print-overlay").remove();
							$("#buttonHolder").show();
							$("p").css("font-size", "");
							$("h3").css("font-size", "");
							opinion.sizeChanged();
						}).save();
					}, 4000)
				});
	        $("#printBtn").hide();
			this.startQuestions();
			this.sizeChanged();
			x_pageLoaded();
		}

		this.showPrintButton = function (force) {
			$("#printBtn")[printAvailable && force !== false && x_currentPageXML.getAttribute('disableprinting') != 'true' && x_currentPageXML.getAttribute("diagram") !== "true" ? 'show' : 'hide']();
		}

		this.resetGraph = function () {
			// Throw away iframe
			$("#mainPanel fieldset iframe").remove();
			// Reset feedbak and diagram

			$("#feedback").remove();
			$("#canvas-container").hide();

			$("#mainPanel fieldset").prepend(
					"<div id=\"feedback\" aria-live=\"polite\"></div>\n"
			);
		}
	};

	opinion.init();
	
</script>

<div id="pageContents">

	<div class="splitScreen">

		<div id="textHolder" class="left"></div>

		<div id="infoHolder" class="right">

			<div id="mainPanel" class="panel qPanel" tabindex="0">

				<p id="qNo" aria-live="polite"></p>

				<fieldset class="noStyle">

					<div id="feedback" aria-live="polite"></div>
				  <div id="canvas-container">
					<canvas id="diagram"></canvas>
				  </div>

					<div id="wrapper">
						<div id="qHolder"></div>
						<div id="buttonHolder">
							<button id="printBtn"></button>
							<button id="resetBtn"></button>
							<button id="backBtn"></button>
							<button id="checkBtn"></button>
						</div>
					</div>

				</fieldset>

			</div>

		</div>

	</div>

</div>
